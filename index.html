<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#cc8e5d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Foam Predictor">
    <title>Polymer Foaming Process Predictor v7.5.3</title>
    <!-- 
    v7.5.1 Êõ¥Êñ∞ÊëòË¶Å (2026-02-05):
    1. Input Summary Êñ∞Â¢û wt% Ê¨Ñ‰Ωç
    2. ÂàóÂç∞ÂäüËÉΩÂä†ÂÖ•Âä†Â∑•ÂèÉÊï∏ (Ê∑∑Á∑¥„ÄÅÁôºÊ≥°Ê∫´Â∫¶/ÊôÇÈñì)
    3. Á®ãÂºèÂêçÁ®±Êõ¥Êñ∞ÁÇ∫ Polymer Foaming Process Predictor
    
    v7.5 Êõ¥Êñ∞ÊëòË¶Å (2026-02-04):
    1. AC/ZnO/Urea ÂèÉÊï∏Ê†°Ê≠£ (Âü∫Êñº ACF06 COA + Unipaste P-2 TDS)
       - AC Âü∫Ê∫ñÂàÜËß£Ê∫´Â∫¶: 203¬∞C (ACF06 È´òÊ∫´Âûã)
       - ZnO ÈôçÊ∫´ÊïàÊûúÂ§ßÂπÖÊèêÂçá (~2.3x): 1.6% ‚Üí ~55¬∞C
       - Urea ÈôçÊ∫´ÊïàÊûúÊèêÂçá (~4x): 0.4% ‚Üí ~12¬∞C
       - ÊúâÊïàÂàÜËß£Ê∫´Â∫¶ = 203 - ZnOÊïàÊûú - UreaÊïàÊûú ‚âà 136¬∞C
    2. ÁôºÊ≥°ÈöéÊÆµÂâ™ÂàáÁÜ±ÁßªÈô§ (Ê≤πÂ£ìÊ©üÁÑ°Ââ™Âàá)
    3. Êñ∞Â¢ûÊ∑∑Á∑¥ÈöéÊÆµ AC ÂæÆÈáèÂàÜËß£Ë®àÁÆó
    4. Lab Mode phr Ê®°ÂºèÊîπÈÄ≤ - Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ
       - Êñ∞Â¢û„ÄåÁ¥îÊ®πËÑÇÂü∫Ê∫ñ„Äçvs„ÄåÁ∏ΩÊ®πËÑÇÂü∫Ê∫ñ„ÄçÂàáÊèõ
       - Á∏ΩÊ®πËÑÇÂü∫Ê∫ñÔºöËá™ÂãïË®àÁÆóÊØçÁ≤íËºâÈ´îÊ®πËÑÇÔºåÂèçÁÆóÁ¥îÊ®πËÑÇËº∏ÂÖ•Èáè
       - Ëß£Ê±∫ÊØçÁ≤íËºâÈ´îÂ∞éËá¥Ê®πËÑÇÁ∏ΩÈáèË®àÁÆóÈåØË™§ÂïèÈ°å
    5. Formula Decomposition Ë°®Ê†ºÊñ∞Â¢û wt% Ê¨Ñ‰Ωç
       - ÂêåÊôÇÈ°ØÁ§∫ phr„ÄÅwt%„ÄÅWeight(g) ‰∏âÁ®ÆÂñÆ‰Ωç
       - Êñ∞Â¢û Formula Summary Ë°åÈ°ØÁ§∫Á∏ΩÈÖçÊñπ
    6. Lab Mode Ë≠¶ÂëäÂÑ™Âåñ
       - ÂèñÊ∂àÊôÇÈñì/Ê∫´Â∫¶ÁØÑÂúçË≠¶Âëä
       - ÂÉÖÂú®‰∫§ËÅØÈÅéÂ∫¶ÊàñÁôºÊ≥°ÈÅéÊøÄÊôÇÈ°ØÁ§∫Ë≠¶Âëä
    
    v7.4.2 Êõ¥Êñ∞ÊëòË¶Å (2026-01-30):
    1. Lab Mode phr Ëº∏ÂÖ•Âç≥ÊôÇÈ†êË¶ΩÂØ¶ÈöõÊàêÂàÜ phr
       - ÊØçÁ≤íËá™ÂãïÊãÜËß£È°ØÁ§∫ (AC, RedP, Br, Sb, Talc, CaCO3, Pigment)
       - ÈòªÁáÉÂäëÁ∏ΩË®àÈ°ØÁ§∫
    -->
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkVWQS9QRSBGb2FtIFF1YWxpdHkgUHJlZGljdGlvbiBTeXN0ZW0iLAogICJzaG9ydF9uYW1lIjogIkZvYW0gUHJlZGljdG9yIiwKICAiZGVzY3JpcHRpb24iOiAi5LqM5qyh55m85rOh6KO96Zqo6aKd5ris5YCS5rOo5qih5Z6LIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMxYTFhMmUiLAogICJ0aGVtZV9jb2xvciI6ICIjY2M4ZTVkIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCM2FXUjBhRDBpTWpBd0lpQm9aV2xuYUhROUlqSXdNQ0lnZG1sbGQwSnZlRDBpTUNBd0lESXdNQ0F5TURBaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BHTnBjbU5zWlNCamVEMGlNVEF3SWlCamVUMGlNVEF3SWlCeVBTSTBNQ0lnWm1sc2JEMGlJMk5qT0dVMVpDSXZQand2YzNablBnPT0iLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3N2Zyt4bWwiCiAgICB9LAogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU5URXlJaUJvWldsbmFIUTlJalV4TWlJZ2RtbGxkMEp2ZUQwaU1DQXdJRFV4TWlBMU1USWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQR05wY21Oc1pTQmplRDBpTWpVMklpQmplVDBpTWpVMklpQnlQU0l4TURBZ0lpQm1hV3hzUFNJalkyTTRaVFZrSWk4K1BDOXpkbWMrIiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfQogIF0KfQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* ÁôªÂÖ•Áï´Èù¢ */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            overflow: hidden;  /* v7.5.1: ÂèñÊ∂àÊç≤Âãï */
        }
        
        .login-overlay.hidden {
            display: none;
        }
        
        .login-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid rgba(204, 142, 93, 0.3);
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            text-align: center;
            max-width: 400px;
            width: 90%;
            backdrop-filter: blur(10px);
            position: relative;  /* v7.5.1: ËÆìÂ∞èÁáàÊ≥°Áõ∏Â∞çÂÆö‰Ωç */
        }
        
        .login-box h2 {
            color: #cc8e5d;
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        
        .login-box p {
            color: #e0e0e0;
            margin-bottom: 30px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(204, 142, 93, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.08);
            color: white;
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            letter-spacing: 3px;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #cc8e5d;
            box-shadow: 0 0 0 3px rgba(204, 142, 93, 0.2);
        }
        
        .login-button {
            width: 100%;
            background: linear-gradient(135deg, #cc8e5d 0%, #d4a574 100%);
            color: #1a1a2e;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(204, 142, 93, 0.4);
            transition: all 0.3s;
        }
        
        .login-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(204, 142, 93, 0.6);
        }
        
        .error-message {
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 14px;
            font-weight: 600;
            display: none;
        }
        
        .error-message.show {
            display: block;
            animation: shake 0.5s;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        /* v7.5.1: Â∞èÁáàÊ≥°ÊèêÁ§∫ - Âõ∫ÂÆöÂú®È†ÅÈù¢Â∑¶‰∏ãËßí */
        .hint-bulb {
            position: fixed;
            bottom: 20px;
            left: 20px;
            font-size: 24px;
            cursor: help;
            opacity: 0.5;
            transition: all 0.3s;
            z-index: 1000;
        }
        
        .hint-bulb:hover {
            opacity: 1;
            transform: scale(1.2);
        }
        
        .hint-bulb::after {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 0;
            background: rgba(30, 30, 40, 0.95);
            color: #ddd;
            padding: 12px 15px;
            border-radius: 8px;
            font-size: 12px;
            width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            pointer-events: none;
            line-height: 1.6;
            border: 1px solid rgba(100,100,100,0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        
        .hint-bulb:hover::after {
            opacity: 1;
            visibility: visible;
            bottom: calc(100% + 10px);
        }
        
        .logout-button {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            z-index: 998;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
            display: none;
        }
        
        .logout-button.show {
            display: block;
        }
        
        /* v7.5.1: Ë®≠ÂÆöÊåâÈàï */
        .settings-button {
            position: fixed;
            top: 10px;
            left: 85px;
            background: rgba(100, 100, 120, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            z-index: 998;
            box-shadow: 0 4px 12px rgba(100, 100, 120, 0.4);
            display: none;
        }
        
        .logout-button.show + .settings-button,
        .settings-button.show {
            display: block;
        }
        
        /* v7.5.1: Ë®≠ÂÆöÂ∞çË©±Ê°Ü */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .settings-modal.show {
            display: flex;
        }
        
        .settings-box {
            background: #2a2a35;
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(100, 100, 120, 0.3);
            max-width: 350px;
            width: 90%;
        }
        
        .settings-box h3 {
            color: #cc8e5d;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .settings-section {
            margin-bottom: 20px;
        }
        
        .settings-section label {
            display: block;
            color: #aaa;
            font-size: 12px;
            margin-bottom: 10px;
        }
        
        .settings-section input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background: #1a1a25;
            border: 1px solid #444;
            border-radius: 8px;
            color: #ddd;
            font-size: 14px;
        }
        
        .settings-section button {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #5a7a6a, #3a5a4a);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-weight: 600;
        }
        
        .settings-message {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 12px;
            text-align: center;
            display: none;
        }
        
        .settings-message.success {
            display: block;
            background: rgba(67, 233, 123, 0.2);
            color: #43e97b;
        }
        
        .settings-message.error {
            display: block;
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        
        .close-settings {
            width: 100%;
            padding: 10px;
            background: #444;
            border: none;
            border-radius: 8px;
            color: #aaa;
            cursor: pointer;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: #1a1a2e;
            padding: 10px;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .pwa-install-banner {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #cc8e5d 0%, #d4a574 100%);
            color: #1a1a2e;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(204, 142, 93, 0.5);
            z-index: 1000;
            display: none;
            animation: slideUp 0.5s;
            max-width: 90%;
            text-align: center;
        }
        
        @keyframes slideUp {
            from { transform: translate(-50%, 100px); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .pwa-install-banner button {
            background: #1a1a2e;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 6px;
            margin: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .offline-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ff6b6b;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 999;
            display: none;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
        }
        
        .offline-indicator.online {
            background: #43e97b;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0,0,0,0.5);
            overflow: hidden;
            border: 1px solid rgba(204, 142, 93, 0.2);
        }
        
        .header {
            background: linear-gradient(135deg, #cc8e5d 0%, #d4a574 100%);
            color: #1a1a2e;
            padding: 25px;
            text-align: center;
            position: relative;
        }
        
        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .header p {
            opacity: 0.85;
            font-size: 12px;
        }
        
        .pwa-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #43e97b;
            color: #1a1a2e;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: 700;
        }
        
        .content {
            padding: 20px;
            background: rgba(26, 26, 46, 0.6);
        }
        
        .input-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(204, 142, 93, 0.2);
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 700;
            color: #cc8e5d;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(204, 142, 93, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .input-group label {
            font-size: 11px;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 6px;
            display: block;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid rgba(204, 142, 93, 0.3);
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.08);
            color: #ffffff;
        }
        
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #8a7a6a;
            box-shadow: 0 0 0 3px rgba(100, 90, 80, 0.2);
        }
        
        .calc-button {
            background: linear-gradient(135deg, #5a6a5a 0%, #4a5a4a 100%);
            color: #ddd;
            padding: 14px 35px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }
        
        .calc-button:hover {
            background: linear-gradient(135deg, #6a7a6a 0%, #5a6a5a 100%);
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }
        
        .result-card {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(100, 100, 100, 0.2);
        }
        
        .result-card.highlight {
            background: linear-gradient(135deg, #5a6a5a 0%, #4a5a4a 100%);
            color: #ddd;
        }
        
        .result-label {
            font-size: 10px;
            font-weight: 600;
            opacity: 0.8;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        .result-value {
            font-size: 22px;
            font-weight: 700;
        }
        
        .result-unit {
            font-size: 12px;
            opacity: 0.7;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            font-size: 12px;
        }
        
        th {
            background: linear-gradient(135deg, #cc8e5d 0%, #d4a574 100%);
            color: #1a1a2e;
            padding: 10px;
            text-align: left;
            font-weight: 700;
            font-size: 11px;
        }
        
        td {
            padding: 8px 10px;
            border-bottom: 1px solid rgba(204, 142, 93, 0.1);
            color: #e0e0e0;
        }
        
        .info-box {
            background: rgba(204, 142, 93, 0.15);
            border-left: 4px solid #cc8e5d;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 12px;
        }
        
        /* Êñ∞Â¢û: ÂàÜÈ°ûÊåáÊ®ôÂç°ÁâáÊ®£Âºè */
        .category-section {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            border-left: 4px solid;
        }
        
        .category-section.filler {
            border-left-color: #4facfe;
        }
        
        .category-section.flame-retardant {
            border-left-color: #ff6b6b;
        }
        
        .category-title {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .category-section.filler .category-title {
            color: #4facfe;
        }
        
        .category-section.flame-retardant .category-title {
            color: #ff6b6b;
        }
        
        /* ÊúÄ‰Ω≥Êõ≤Á∑öÂúñË°®Ê®£Âºè */
        .optimal-curve {
            margin-top: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }
        
        .curve-bar {
            height: 20px;
            border-radius: 10px;
            position: relative;
            margin: 5px 0;
        }
        
        .curve-indicator {
            position: absolute;
            width: 4px;
            height: 28px;
            background: white;
            top: -4px;
            border-radius: 2px;
            box-shadow: 0 0 8px rgba(255,255,255,0.8);
        }
        
        .curve-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: #999;
            margin-top: 5px;
        }
        
        @media (max-width: 768px) {
            body { padding: 5px; }
            .header h1 { font-size: 20px; }
            .input-grid { grid-template-columns: 1fr; }
            .results-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <!-- ÁôªÂÖ•Áï´Èù¢ -->
    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <h2>System Access</h2>
            <p>Polymer Foaming Process Predictor v7.5.3</p>
            
            <input 
                type="password" 
                id="passwordInput" 
                class="password-input" 
                placeholder="Enter password"
                onkeypress="if(event.key==='Enter') checkPassword()"
                autocomplete="off"
            >
            
            <button class="login-button" onclick="checkPassword()">
                UNLOCK SYSTEM
            </button>
            
            <div id="errorMessage" class="error-message">
                Password incorrect. Please try again.
            </div>
            
            <div id="resetLink" style="margin-top:12px; display:none;">
                <button onclick="resetPassword()" style="background:none; border:none; color:#FF9500; font-size:12px; cursor:pointer; text-decoration:underline; padding:4px;">
                    Reset to default password
                </button>
            </div>
        </div>
        
        <div id="hintBulb" class="hint-bulb" title="Default password: foam2026">
            i
        </div>
    </div>
    
    <!-- ÁôªÂá∫ÊåâÈàï -->
    <button id="logoutButton" class="logout-button" onclick="logout()">
        Logout
    </button>
    
    <!-- v7.5.1: Ë®≠ÂÆöÊåâÈàï -->
    <button id="settingsButton" class="settings-button" onclick="openSettings()">
        ‚öôÔ∏è
    </button>
    
    <!-- v7.5.1: Ë®≠ÂÆöÂ∞çË©±Ê°Ü -->
    <div id="settingsModal" class="settings-modal">
        <div class="settings-box">
            <h3>Settings</h3>
            <div class="settings-section">
                <label>Change Password</label>
                <input type="password" id="currentPassword" placeholder="Current password">
                <input type="password" id="newPassword" placeholder="New password">
                <input type="password" id="confirmPassword" placeholder="Confirm new password">
                <button onclick="changePassword()">Update Password</button>
            </div>
            <div id="settingsMessage" class="settings-message"></div>
            <button class="close-settings" onclick="closeSettings()">Close</button>
        </div>
    </div>
    
    <!-- Èõ¢Á∑öÁãÄÊÖãÊåáÁ§∫Âô® -->
    <div id="offlineIndicator" class="offline-indicator">
        Offline Mode
    </div>
    
    <!-- PWA ÂÆâË£ùÊèêÁ§∫ -->
    <div id="installBanner" class="pwa-install-banner">
        <strong>Install this application</strong><br>
        <small>Use offline like a native app</small><br>
        <button onclick="installPWA()">Install</button>
        <button onclick="dismissInstall()">Later</button>
    </div>

    <div class="container">
        <div class="header">
            <span class="pwa-badge" id="pwaBadge">WEB</span>
            <h1>Polymer Foaming Process Predictor</h1>
            <p>Advanced Formulation Analysis & Process Optimization System v7.5.3</p>
        </div>
        
        <div class="content">
            <!-- v7.3.6: Ê®°ÂºèÂàáÊèõ -->
            <div style="display: flex; gap: 0; margin-bottom: 15px; border-radius: 8px; overflow: hidden; border: 1px solid #444;">
                <button id="btnProductionMode" onclick="switchMode('production')" 
                        style="flex: 1; padding: 12px 20px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.3s;
                               background: linear-gradient(135deg, #5a7a6a, #3a5a4a); color: white;">
                    Production Mode
                </button>
                <button id="btnLabMode" onclick="switchMode('lab')" 
                        style="flex: 1; padding: 12px 20px; border: none; cursor: pointer; font-weight: 700; font-size: 14px; transition: all 0.3s;
                               background: #2a2a35; color: #888;">
                    Lab Mode
                </button>
            </div>
            
            <div class="info-box">
                <strong>v7.5.3:</strong> UX ÂÑ™Âåñ ‚Äî History Áõ¥Êé•ËºâÂÖ•„ÄÅToast ÈÄöÁü•„ÄÅÂØÜÁ¢ºÈáçÁΩÆÊ©üÂà∂„ÄÅGitHub Pages Áõ∏ÂÆπÊÄß‰øÆÊ≠£„ÄÇ
            </div>
            
            <div class="info-box" style="opacity: 0.7; font-size: 10px;">
                <strong>v7.5.2:</strong> Production Mode Formula Decomposition ÈáçÈáèÂñÆ‰ΩçÊîπÁÇ∫ kg„ÄÇ
            </div>
            
            <!-- v7.4: Lab Mode phr/weight ÂñÆ‰ΩçÂàáÊèõ -->
            <div id="labUnitToggle" class="input-section" style="display: none; background: rgba(106, 90, 122, 0.15); border-color: #6a5a7a;">
                <div class="section-title" style="color: #a9a;">Lab Input Mode</div>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 0; border-radius: 6px; overflow: hidden; border: 1px solid #555;">
                        <button id="btnWeightMode" onclick="switchLabUnit('weight')" 
                                style="padding: 8px 16px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s;
                                       background: linear-gradient(135deg, #6a5a7a, #4a3a5a); color: white;">
                            Weight (g)
                        </button>
                        <button id="btnPhrMode" onclick="switchLabUnit('phr')" 
                                style="padding: 8px 16px; border: none; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s;
                                       background: #2a2a35; color: #888;">
                            phr
                        </button>
                    </div>
                    <div id="totalResinInput" style="display: none; align-items: center; gap: 8px; flex-wrap: wrap;">
                        <div style="display: flex; align-items: center; gap: 6px;">
                            <label style="color: #a9a; font-size: 12px; white-space: nowrap;">ÁõÆÊ®ôÁ∏ΩÊ®πËÑÇ =</label>
                            <input type="number" id="totalResinWeight" value="200" step="10" min="10" max="1000" 
                                   style="width: 80px; padding: 6px 8px; background: #2a2a35; border: 1px solid #555; border-radius: 4px; color: #ddd; font-size: 12px;"
                                   oninput="updatePhrResinCalc()">
                            <span style="color: #888; font-size: 12px;">g (= 100 phr)</span>
                        </div>
                        <div style="display: flex; gap: 0; border-radius: 4px; overflow: hidden; border: 1px solid #444; margin-left: 10px;">
                            <button id="btnPhrPure" onclick="switchPhrBasis('pure')" 
                                    style="padding: 5px 10px; border: none; cursor: pointer; font-size: 10px; transition: all 0.3s;
                                           background: #2a2a35; color: #888;">
                                Á¥îÊ®πËÑÇÂü∫Ê∫ñ
                            </button>
                            <button id="btnPhrTotal" onclick="switchPhrBasis('total')" 
                                    style="padding: 5px 10px; border: none; cursor: pointer; font-size: 10px; transition: all 0.3s;
                                           background: linear-gradient(135deg, #5a7a6a, #3a5a4a); color: white;">
                                Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ
                            </button>
                        </div>
                    </div>
                </div>
                <div id="phrNote" style="display: none; color: #9a9; font-size: 11px; margin-top: 8px;">
                    üí° <span id="phrNoteText">Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ: Ëº∏ÂÖ•Ê®πËÑÇÊØî‰æã (Ëá™ÂãïÊ≠∏‰∏ÄÂåñËá≥100)ÔºåÊØçÁ≤íËºâÈ´îÊúÉËá™ÂãïÂæûÁ¥îÊ®πËÑÇÊâ£Èô§</span>
                </div>
                <div id="phrResinCalcPanel" style="display: none; margin-top: 10px; padding: 10px; background: rgba(80,120,100,0.15); border-radius: 8px; border: 1px solid rgba(80,120,100,0.3);">
                    <div style="font-size: 11px; color: #8ca; margin-bottom: 6px;">üìä Ê®πËÑÇË®àÁÆó (Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ)</div>
                    <div id="phrResinCalcContent" style="font-size: 11px; color: #bdb;"></div>
                </div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title">Product Specification</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Product Model</label>
                        <input type="text" id="productModel" placeholder="EVA-35X-001">
                    </div>
                    <div class="input-group">
                        <label>Batch ID</label>
                        <input type="text" id="batchId" placeholder="20260109-A01">
                    </div>
                    <div class="input-group">
                        <label>Date</label>
                        <input type="date" id="productionDate">
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title" id="sectionResin">Resin System (kg)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>EVA</label>
                        <input type="number" id="eva16" value="" step="0.1" oninput="updatePhrResinCalc()">
                    </div>
                    <div class="input-group">
                        <label>VA%</label>
                        <input type="number" id="eva16va" value="" step="0.1" min="5" max="50" placeholder="e.g. 16">
                    </div>
                    <div class="input-group">
                        <label>EVA</label>
                        <input type="number" id="eva25" value="" step="0.1" oninput="updatePhrResinCalc()">
                    </div>
                    <div class="input-group">
                        <label>VA%</label>
                        <input type="number" id="eva25va" value="" step="0.1" min="5" max="50" placeholder="e.g. 25">
                    </div>
                    <div class="input-group">
                        <label>LDPE MI2.4</label>
                        <input type="number" id="ldpe24" value="" step="0.1" oninput="updatePhrResinCalc()">
                    </div>
                    <div class="input-group">
                        <label>LDPE MI4.0</label>
                        <input type="number" id="ldpe40" value="" step="0.1" oninput="updatePhrResinCalc()">
                    </div>
                    <div class="input-group">
                        <label>POE</label>
                        <input type="number" id="poe" value="" step="0.1" oninput="updatePhrResinCalc()">
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title" id="sectionMasterbatch">Masterbatch (kg)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label id="labelAcpe">AC-PE</label>
                        <input type="number" id="acpe" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewAcpe" class="phr-preview" style="display:none; color:#8cf; font-size:10px;"></small>
                    </div>
                    <div class="input-group">
                        <label id="labelAceva">AC-EVA</label>
                        <input type="number" id="aceva" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewAceva" class="phr-preview" style="display:none; color:#8cf; font-size:10px;"></small>
                    </div>
                    <div class="input-group">
                        <label id="labelRedp">Á¥ÖÁ£∑MB</label>
                        <input type="number" id="redp" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewRedp" class="phr-preview" style="display:none; color:#f9a; font-size:10px;"></small>
                    </div>
                    <div class="input-group">
                        <label id="labelBrsb">Br/Sb MB</label>
                        <input type="number" id="brsb" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewBrsb" class="phr-preview" style="display:none; color:#f9a; font-size:10px;"></small>
                    </div>
                    <div class="input-group">
                        <label id="labelFiller">ÁÑ°Ê©üÂ°´ÂÖÖMB</label>
                        <input type="number" id="filler" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewFiller" class="phr-preview" style="display:none; color:#9cf; font-size:10px;"></small>
                    </div>
                    <div class="input-group">
                        <label id="labelColor">Ëâ≤ÊØç</label>
                        <input type="number" id="color" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        <small id="previewColor" class="phr-preview" style="display:none; color:#fc9; font-size:10px;"></small>
                    </div>
                </div>
                <!-- v7.4.2: phrÊ®°ÂºèÂç≥ÊôÇÈ†êË¶ΩÂçÄ -->
                <div id="phrPreviewPanel" style="display:none; margin-top:10px; padding:10px; background:rgba(80,100,120,0.2); border-radius:6px; border:1px solid #456;">
                    <div style="font-size:11px; color:#9ab; margin-bottom:6px;">üìä Actual Component phr (Âç≥ÊôÇÊèõÁÆó):</div>
                    <div id="phrPreviewContent" style="display:flex; flex-wrap:wrap; gap:8px; font-size:11px;"></div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title">Additives</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label id="labelATH">ATH (kg)</label>
                        <input type="number" id="ath" value="" step="0.1" oninput="updatePhrPreview()">
                    </div>
                    <div class="input-group">
                        <label id="labelCP70">CP-70 Chlorinated Paraffin (kg)</label>
                        <input type="number" id="cp70" value="" step="0.1" oninput="updatePhrPreview()">
                    </div>
                    <div class="input-group">
                        <label id="labelDCP">DCP (g)</label>
                        <input type="number" id="dcp" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label id="labelBHT">BHT (g)</label>
                        <input type="number" id="bht" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label id="labelZnO">ZnO (g)</label>
                        <input type="number" id="zno" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label id="labelUrea">Modified Urea (g)</label>
                        <input type="number" id="urea" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label id="labelPEG">PEG4000 (g)</label>
                        <input type="number" id="peg" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label id="labelPowder">Powder (g)</label>
                        <input type="number" id="powder" value="" step="1">
                    </div>
                </div>
                <!-- v7.5.1: Lab Mode Ê∏¨Ë©¶Áâ©Ê¨Ñ‰Ωç -->
                <div id="testMaterialSection" style="display:none; margin-top: 10px; padding: 10px; background: rgba(120,100,80,0.15); border-radius: 8px; border: 1px dashed rgba(180,150,100,0.4);">
                    <div style="font-size: 12px; color: #ca8; margin-bottom: 8px; font-weight: 600;">Test Material (Ê∏¨Ë©¶Áâ©)</div>
                    <div class="input-grid">
                        <div class="input-group">
                            <label id="labelTestName">ÂêçÁ®±/‰ª£Ëôü</label>
                            <input type="text" id="testName" placeholder="e.g. Sample-A" style="background:#2a2a35; border:1px solid #555; color:#ddd; padding:8px; border-radius:5px;">
                        </div>
                        <div class="input-group">
                            <label id="labelTestAmount">Áî®Èáè (g)</label>
                            <input type="number" id="testAmount" value="" step="0.1" oninput="updatePhrPreview(); updatePhrResinCalc()">
                        </div>
                        <div class="input-group">
                            <label>ÂÇôË®ª</label>
                            <input type="text" id="testNote" placeholder="e.g. Êñ∞ÂûãÁôºÊ≥°Âäë" style="background:#2a2a35; border:1px solid #555; color:#ddd; padding:8px; border-radius:5px;">
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title">Mixing Parameters (ÂØÜÁÖâÊ©üÂèÉÊï∏)</div>
                
                <!-- ÂØÜÁÖâÊ©üË¶èÊ†ºÂíåÊñôÂ∞æËº∏ÂÖ• -->
                <div class="input-grid" style="margin-bottom: 10px;">
                    <div class="input-group">
                        <label>Ê∑∑Á∑¥Ë®≠ÂÇô</label>
                        <select id="mixerVolume" onchange="onMixerChange()" style="width: 100%; padding: 8px; background: #2a2a35; color: #ddd; border: 1px solid #444; border-radius: 5px;">
                            <option value="55">55L</option>
                            <option value="75" selected>75L</option>
                            <option value="110">110L</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label id="labelTailMaterial">ÊñôÂ∞æ (kg)</label>
                        <input type="number" id="tailMaterial" value="0" step="0.5" min="0" max="30" placeholder="ÊåâÈÖçÊñπÊØî‰æãÁ∏ÆÂ∞è">
                    </div>
                </div>
                
                <!-- Ëá™ÂãïË®àÁÆóÈ°ØÁ§∫ÂçÄ -->
                <div id="mixerCalcDisplay" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; padding: 10px; background: rgba(80,100,120,0.15); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">ÈÖçÊñπÁ∏ΩÈáç</div>
                        <div id="displayFormulaWeight" style="font-size: 14px; font-weight: 700; color: #9cf;">-- <span id="unitFormulaWeight">kg</span></div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">ÊñôÂ∞æÊØî‰æã</div>
                        <div id="displayTailRatio" style="font-size: 14px; font-weight: 700; color: #9cf;">-- %</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">ÂØ¶ÈöõÁ∏ΩÈáç</div>
                        <div id="displayTotalWeight" style="font-size: 14px; font-weight: 700; color: #9cf;">-- <span id="unitTotalWeight">kg</span></div>
                    </div>
                </div>
                <div id="fillFactorRow" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; padding: 10px; background: rgba(80,100,120,0.15); border-radius: 8px;">
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">ÁêÜË´ñÂØÜÂ∫¶</div>
                        <div id="displayTheoDensity" style="font-size: 14px; font-weight: 700; color: #9cf;">-- g/cm¬≥</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">ÁêÜË´ñÈ´îÁ©ç</div>
                        <div id="displayTheoVolume" style="font-size: 14px; font-weight: 700; color: #9cf;">-- L</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 10px; color: #8aa;">Â°´ÂÖÖ‰øÇÊï∏</div>
                        <div id="displayFillFactor" style="font-size: 14px; font-weight: 700; color: #9cf;">--</div>
                    </div>
                </div>
                
                <!-- Ê∑∑Á∑¥ÂèÉÊï∏Ëº∏ÂÖ• -->
                <div class="input-grid">
                    <div class="input-group">
                        <label>Ê∑∑ÁÖâÊôÇÈñì (min)</label>
                        <input type="number" id="mixTime" value="" step="1" min="5" max="60">
                    </div>
                    <div class="input-group" id="rotorSpeedGroup">
                        <label>ËΩâÂ≠êËΩâÈÄü (rpm)</label>
                        <input type="number" id="rotorSpeed" value="" step="5" min="20" max="100">
                    </div>
                    <div class="input-group">
                        <label>ÊäïËó•Ê∫´Â∫¶ (¬∞C)</label>
                        <input type="number" id="dosageTemp" value="" step="5" min="70" max="100" placeholder="DCPÊäïÂÖ•ÊôÇÊ∫´Â∫¶">
                    </div>
                    <div class="input-group">
                        <label>Âá∫ÊñôÊ∫´Â∫¶ (¬∞C)</label>
                        <input type="number" id="dischargeTemp" value="" step="1" min="100" max="150" placeholder="ÂØ¶Ê∏¨ÂÄº">
                    </div>
                </div>
                <!-- Èö±ËóèÊ¨Ñ‰Ωç -->
                <input type="hidden" id="mixInitTemp" value="55">
                <input type="hidden" id="fillFactor" value="1.0">
            </div>
            
            <div class="input-section">
                <div class="section-title">Process Parameters (ÁôºÊ≥°Ë£ΩÁ®ã)</div>
                <div class="input-grid">
                    <div class="input-group">
                        <label>Primary Temp (¬∞C)</label>
                        <input type="number" id="temp1" value="" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Primary Time (min)</label>
                        <input type="number" id="time1" value="" step="1">
                    </div>
                    <div class="input-group">
                        <label>Secondary Temp (¬∞C)</label>
                        <input type="number" id="temp2" value="" step="0.1">
                    </div>
                    <div class="input-group">
                        <label>Secondary Time (min)</label>
                        <input type="number" id="time2" value="" step="1">
                    </div>
                </div>
            </div>
            
            <button class="calc-button" onclick="calculate()" style="background: linear-gradient(135deg, #5a6a5a 0%, #4a5a4a 100%); color: #ddd;">Calculate & Predict</button>
            
            <div id="results" style="display:none;">
                <!-- v7.5: Input Summary - ÂØ¶ÈöõÁß§ÊñôÈáè (Lab Mode only) -->
                <div id="inputSummarySection" class="input-section" style="display:none;">
                    <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
                        <span>Input Summary</span>
                        <button onclick="printInputSummary()" style="padding:6px 12px; background:linear-gradient(135deg,#4a6a5a,#3a5a4a); border:none; border-radius:6px; color:white; cursor:pointer; font-size:11px;">
                            Print Formula
                        </button>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="inputSummaryTable"></table>
                    </div>
                </div>
                
                <div class="input-section">
                    <div class="section-title">Formula Decomposition</div>
                    <div style="overflow-x:auto;">
                        <table id="decompTable"></table>
                    </div>
                </div>
                
                <!-- Êñ∞Â¢û: ÂàÜÈ°ûÊåáÊ®ôÂçÄÂ°ä -->
                <div class="input-section">
                    <div class="section-title">Filler & Flame Retardant Analysis</div>
                    <div id="separatedAnalysis"></div>
                </div>
                
                <div class="input-section">
                    <div class="section-title">Key Indicators</div>
                    <div class="results-grid" id="keyIndicators"></div>
                </div>
                
                <div class="input-section">
                    <div class="section-title">Quality Prediction</div>
                    <div class="results-grid" id="predictions"></div>
                </div>
                
                <div class="input-section">
                    <button class="calc-button" onclick="saveToHistory()" style="background: linear-gradient(135deg, #4a5a4a 0%, #3a4a3a 100%); color: #ccc;">
                        Save to History
                    </button>
                </div>
            </div>
            
            <div class="input-section">
                <div class="section-title">History Records</div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Model/Batch</th>
                                <th>Density/Exp</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="historyBody">
                            <tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No records</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination Controls -->
                <div id="historyPagination" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 10px;">
                    <button onclick="changeHistoryPage(-1)" id="prevPageBtn" style="background: #3a4a5a; color: #aaa; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚óÄ Prev</button>
                    <span id="pageInfo" style="color: #888; font-size: 12px;">Page 1 / 1</span>
                    <button onclick="changeHistoryPage(1)" id="nextPageBtn" style="background: #3a4a5a; color: #aaa; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Next ‚ñ∂</button>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button class="calc-button" onclick="exportHistory()" style="background: linear-gradient(135deg, #4a5a6a 0%, #3a4a5a 100%); color: #ccc; flex: 1;">
                        Export CSV
                    </button>
                    <button class="calc-button" onclick="clearHistory()" style="background: linear-gradient(135deg, #6a4a4a 0%, #5a3a3a 100%); color: #ccc; flex: 1;">
                        Clear History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== ÁôªÂÖ•Á≥ªÁµ± ====================
        let isAuthenticated = false;
        let currentHistoryPage = 0;  // v7.4: History pagination
        const historyPageSize = 10;
        let labInputMode = 'weight';  // v7.4: 'weight' or 'phr'
        const DEFAULT_PASSWORD = btoa('foam2026');
        let loginAttempts = 0;
        
        function getStoredPassword() {
            return localStorage.getItem('foamAppPassword') || DEFAULT_PASSWORD;
        }
        
        function setStoredPassword(newPassword) {
            localStorage.setItem('foamAppPassword', btoa(newPassword));
        }
        
        // v7.5.3: Password reset
        function resetPassword() {
            if (confirm('Reset password to default (foam2026)?')) {
                localStorage.removeItem('foamAppPassword');
                loginAttempts = 0;
                const rl = document.getElementById('resetLink');
                if (rl) rl.style.display = 'none';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                alert('Password reset to: foam2026');
            }
        }
        
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const storedPassword = atob(getStoredPassword());
            
            if (input === storedPassword) {
                isAuthenticated = true;
                loginAttempts = 0;
                sessionStorage.setItem('authenticated', 'true');
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutButton').classList.add('show');
                document.getElementById('settingsButton').classList.add('show');
                document.getElementById('passwordInput').value = '';
            } else {
                loginAttempts++;
                const errorMsg = document.getElementById('errorMessage');
                errorMsg.classList.add('show');
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
                
                if (loginAttempts >= 2) {
                    const rl = document.getElementById('resetLink');
                    if (rl) rl.style.display = 'block';
                }
                
                setTimeout(() => {
                    errorMsg.classList.remove('show');
                }, 3000);
            }
        }
        
        function logout() {
            if (confirm('Á¢∫ÂÆöË¶ÅÁôªÂá∫ÂóéÔºü')) {
                isAuthenticated = false;
                sessionStorage.removeItem('authenticated');
                document.getElementById('loginOverlay').classList.remove('hidden');
                document.getElementById('logoutButton').classList.remove('show');
                document.getElementById('settingsButton').classList.remove('show');  // v7.5.1
                document.getElementById('passwordInput').focus();
            }
        }
        
        // v7.5.1: Ë®≠ÂÆöÂäüËÉΩ
        function openSettings() {
            document.getElementById('settingsModal').classList.add('show');
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('settingsMessage').className = 'settings-message';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('show');
        }
        
        function changePassword() {
            const current = document.getElementById('currentPassword').value;
            const newPwd = document.getElementById('newPassword').value;
            const confirm = document.getElementById('confirmPassword').value;
            const msgEl = document.getElementById('settingsMessage');
            
            // È©óË≠âÁï∂ÂâçÂØÜÁ¢º
            if (current !== atob(getStoredPassword())) {
                msgEl.textContent = 'Current password is incorrect';
                msgEl.className = 'settings-message error';
                return;
            }
            
            // È©óË≠âÊñ∞ÂØÜÁ¢º
            if (newPwd.length < 4) {
                msgEl.textContent = 'New password must be at least 4 characters';
                msgEl.className = 'settings-message error';
                return;
            }
            
            if (newPwd !== confirm) {
                msgEl.textContent = 'New passwords do not match';
                msgEl.className = 'settings-message error';
                return;
            }
            
            // ÂÑ≤Â≠òÊñ∞ÂØÜÁ¢º
            setStoredPassword(newPwd);
            msgEl.textContent = 'Password updated successfully!';
            msgEl.className = 'settings-message success';
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        }
        
        // È†ÅÈù¢ËºâÂÖ•ÊôÇÊ™¢Êü•ÁôªÂÖ•ÁãÄÊÖã
        window.addEventListener('DOMContentLoaded', () => {
            const authenticated = sessionStorage.getItem('authenticated');
            if (authenticated === 'true') {
                isAuthenticated = true;
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('logoutButton').classList.add('show');
                document.getElementById('settingsButton').classList.add('show');  // v7.5.1
            } else {
                document.getElementById('passwordInput').focus();
            }
            
            // v7.3.6: Ê†πÊìöÊ®°ÂºèËºâÂÖ•Â∞çÊáâÁöÑHistory
            loadHistory();
            document.getElementById('productionDate').valueAsDate = new Date();
        });
        
        // ==================== PWA ÂäüËÉΩ ====================
        let deferredPrompt;
        let historyData = [];        // ÁîüÁî¢Ê®°Âºè
        let historyDataLab = [];     // ÂØ¶È©óÊ®°Âºè
        let currentCalc = null;
        
        if (window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone) {
            document.getElementById('pwaBadge').textContent = 'PWA';
            document.getElementById('pwaBadge').style.background = '#43e97b';
        }
        
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const isFileProtocol = window.location.protocol === 'file:';
                
                if (isFileProtocol) {
                    console.log('[INFO] Running from local file');
                    document.getElementById('pwaBadge').textContent = 'LOCAL';
                    document.getElementById('pwaBadge').style.background = '#5a7a8a';
                    return;
                }
                
                // v7.5.3: Unregister stale service workers + clear caches for reliability
                navigator.serviceWorker.getRegistrations().then(regs => {
                    regs.forEach(r => { r.unregister(); console.log('[INFO] Unregistered stale SW'); });
                });
                if ('caches' in window) {
                    caches.keys().then(names => names.forEach(n => caches.delete(n)));
                }
                console.log('[INFO] SW disabled in v7.5.3 for GitHub Pages reliability');
            });
        }
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installBanner').style.display = 'block';
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('[OK] PWA installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installBanner').style.display = 'none';
                });
            }
        }
        
        function dismissInstall() {
            document.getElementById('installBanner').style.display = 'none';
        }
        
        window.addEventListener('online', () => {
            if (!isAuthenticated) return;
            const indicator = document.getElementById('offlineIndicator');
            indicator.textContent = 'Online';
            indicator.classList.add('online');
            indicator.style.display = 'block';
            setTimeout(() => indicator.style.display = 'none', 3000);
        });
        
        window.addEventListener('offline', () => {
            if (!isAuthenticated) return;
            const indicator = document.getElementById('offlineIndicator');
            indicator.textContent = 'üì° Èõ¢Á∑öÊ®°Âºè';
            indicator.classList.remove('online');
            indicator.style.display = 'block';
        });
        
        // ==================== v7.3.6: Ê®°ÂºèÂàáÊèõ ====================
        let currentMode = 'production';  // 'production' or 'lab'
        
        function switchMode(mode) {
            currentMode = mode;
            currentHistoryPage = 0;  // v7.4: Reset pagination when switching mode
            
            // Êõ¥Êñ∞ÊåâÈàïÊ®£Âºè
            const btnProd = document.getElementById('btnProductionMode');
            const btnLab = document.getElementById('btnLabMode');
            
            if (mode === 'production') {
                btnProd.style.background = 'linear-gradient(135deg, #5a7a6a, #3a5a4a)';
                btnProd.style.color = 'white';
                btnLab.style.background = '#2a2a35';
                btnLab.style.color = '#888';
                // v7.4: Èö±Ëóè Lab Unit Toggle
                document.getElementById('labUnitToggle').style.display = 'none';
                // v7.5.1: Èö±ËóèÊ∏¨Ë©¶Áâ©Ê¨Ñ‰Ωç
                document.getElementById('testMaterialSection').style.display = 'none';
            } else {
                btnLab.style.background = 'linear-gradient(135deg, #6a5a7a, #4a3a5a)';
                btnLab.style.color = 'white';
                btnProd.style.background = '#2a2a35';
                btnProd.style.color = '#888';
                // v7.4: È°ØÁ§∫ Lab Unit ToggleÔºåÈáçÁΩÆÁÇ∫ weight Ê®°Âºè
                document.getElementById('labUnitToggle').style.display = 'block';
                labInputMode = 'weight';
                updateLabUnitUI();
                // v7.5.1: È°ØÁ§∫Ê∏¨Ë©¶Áâ©Ê¨Ñ‰Ωç
                document.getElementById('testMaterialSection').style.display = 'block';
            }
            
            // Êõ¥Êñ∞ÂñÆ‰ΩçÊ®ôÁ±§
            updateUnitLabels(mode);
            
            // Êõ¥Êñ∞Ê∑∑Á∑¥Ë®≠ÂÇôÈÅ∏È†Ö
            updateMixerOptions(mode);
            
            // Ê∏ÖÁ©∫Ëº∏ÂÖ•Ê¨Ñ‰Ωç
            clearAllInputs();
            
            // ÂàáÊèõ History È°ØÁ§∫
            if (isAuthenticated) {
                loadHistory();
            }
            
            // Èö±ËóèÁµêÊûú
            document.getElementById('results').style.display = 'none';
        }
        
        function updateUnitLabels(mode) {
            const isLab = (mode === 'lab');
            const resinUnit = isLab ? '(g)' : '(kg)';
            const mbUnit = isLab ? '(g)' : '(kg)';
            const tailUnit = isLab ? '(g)' : '(kg)';
            
            // Êõ¥Êñ∞ section titles
            document.getElementById('sectionResin').textContent = 'Resin System ' + resinUnit;
            document.getElementById('sectionMasterbatch').textContent = 'Masterbatch ' + mbUnit;
            
            // Êõ¥Êñ∞ Additives Ê®ôÁ±§
            document.getElementById('labelATH').textContent = isLab ? 'ATH (g)' : 'ATH (kg)';
            document.getElementById('labelCP70').textContent = isLab ? 'CP-70 Chlorinated Paraffin (g)' : 'CP-70 Chlorinated Paraffin (kg)';
            
            // Êõ¥Êñ∞ÊñôÂ∞æÊ®ôÁ±§
            document.getElementById('labelTailMaterial').textContent = 'ÊñôÂ∞æ ' + tailUnit;
            
            // Êõ¥Êñ∞È°ØÁ§∫ÂñÆ‰Ωç
            document.getElementById('unitFormulaWeight').textContent = isLab ? 'g' : 'kg';
            document.getElementById('unitTotalWeight').textContent = isLab ? 'g' : 'kg';
        }
        
        // ==================== v7.4: Lab Mode phr/weight ÂàáÊèõ ====================
        function switchLabUnit(mode) {
            if (currentMode !== 'lab') return;
            
            const oldMode = labInputMode;
            labInputMode = mode;
            
            // Êõ¥Êñ∞UI
            updateLabUnitUI();
            
            // Ëá™ÂãïÊèõÁÆóÊï∏ÂÄº
            convertLabValues(oldMode, mode);
            
            // v7.4.2: Êõ¥Êñ∞ phr È†êË¶Ω
            updatePhrPreview();
        }
        
        function updateLabUnitUI() {
            const btnWeight = document.getElementById('btnWeightMode');
            const btnPhr = document.getElementById('btnPhrMode');
            const totalResinInput = document.getElementById('totalResinInput');
            const phrNote = document.getElementById('phrNote');
            const phrResinCalcPanel = document.getElementById('phrResinCalcPanel');
            
            if (labInputMode === 'weight') {
                btnWeight.style.background = 'linear-gradient(135deg, #6a5a7a, #4a3a5a)';
                btnWeight.style.color = 'white';
                btnPhr.style.background = '#2a2a35';
                btnPhr.style.color = '#888';
                totalResinInput.style.display = 'none';
                phrNote.style.display = 'none';
                // v7.5: Èö±ËóèÊ®πËÑÇË®àÁÆóÈù¢Êùø
                phrResinCalcPanel.style.display = 'none';
            } else {
                btnPhr.style.background = 'linear-gradient(135deg, #6a5a7a, #4a3a5a)';
                btnPhr.style.color = 'white';
                btnWeight.style.background = '#2a2a35';
                btnWeight.style.color = '#888';
                totalResinInput.style.display = 'flex';
                phrNote.style.display = 'block';
                // v7.5: Êõ¥Êñ∞ phr Ê®πËÑÇË®àÁÆóÈù¢Êùø
                updatePhrResinCalc();
            }
            
            // Êõ¥Êñ∞Ê¨Ñ‰ΩçÊ®ôÁ±§
            updateLabFieldLabels();
        }
        
        // ==================== v7.5: phr Âü∫Ê∫ñÂàáÊèõ (Á¥îÊ®πËÑÇ vs Á∏ΩÊ®πËÑÇ) ====================
        let phrBasis = 'total';  // 'pure' Êàñ 'total'ÔºåÈ†êË®≠Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ
        
        function switchPhrBasis(basis) {
            phrBasis = basis;
            
            const btnPure = document.getElementById('btnPhrPure');
            const btnTotal = document.getElementById('btnPhrTotal');
            const phrNoteText = document.getElementById('phrNoteText');
            const phrResinCalcPanel = document.getElementById('phrResinCalcPanel');
            
            if (basis === 'pure') {
                btnPure.style.background = 'linear-gradient(135deg, #5a6a7a, #3a4a5a)';
                btnPure.style.color = 'white';
                btnTotal.style.background = '#2a2a35';
                btnTotal.style.color = '#888';
                phrNoteText.textContent = 'Á¥îÊ®πËÑÇÂü∫Ê∫ñ: Ëº∏ÂÖ•ÁöÑÊ®πËÑÇÈáçÈáè‰∏çÂåÖÂê´ÊØçÁ≤íËºâÈ´îÔºåÊØçÁ≤íËºâÈ´îÊúÉÈ°çÂ§ñÂä†ÂÖ•';
                phrResinCalcPanel.style.display = 'none';
            } else {
                btnTotal.style.background = 'linear-gradient(135deg, #5a7a6a, #3a5a4a)';
                btnTotal.style.color = 'white';
                btnPure.style.background = '#2a2a35';
                btnPure.style.color = '#888';
                phrNoteText.textContent = 'Á∏ΩÊ®πËÑÇÂü∫Ê∫ñ: Ëº∏ÂÖ•Ê®πËÑÇÊØî‰æã (Ëá™ÂãïÊ≠∏‰∏ÄÂåñËá≥100)ÔºåÊØçÁ≤íËºâÈ´îÊúÉËá™ÂãïÂæûÁ¥îÊ®πËÑÇÊâ£Èô§';
                phrResinCalcPanel.style.display = 'block';
                updatePhrResinCalc();
            }
        }
        
        // ==================== v7.5: Á∏ΩÊ®πËÑÇÂü∫Ê∫ñË®àÁÆó ====================
        function updatePhrResinCalc() {
            if (currentMode !== 'lab' || labInputMode !== 'phr' || phrBasis !== 'total') {
                document.getElementById('phrResinCalcPanel').style.display = 'none';
                return;
            }
            
            document.getElementById('phrResinCalcPanel').style.display = 'block';
            
            const totalResinG = parseFloat(document.getElementById('totalResinWeight').value) || 200;
            
            // ÂèñÂæóÊØçÁ≤í phr ÂÄº
            const acpePhr = parseFloat(document.getElementById('acpe').value) || 0;
            const acevaPhr = parseFloat(document.getElementById('aceva').value) || 0;
            const fillerPhr = parseFloat(document.getElementById('filler').value) || 0;
            const colorPhr = parseFloat(document.getElementById('color').value) || 0;
            const brsbPhr = parseFloat(document.getElementById('brsb').value) || 0;
            const redpPhr = parseFloat(document.getElementById('redp').value) || 0;
            
            // Ë®àÁÆóÊØçÁ≤í‰∏≠ÁöÑËºâÈ´îÊ®πËÑÇ phr
            // AC-PE MB: 50% PE
            const peFromAcpe = acpePhr * 0.5;
            // AC-EVA MB: 50% EVA
            const evaFromAceva = acevaPhr * 0.5;
            // Filler MB: 25% EVA
            const evaFromFiller = fillerPhr * 0.25;
            // Color MB: 63% EVA
            const evaFromColor = colorPhr * 0.63;
            // Br/Sb MB: 48% EVA
            const evaFromBrsb = brsbPhr * 0.48;
            // RedP MB: 50% EVA
            const evaFromRedp = redpPhr * 0.5;
            
            const totalEvaFromMB = evaFromAceva + evaFromFiller + evaFromColor + evaFromBrsb + evaFromRedp;
            const totalPeFromMB = peFromAcpe;
            const totalCarrierPhr = totalEvaFromMB + totalPeFromMB;
            
            // Ë®àÁÆóÈúÄËº∏ÂÖ•ÁöÑÁ¥îÊ®πËÑÇ phr
            const pureResinPhr = 100 - totalCarrierPhr;
            
            // ÂèñÂæó‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑÊ®πËÑÇÊØî‰æã
            const eva16Ratio = parseFloat(document.getElementById('eva16').value) || 0;
            const eva25Ratio = parseFloat(document.getElementById('eva25').value) || 0;
            const ldpe24Ratio = parseFloat(document.getElementById('ldpe24').value) || 0;
            const ldpe40Ratio = parseFloat(document.getElementById('ldpe40').value) || 0;
            const poeRatio = parseFloat(document.getElementById('poe').value) || 0;
            const totalRatio = eva16Ratio + eva25Ratio + ldpe24Ratio + ldpe40Ratio + poeRatio;
            
            // Ë®àÁÆóÊúÄÁµÇÊ®πËÑÇÁµÑÊàê (ÁõÆÊ®ôÊØî‰æã)
            let targetEvaRatio = 0, targetLdpeRatio = 0;
            if (totalRatio > 0) {
                targetEvaRatio = (eva16Ratio + eva25Ratio) / totalRatio * 100;
                targetLdpeRatio = (ldpe24Ratio + ldpe40Ratio) / totalRatio * 100;
            }
            
            // È°ØÁ§∫Ë®àÁÆóÁµêÊûú
            let html = '';
            html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">`;
            html += `<div>ÁõÆÊ®ôÁ∏ΩÊ®πËÑÇ: <strong>${totalResinG.toFixed(0)}g</strong> (100 phr)</div>`;
            html += `<div>ÈúÄËº∏ÂÖ•Á¥îÊ®πËÑÇ: <strong style="color:#8f8;">${pureResinPhr.toFixed(1)} phr</strong> (${(pureResinPhr/100*totalResinG).toFixed(1)}g)</div>`;
            html += `</div>`;
            
            if (totalCarrierPhr > 0) {
                html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(80,120,100,0.3);">`;
                html += `<div style="color: #9ba;">ÊØçÁ≤íËºâÈ´îÊ®πËÑÇ:</div>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;">`;
                if (totalPeFromMB > 0) html += `<span style="background:rgba(100,150,200,0.2); padding:2px 6px; border-radius:3px;">PE: ${totalPeFromMB.toFixed(2)} phr (from AC-PE)</span>`;
                if (totalEvaFromMB > 0) {
                    let evaDetails = [];
                    if (evaFromAceva > 0) evaDetails.push(`AC-EVA ${evaFromAceva.toFixed(2)}`);
                    if (evaFromFiller > 0) evaDetails.push(`Filler ${evaFromFiller.toFixed(2)}`);
                    if (evaFromColor > 0) evaDetails.push(`Color ${evaFromColor.toFixed(2)}`);
                    if (evaFromBrsb > 0) evaDetails.push(`Br/Sb ${evaFromBrsb.toFixed(2)}`);
                    if (evaFromRedp > 0) evaDetails.push(`RedP ${evaFromRedp.toFixed(2)}`);
                    html += `<span style="background:rgba(150,200,100,0.2); padding:2px 6px; border-radius:3px;">EVA: ${totalEvaFromMB.toFixed(2)} phr (${evaDetails.join(' + ')})</span>`;
                }
                html += `</div>`;
                html += `<div style="margin-top: 4px; color: #ab9;">Á∏ΩËºâÈ´î: <strong>${totalCarrierPhr.toFixed(2)} phr</strong> (${(totalCarrierPhr/100*totalResinG).toFixed(1)}g)</div>`;
                html += `</div>`;
            }
            
            // Ë®àÁÆóË™øÊï¥ÂæåÁöÑÁ¥îÊ®πËÑÇËº∏ÂÖ•Èáè
            if (totalRatio > 0 && pureResinPhr > 0) {
                html += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px dashed rgba(80,120,100,0.3);">`;
                html += `<div style="color: #9ba;">Ë™øÊï¥ÂæåÁ¥îÊ®πËÑÇËº∏ÂÖ• (ËÄÉÊÖÆÊØçÁ≤íËºâÈ´î):</div>`;
                html += `<div style="display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px;">`;
                
                // Ë®àÁÆóÂêÑÊ®πËÑÇÁöÑÁõÆÊ®ô phr ÂíåË™øÊï¥ÂæåËº∏ÂÖ•
                const evaTargetPhr = targetEvaRatio;
                const ldpeTargetPhr = targetLdpeRatio;
                const poeTargetPhr = poeRatio / totalRatio * 100;
                
                // Êâ£Èô§ÊØçÁ≤íËºâÈ´îÂæåÁöÑÁ¥îÊ®πËÑÇËº∏ÂÖ•
                const evaInputPhr = Math.max(0, evaTargetPhr - totalEvaFromMB);
                const ldpeInputPhr = Math.max(0, ldpeTargetPhr - totalPeFromMB);
                
                if (eva16Ratio > 0 || eva25Ratio > 0) {
                    const eva16InputPhr = eva16Ratio / (eva16Ratio + eva25Ratio) * evaInputPhr || 0;
                    const eva25InputPhr = eva25Ratio / (eva16Ratio + eva25Ratio) * evaInputPhr || 0;
                    if (eva16InputPhr > 0) html += `<span style="background:rgba(150,200,100,0.2); padding:2px 6px; border-radius:3px;">EVA: ${eva16InputPhr.toFixed(1)} phr ‚Üí ${(eva16InputPhr/100*totalResinG).toFixed(1)}g</span>`;
                    if (eva25InputPhr > 0) html += `<span style="background:rgba(150,200,100,0.2); padding:2px 6px; border-radius:3px;">EVA(2): ${eva25InputPhr.toFixed(1)} phr ‚Üí ${(eva25InputPhr/100*totalResinG).toFixed(1)}g</span>`;
                }
                if (ldpe24Ratio > 0 || ldpe40Ratio > 0) {
                    const ldpe24InputPhr = ldpe24Ratio / (ldpe24Ratio + ldpe40Ratio) * ldpeInputPhr || 0;
                    const ldpe40InputPhr = ldpe40Ratio / (ldpe24Ratio + ldpe40Ratio) * ldpeInputPhr || 0;
                    if (ldpe24InputPhr > 0) html += `<span style="background:rgba(100,150,200,0.2); padding:2px 6px; border-radius:3px;">LDPE: ${ldpe24InputPhr.toFixed(1)} phr ‚Üí ${(ldpe24InputPhr/100*totalResinG).toFixed(1)}g</span>`;
                    if (ldpe40InputPhr > 0) html += `<span style="background:rgba(100,150,200,0.2); padding:2px 6px; border-radius:3px;">LDPE(2): ${ldpe40InputPhr.toFixed(1)} phr ‚Üí ${(ldpe40InputPhr/100*totalResinG).toFixed(1)}g</span>`;
                }
                if (poeTargetPhr > 0) html += `<span style="background:rgba(200,150,100,0.2); padding:2px 6px; border-radius:3px;">POE: ${poeTargetPhr.toFixed(1)} phr ‚Üí ${(poeTargetPhr/100*totalResinG).toFixed(1)}g</span>`;
                
                html += `</div>`;
                html += `</div>`;
            }
            
            document.getElementById('phrResinCalcContent').innerHTML = html;
        }
        
        function updateLabFieldLabels() {
            const isPhr = (labInputMode === 'phr');
            const resinUnit = isPhr ? '(phr)' : '(g)';
            const mbUnit = isPhr ? '(phr)' : '(g)';
            const addUnit = isPhr ? '(phr)' : '(g)';
            
            // Resin section title
            document.getElementById('sectionResin').textContent = isPhr ? 'Resin System (phr ratio)' : 'Resin System (g)';
            
            // Masterbatch section title  
            document.getElementById('sectionMasterbatch').textContent = isPhr ? 'Masterbatch (phr)' : 'Masterbatch (g)';
            
            // Additives - Â∞èÊñôÊ®ôÁ±§ (DCP, ZnO Á≠â‰øùÊåÅ gÔºåÂõ†ÁÇ∫Áî®ÈáèÂæàÂ∞è)
            // ‰ΩÜÂú® phr Ê®°Âºè‰∏ã‰πüÊîπÊàê phr
            document.getElementById('labelDCP').textContent = isPhr ? 'DCP (phr)' : 'DCP (g)';
            document.getElementById('labelBHT').textContent = isPhr ? 'BHT (phr)' : 'BHT (g)';
            document.getElementById('labelZnO').textContent = isPhr ? 'ZnO (phr)' : 'ZnO (g)';
            document.getElementById('labelUrea').textContent = isPhr ? 'Modified Urea (phr)' : 'Modified Urea (g)';
            document.getElementById('labelPowder').textContent = isPhr ? 'Powder (phr)' : 'Powder (g)';
            document.getElementById('labelATH').textContent = isPhr ? 'ATH (phr)' : 'ATH (g)';
            document.getElementById('labelCP70').textContent = isPhr ? 'CP-70 Chlorinated Paraffin (phr)' : 'CP-70 Chlorinated Paraffin (g)';
        }
        
        function convertLabValues(fromMode, toMode) {
            if (fromMode === toMode) return;
            
            // ÂèñÂæóÊ®πËÑÇÊ¨Ñ‰ΩçÂÄº
            const resinFields = ['eva16', 'eva25', 'ldpe24', 'ldpe40', 'poe'];
            const mbFields = ['acpe', 'aceva', 'filler', 'color', 'brsb', 'redp'];
            const addFields = ['ath', 'cp70', 'dcp', 'bht', 'zno', 'urea', 'powder'];
            
            if (fromMode === 'weight' && toMode === 'phr') {
                // Weight ‚Üí phrÔºöË®àÁÆóÁõÆÂâçÊ®πËÑÇÁ∏ΩÈáçÔºåÊèõÁÆóÊàê phr
                let totalResin = 0;
                resinFields.forEach(id => {
                    totalResin += parseFloat(document.getElementById(id).value) || 0;
                });
                
                if (totalResin <= 0) {
                    // Ê≤íÊúâËº∏ÂÖ•Ê®πËÑÇÊôÇÔºåÂÖÅË®±Áõ¥Êé•ÈÄ≤ÂÖ• phr Ê®°Âºè
                    // ‰ΩøÁî®È†êË®≠Á∏ΩÊ®πËÑÇÈáçÈáèÔºåËÆì‰ΩøÁî®ËÄÖÁõ¥Êé•Ëº∏ÂÖ• phr
                    document.getElementById('totalResinWeight').value = '200';
                    return;
                }
                
                // ÂÑ≤Â≠òÁ∏ΩÊ®πËÑÇÈáçÈáè‰æõ‰πãÂæåÊèõÁÆóÂõûÂéª
                document.getElementById('totalResinWeight').value = totalResin.toFixed(0);
                
                // ÊèõÁÆóÊ®πËÑÇÁÇ∫ phr (‰ª•100ÁÇ∫Âü∫Ê∫ñ)
                resinFields.forEach(id => {
                    const val = parseFloat(document.getElementById(id).value) || 0;
                    const phr = (val / totalResin) * 100;
                    document.getElementById(id).value = phr > 0 ? phr.toFixed(1) : '';
                });
                
                // ÊèõÁÆóÊØçÁ≤íÁÇ∫ phr
                mbFields.forEach(id => {
                    const val = parseFloat(document.getElementById(id).value) || 0;
                    const phr = (val / totalResin) * 100;
                    document.getElementById(id).value = phr > 0 ? phr.toFixed(2) : '';
                });
                
                // ÊèõÁÆóÂ∞èÊñôÁÇ∫ phr
                addFields.forEach(id => {
                    const val = parseFloat(document.getElementById(id).value) || 0;
                    const phr = (val / totalResin) * 100;
                    document.getElementById(id).value = phr > 0 ? phr.toFixed(3) : '';
                });
                
            } else if (fromMode === 'phr' && toMode === 'weight') {
                // phr ‚Üí WeightÔºöÁî®Á∏ΩÊ®πËÑÇÈáçÈáèÊèõÁÆóÂõûÂØ¶ÈöõÈáçÈáè
                const totalResin = parseFloat(document.getElementById('totalResinWeight').value) || 200;
                
                // ÂÖàË®àÁÆóÊ®πËÑÇ phr Á∏ΩÂíåÔºàÊáâË©≤Êé•Ëøë 100Ôºâ
                let resinPhrSum = 0;
                resinFields.forEach(id => {
                    resinPhrSum += parseFloat(document.getElementById(id).value) || 0;
                });
                
                // Ê≠£Ë¶èÂåñ‰øÇÊï∏ÔºàÂ¶ÇÊûú‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑÊ®πËÑÇ phr ‰∏çÁ≠âÊñº 100Ôºâ
                const normFactor = resinPhrSum > 0 ? 100 / resinPhrSum : 1;
                
                // ÊèõÁÆóÊ®πËÑÇÁÇ∫ÂØ¶ÈöõÈáçÈáè
                resinFields.forEach(id => {
                    const phr = parseFloat(document.getElementById(id).value) || 0;
                    const normalizedPhr = phr * normFactor;
                    const weight = (normalizedPhr / 100) * totalResin;
                    document.getElementById(id).value = weight > 0 ? weight.toFixed(1) : '';
                });
                
                // ÊèõÁÆóÊØçÁ≤íÁÇ∫ÂØ¶ÈöõÈáçÈáè
                mbFields.forEach(id => {
                    const phr = parseFloat(document.getElementById(id).value) || 0;
                    const weight = (phr / 100) * totalResin;
                    document.getElementById(id).value = weight > 0 ? weight.toFixed(1) : '';
                });
                
                // ÊèõÁÆóÂ∞èÊñôÁÇ∫ÂØ¶ÈöõÈáçÈáè
                addFields.forEach(id => {
                    const phr = parseFloat(document.getElementById(id).value) || 0;
                    const weight = (phr / 100) * totalResin;
                    document.getElementById(id).value = weight > 0 ? weight.toFixed(1) : '';
                });
            }
        }
        
        function updateMixerOptions(mode) {
            const mixerSelect = document.getElementById('mixerVolume');
            const rotorInput = document.getElementById('rotorSpeed');
            const rotorGroup = document.getElementById('rotorSpeedGroup');
            
            if (mode === 'lab') {
                // ÂØ¶È©óÊ®°Âºè: ÈõôÊªæÁ≠í / ÂØÜÁÖâÊ©ü 1L
                mixerSelect.innerHTML = `
                    <option value="0">Two-Roll Mill (ÈõôÊªæÁ≠í)</option>
                    <option value="1">Lab Mixer 1L</option>
                `;
                // È†êË®≠ÈÅ∏ÈõôÊªæÁ≠í
                mixerSelect.value = '0';
                onMixerChange();
            } else {
                // ÁîüÁî¢Ê®°Âºè: ÂØÜÁÖâÊ©ü 55/75/110L
                mixerSelect.innerHTML = `
                    <option value="55">55L</option>
                    <option value="75" selected>75L</option>
                    <option value="110">110L</option>
                `;
                // ÊÅ¢Âæ©ËΩâÈÄüËº∏ÂÖ•
                rotorInput.disabled = false;
                rotorInput.value = '';
                rotorInput.placeholder = '';
                document.getElementById('fillFactorRow').style.display = '';
            }
        }
        
        function onMixerChange() {
            if (currentMode !== 'lab') return;
            
            const mixerValue = document.getElementById('mixerVolume').value;
            const rotorInput = document.getElementById('rotorSpeed');
            const fillFactorRow = document.getElementById('fillFactorRow');
            const mixInitTempInput = document.getElementById('mixInitTemp');
            
            if (mixerValue === '0') {
                // ÈõôÊªæÁ≠í: ÁÑ°ËΩâÈÄüË®≠ÂÆö, ÁÑ°Â°´ÂÖÖ‰øÇÊï∏, Ëí∏Ê±ΩÈ†êÁÜ±110¬∞C
                rotorInput.value = '';
                rotorInput.disabled = true;
                rotorInput.placeholder = '-';
                fillFactorRow.style.display = 'none';
                mixInitTempInput.value = '110';  // v7.5.1: ÈõôÊªæÁ≠íËí∏Ê±ΩÈ†êÁÜ±Ê∫´Â∫¶
            } else {
                // ÂØÜÁÖâÊ©ü 1L: ÂèØË™øËΩâÈÄü, ÊúâÂ°´ÂÖÖ‰øÇÊï∏, ÂÆ§Ê∫´ÈñãÂßã
                rotorInput.disabled = false;
                rotorInput.value = '';
                rotorInput.placeholder = '';
                fillFactorRow.style.display = '';
                mixInitTempInput.value = '30';  // v7.5.1: ÂØÜÁÖâÊ©üÂÆ§Ê∫´
            }
        }
        
        function clearAllInputs() {
            // Ê∏ÖÁ©∫ÊâÄÊúâÊï∏ÂÄºËº∏ÂÖ•
            const inputs = document.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                if (input.id !== 'eva16va' && input.id !== 'eva25va' && input.id !== 'mixInitTemp' && input.id !== 'totalResinWeight') {
                    input.value = '';
                }
            });
            // Ê∏ÖÁ©∫ÊñáÂ≠óËº∏ÂÖ•
            document.getElementById('productModel').value = '';
            document.getElementById('batchId').value = '';
            document.getElementById('productionDate').valueAsDate = new Date();
            
            // v7.4: ÈáçÁΩÆ Lab phr Ê®°Âºè
            if (currentMode === 'lab') {
                labInputMode = 'weight';
                updateLabUnitUI();
            }
            
            // v7.4.2: Ê∏ÖÈô§ phr È†êË¶Ω
            updatePhrPreview();
        }
        
        // ==================== v7.4.2: Âç≥ÊôÇ phr È†êË¶Ω ====================
        function updatePhrPreview() {
            // Âè™Âú® Lab Mode + phr Ê®°Âºè‰∏ãÈ°ØÁ§∫
            const previewPanel = document.getElementById('phrPreviewPanel');
            if (currentMode !== 'lab' || labInputMode !== 'phr') {
                previewPanel.style.display = 'none';
                return;
            }
            
            previewPanel.style.display = 'block';
            
            // ÂèñÂæóËº∏ÂÖ•ÂÄº (phr)
            const acpePhr = parseFloat(document.getElementById('acpe').value) || 0;
            const acevaPhr = parseFloat(document.getElementById('aceva').value) || 0;
            const redpPhr = parseFloat(document.getElementById('redp').value) || 0;
            const brsbPhr = parseFloat(document.getElementById('brsb').value) || 0;
            const fillerPhr = parseFloat(document.getElementById('filler').value) || 0;
            const colorPhr = parseFloat(document.getElementById('color').value) || 0;
            const athPhr = parseFloat(document.getElementById('ath').value) || 0;
            const cp70Phr = parseFloat(document.getElementById('cp70').value) || 0;
            
            // ÊØçÁ≤íÊãÜËß£ÊØî‰æã
            const actualAC = acpePhr * 0.5 + acevaPhr * 0.5;
            const actualRedP = redpPhr * 0.5;
            const actualBr = brsbPhr * 0.5;
            const actualSb = brsbPhr * 0.167;
            const actualTalc = fillerPhr * 0.5;
            const actualCaCO3 = fillerPhr * 0.3;
            const actualPigment = colorPhr * 0.7;
            const actualATH = athPhr;
            const actualCP70 = cp70Phr;
            
            // ÁîüÊàêÈ†êË¶ΩÂÖßÂÆπ - ÂàÜÈ°ûÈ°ØÁ§∫
            let html = '';
            
            // AC Á≥ªÁµ±
            if (actualAC > 0) {
                html += `<div style="margin-bottom:6px;">
                    <span style="color:#8cf; font-weight:bold;">Blowing Agent:</span>
                    <span style="background:rgba(100,150,200,0.3); padding:2px 6px; border-radius:3px; margin-left:5px;">AC: ${actualAC.toFixed(2)} phr</span>
                </div>`;
            }
            
            // Â°´ÊñôÁ≥ªÁµ±
            if (actualTalc > 0 || actualCaCO3 > 0) {
                html += `<div style="margin-bottom:6px;">
                    <span style="color:#9cf; font-weight:bold;">Filler:</span>`;
                if (actualTalc > 0) html += `<span style="background:rgba(120,140,160,0.3); padding:2px 6px; border-radius:3px; margin-left:5px;">Talc: ${actualTalc.toFixed(2)} phr</span>`;
                if (actualCaCO3 > 0) html += `<span style="background:rgba(140,140,140,0.3); padding:2px 6px; border-radius:3px; margin-left:5px;">CaCO‚ÇÉ: ${actualCaCO3.toFixed(2)} phr</span>`;
                html += `</div>`;
            }
            
            // Ëâ≤ÊØç
            if (actualPigment > 0) {
                html += `<div style="margin-bottom:6px;">
                    <span style="color:#fc9; font-weight:bold;">Pigment:</span>
                    <span style="background:rgba(200,150,100,0.3); padding:2px 6px; border-radius:3px; margin-left:5px;">${actualPigment.toFixed(2)} phr</span>
                </div>`;
            }
            
            // ÈòªÁáÉÂäëÁ≥ªÁµ± - Ë©≥Á¥∞ÊãÜÂàÜ
            const frItems = [];
            if (actualRedP > 0) frItems.push(`<span style="background:rgba(200,80,80,0.3); padding:2px 6px; border-radius:3px;">RedP: ${actualRedP.toFixed(2)} phr</span>`);
            if (actualBr > 0) frItems.push(`<span style="background:rgba(200,120,80,0.3); padding:2px 6px; border-radius:3px;">Br: ${actualBr.toFixed(2)} phr</span>`);
            if (actualSb > 0) frItems.push(`<span style="background:rgba(180,140,80,0.3); padding:2px 6px; border-radius:3px;">Sb‚ÇÇO‚ÇÉ: ${actualSb.toFixed(2)} phr</span>`);
            if (actualATH > 0) frItems.push(`<span style="background:rgba(150,100,150,0.3); padding:2px 6px; border-radius:3px;">ATH: ${actualATH.toFixed(2)} phr</span>`);
            if (actualCP70 > 0) frItems.push(`<span style="background:rgba(100,150,100,0.3); padding:2px 6px; border-radius:3px;">CP-70: ${actualCP70.toFixed(2)} phr</span>`);
            
            if (frItems.length > 0) {
                const totalFR = actualRedP + actualBr + actualSb + actualATH + actualCP70;
                html += `<div style="margin-bottom:6px; padding:8px; background:rgba(200,80,80,0.1); border-radius:4px; border:1px solid rgba(200,80,80,0.3);">
                    <span style="color:#f99; font-weight:bold;">üî• Flame Retardant System:</span><br>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:5px;">
                        ${frItems.join('')}
                    </div>
                    <div style="margin-top:6px; padding-top:6px; border-top:1px solid rgba(200,80,80,0.3);">
                        <span style="color:#faa; font-weight:bold;">Total FR: ${totalFR.toFixed(2)} phr</span>
                    </div>
                </div>`;
            }
            
            document.getElementById('phrPreviewContent').innerHTML = html || '<span style="color:#777;">Enter values to see actual component phr...</span>';
        }
        
        // ==================== Ë®àÁÆóÂáΩÊï∏ ====================
        function calculate() {
            // Ê∏ÖÈô§‰∏ä‰∏ÄÊ¨°ÁöÑË≠¶Á§∫„ÄÅÂª∫Ë≠∞ÂíåÂπ≥Ë°°ÊèêÁ§∫ÂçÄÂ°ä
            const resultsDiv = document.getElementById('results');
            const oldWarnings = resultsDiv.querySelectorAll('.input-section[style*="rgba(140, 80, 80"]');
            oldWarnings.forEach(el => el.remove());
            const oldSuggestions = resultsDiv.querySelectorAll('.input-section[style*="rgba(80, 120, 100"]');
            oldSuggestions.forEach(el => el.remove());
            const oldBalance = resultsDiv.querySelectorAll('.input-section[style*="rgba(80, 100, 140"]');
            oldBalance.forEach(el => el.remove());
            
            try {
                // v7.3.6: Ê†πÊìöÊ®°ÂºèË™øÊï¥ÂñÆ‰ΩçÊèõÁÆó
                const isLabMode = (currentMode === 'lab');
                
                // v7.4: Lab Mode phr Ëº∏ÂÖ•ËôïÁêÜ
                let resinDivisor, mbDivisor, additiveDivisor;
                
                if (isLabMode && labInputMode === 'phr') {
                    // phr Ê®°ÂºèÔºöÈúÄË¶ÅÂÖàËΩâÊèõÊàêÈáçÈáè (g)ÔºåÂÜçËΩâÊàê kg
                    const totalResinG = parseFloat(document.getElementById('totalResinWeight').value) || 200;
                    
                    // ÂèñÂæóÊØçÁ≤í phr ÂÄº
                    const acpePhr = parseFloat(document.getElementById('acpe').value) || 0;
                    const acevaPhr = parseFloat(document.getElementById('aceva').value) || 0;
                    const fillerPhr = parseFloat(document.getElementById('filler').value) || 0;
                    const colorPhr = parseFloat(document.getElementById('color').value) || 0;
                    const brsbPhr = parseFloat(document.getElementById('brsb').value) || 0;
                    const redpPhr = parseFloat(document.getElementById('redp').value) || 0;
                    
                    // Ë®àÁÆóÊ®πËÑÇ phr Á∏ΩÂíå‰∏¶Ê≠£Ë¶èÂåñ
                    const resinFields = ['eva16', 'eva25', 'ldpe24', 'ldpe40', 'poe'];
                    let resinPhrSum = 0;
                    resinFields.forEach(id => {
                        resinPhrSum += parseFloat(document.getElementById(id).value) || 0;
                    });
                    
                    // v7.5: Á∏ΩÊ®πËÑÇÂü∫Ê∫ñËôïÁêÜ
                    let actualEva16Phr, actualEva25Phr, actualLdpe24Phr, actualLdpe40Phr, actualPoePhr;
                    
                    if (phrBasis === 'total') {
                        // Á∏ΩÊ®πËÑÇÂü∫Ê∫ñÔºöÊØçÁ≤íËºâÈ´îÊúÉÂæûÁ¥îÊ®πËÑÇ‰∏≠Êâ£Èô§
                        // Ë®àÁÆóÊØçÁ≤í‰∏≠ÁöÑËºâÈ´îÊ®πËÑÇ
                        const peFromMB = acpePhr * 0.5;  // AC-PE MB: 50% PE
                        const evaFromMB = acevaPhr * 0.5 + fillerPhr * 0.25 + colorPhr * 0.63 + brsbPhr * 0.48 + redpPhr * 0.5;
                        const totalCarrierPhr = peFromMB + evaFromMB;
                        
                        // Á¥îÊ®πËÑÇ phr = 100 - ÊØçÁ≤íËºâÈ´î phr
                        const pureResinPhr = Math.max(0, 100 - totalCarrierPhr);
                        
                        // ‰ΩøÁî®ËÄÖËº∏ÂÖ•ÁöÑÊòØ„ÄåÁõÆÊ®ôÊØî‰æã„ÄçÔºåÈúÄË¶ÅË™øÊï¥
                        const eva16Ratio = parseFloat(document.getElementById('eva16').value) || 0;
                        const eva25Ratio = parseFloat(document.getElementById('eva25').value) || 0;
                        const ldpe24Ratio = parseFloat(document.getElementById('ldpe24').value) || 0;
                        const ldpe40Ratio = parseFloat(document.getElementById('ldpe40').value) || 0;
                        const poeRatio = parseFloat(document.getElementById('poe').value) || 0;
                        const totalRatio = eva16Ratio + eva25Ratio + ldpe24Ratio + ldpe40Ratio + poeRatio;
                        
                        if (totalRatio > 0) {
                            // Ë®àÁÆóÁõÆÊ®ôÊ®πËÑÇ phr (ÊåâÊØî‰æãÂàÜÈÖç 100 phr)
                            const evaTargetPhr = (eva16Ratio + eva25Ratio) / totalRatio * 100;
                            const ldpeTargetPhr = (ldpe24Ratio + ldpe40Ratio) / totalRatio * 100;
                            const poeTargetPhr = poeRatio / totalRatio * 100;
                            
                            // Êâ£Èô§ÊØçÁ≤íËºâÈ´îÂæåÁöÑÁ¥îÊ®πËÑÇËº∏ÂÖ•
                            const evaInputPhr = Math.max(0, evaTargetPhr - evaFromMB);
                            const ldpeInputPhr = Math.max(0, ldpeTargetPhr - peFromMB);
                            
                            // ÊåâÂéüÂßãÊØî‰æãÂàÜÈÖç
                            const eva16InputPhr = (eva16Ratio + eva25Ratio) > 0 ? eva16Ratio / (eva16Ratio + eva25Ratio) * evaInputPhr : 0;
                            const eva25InputPhr = (eva16Ratio + eva25Ratio) > 0 ? eva25Ratio / (eva16Ratio + eva25Ratio) * evaInputPhr : 0;
                            const ldpe24InputPhr = (ldpe24Ratio + ldpe40Ratio) > 0 ? ldpe24Ratio / (ldpe24Ratio + ldpe40Ratio) * ldpeInputPhr : 0;
                            const ldpe40InputPhr = (ldpe24Ratio + ldpe40Ratio) > 0 ? ldpe40Ratio / (ldpe24Ratio + ldpe40Ratio) * ldpeInputPhr : 0;
                            
                            actualEva16Phr = eva16InputPhr;
                            actualEva25Phr = eva25InputPhr;
                            actualLdpe24Phr = ldpe24InputPhr;
                            actualLdpe40Phr = ldpe40InputPhr;
                            actualPoePhr = poeTargetPhr;
                        } else {
                            actualEva16Phr = actualEva25Phr = actualLdpe24Phr = actualLdpe40Phr = actualPoePhr = 0;
                        }
                    } else {
                        // Á¥îÊ®πËÑÇÂü∫Ê∫ñÔºöÁõ¥Êé•‰ΩøÁî®‰ΩøÁî®ËÄÖËº∏ÂÖ•ÔºåÊ≠£Ë¶èÂåñÂà∞ 100 phr
                        const normFactor = resinPhrSum > 0 ? 100 / resinPhrSum : 1;
                        actualEva16Phr = (parseFloat(document.getElementById('eva16').value) || 0) * normFactor;
                        actualEva25Phr = (parseFloat(document.getElementById('eva25').value) || 0) * normFactor;
                        actualLdpe24Phr = (parseFloat(document.getElementById('ldpe24').value) || 0) * normFactor;
                        actualLdpe40Phr = (parseFloat(document.getElementById('ldpe40').value) || 0) * normFactor;
                        actualPoePhr = (parseFloat(document.getElementById('poe').value) || 0) * normFactor;
                    }
                    
                    // phr ‚Üí kg ÁöÑËΩâÊèõÂáΩÊï∏
                    const phrToKg = (phr) => {
                        return (phr / 100) * totalResinG / 1000;  // g ‚Üí kg
                    };
                    
                    // Áõ¥Êé•Ë®àÁÆóÂêÑÂéüÊñôÁöÑ kg ÂÄº
                    var eva16 = phrToKg(actualEva16Phr);
                    var eva25 = phrToKg(actualEva25Phr);
                    var ldpe24 = phrToKg(actualLdpe24Phr);
                    var ldpe40 = phrToKg(actualLdpe40Phr);
                    var poe = phrToKg(actualPoePhr);
                    var acpe = phrToKg(acpePhr);
                    var aceva = phrToKg(acevaPhr);
                    var redp = phrToKg(redpPhr);
                    var brsb = phrToKg(brsbPhr);
                    var filler = phrToKg(fillerPhr);
                    var color = phrToKg(colorPhr);
                    var ath = phrToKg(parseFloat(document.getElementById('ath').value) || 0);
                    var cp70 = phrToKg(parseFloat(document.getElementById('cp70').value) || 0);
                    var dcp = phrToKg(parseFloat(document.getElementById('dcp').value) || 0);
                    var bht = phrToKg(parseFloat(document.getElementById('bht').value) || 0);
                    var zno = phrToKg(parseFloat(document.getElementById('zno').value) || 0);
                    var urea = phrToKg(parseFloat(document.getElementById('urea').value) || 0);
                    var powder = phrToKg(parseFloat(document.getElementById('powder').value) || 0);
                } else {
                    // ÂéüÊú¨ÁöÑÈáçÈáèÊ®°Âºè
                    resinDivisor = isLabMode ? 1000 : 1;  // Lab: g->kg, Prod: kg->kg
                    mbDivisor = isLabMode ? 1000 : 1;
                    additiveDivisor = 1000;  // ÂÖ©Á®ÆÊ®°ÂºèÂ∞èÊñôÈÉΩÊòØ g
                    
                    var eva16 = (parseFloat(document.getElementById('eva16').value) || 0) / resinDivisor;
                    var eva25 = (parseFloat(document.getElementById('eva25').value) || 0) / resinDivisor;
                    var ldpe24 = (parseFloat(document.getElementById('ldpe24').value) || 0) / resinDivisor;
                    var ldpe40 = (parseFloat(document.getElementById('ldpe40').value) || 0) / resinDivisor;
                    var poe = (parseFloat(document.getElementById('poe').value) || 0) / resinDivisor;
                    var acpe = (parseFloat(document.getElementById('acpe').value) || 0) / mbDivisor;
                    var aceva = (parseFloat(document.getElementById('aceva').value) || 0) / mbDivisor;
                    var redp = (parseFloat(document.getElementById('redp').value) || 0) / mbDivisor;
                    var brsb = (parseFloat(document.getElementById('brsb').value) || 0) / mbDivisor;
                    var filler = (parseFloat(document.getElementById('filler').value) || 0) / mbDivisor;
                    var color = (parseFloat(document.getElementById('color').value) || 0) / mbDivisor;
                    var ath = (parseFloat(document.getElementById('ath').value) || 0) / (isLabMode ? 1000 : 1);
                    var cp70 = (parseFloat(document.getElementById('cp70').value) || 0) / (isLabMode ? 1000 : 1);
                    var dcp = (parseFloat(document.getElementById('dcp').value) || 0) / additiveDivisor;
                    var bht = (parseFloat(document.getElementById('bht').value) || 0) / additiveDivisor;
                    var zno = (parseFloat(document.getElementById('zno').value) || 0) / additiveDivisor;
                    var urea = (parseFloat(document.getElementById('urea').value) || 0) / additiveDivisor;
                    var powder = (parseFloat(document.getElementById('powder').value) || 0) / additiveDivisor;
                }
                
                const eva16va = parseFloat(document.getElementById('eva16va').value) || 16;
                const eva25va = parseFloat(document.getElementById('eva25va').value) || 25;
                const temp1 = parseFloat(document.getElementById('temp1').value) || 0;
                const time1 = parseFloat(document.getElementById('time1').value) || 0;
                const temp2 = parseFloat(document.getElementById('temp2').value) || 0;
                const time2 = parseFloat(document.getElementById('time2').value) || 0;
                
                // v7.3.6: Ê∑∑Á∑¥ÂèÉÊï∏ÔºàËôïÁêÜLabÊ®°ÂºèÂíåÈõôÊªæÁ≠íÔºâ
                const mixTime = parseFloat(document.getElementById('mixTime').value) || 18;
                const mixerVolumeRaw = document.getElementById('mixerVolume').value;
                const isTwoRollMill = (currentMode === 'lab' && mixerVolumeRaw === '0');
                const rotorSpeed = isTwoRollMill ? 40 : (parseFloat(document.getElementById('rotorSpeed').value) || 55);
                const mixInitTemp = parseFloat(document.getElementById('mixInitTemp').value) || 55;
                const dosageTemp = parseFloat(document.getElementById('dosageTemp').value) || 85;
                const dischargeTempInput = document.getElementById('dischargeTemp').value;
                const mixerVolume = isTwoRollMill ? 0 : (parseFloat(mixerVolumeRaw) || 75);
                
                // v7.3.6: ÊñôÂ∞æËôïÁêÜÔºàLabÊ®°ÂºèÂñÆ‰ΩçÊòØgÔºåÈúÄËΩâÊèõÔºâ
                const tailMaterialRaw = parseFloat(document.getElementById('tailMaterial').value) || 0;
                const tailMaterial = isLabMode ? tailMaterialRaw / 1000 : tailMaterialRaw;  // ËΩâÊàêkg
                
                // v7.3.5: Ë®àÁÆóÈÖçÊñπÁ∏ΩÈáç (kg) - ‰∏çÂê´ÊñôÂ∞æ
                const formulaWeight = eva16 + eva25 + ldpe24 + ldpe40 + poe + acpe + aceva + 
                                   redp + brsb + filler + color + ath + cp70 + 
                                   dcp + bht + zno + urea + powder;
                
                // v7.3.5: ÊñôÂ∞æÊØî‰æãÂíåÂØ¶ÈöõÁ∏ΩÈáç
                const tailRatio = formulaWeight > 0 ? (tailMaterial / formulaWeight) * 100 : 0;
                const totalWeight = formulaWeight + tailMaterial;  // ÂØ¶ÈöõÁ∏ΩÈáç = ÈÖçÊñπ + ÊñôÂ∞æ
                
                // v7.3.4: Ë®àÁÆóÁêÜË´ñÂØÜÂ∫¶ (g/cm¬≥) - Âä†Ê¨äÂπ≥Âùá
                // ÂêÑÊàêÂàÜÂØÜÂ∫¶
                const componentDensities = {
                    eva: 0.94, ldpe: 0.93, poe: 0.87,
                    acpe: 1.20, aceva: 1.18,  // ACÊØçÁ≤í (ACÂØÜÂ∫¶~1.65 + ËºâÈ´î)
                    redp: 1.80,  // Á¥ÖÁ£∑ÊØçÁ≤í
                    brsb: 2.50,  // Br+SbÊØçÁ≤í
                    filler: 1.80, // Â°´ÊñôÊØçÁ≤í (Talc+CaCO3+ËºâÈ´î)
                    color: 1.30,  // Ëâ≤ÊØç
                    ath: 2.40,
                    cp70: 1.50,   // Ê∞ØÂåñÁü≥Ë†ü
                    dcp: 1.02,
                    bht: 1.03,
                    zno: 5.60,
                    urea: 1.32,
                    powder: 2.70  //ite calcium
                };
                
                const weightedDensitySum = 
                    (eva16 + eva25) * componentDensities.eva +
                    (ldpe24 + ldpe40) * componentDensities.ldpe +
                    poe * componentDensities.poe +
                    acpe * componentDensities.acpe +
                    aceva * componentDensities.aceva +
                    redp * componentDensities.redp +
                    brsb * componentDensities.brsb +
                    filler * componentDensities.filler +
                    color * componentDensities.color +
                    ath * componentDensities.ath +
                    cp70 * componentDensities.cp70 +
                    dcp * componentDensities.dcp +
                    bht * componentDensities.bht +
                    zno * componentDensities.zno +
                    urea * componentDensities.urea +
                    powder * componentDensities.powder;
                
                // ÁêÜË´ñÂØÜÂ∫¶ÔºàÊñôÂ∞æÂØÜÂ∫¶ËàáÈÖçÊñπÁõ∏ÂêåÔºâ
                const theoreticalDensityMix = formulaWeight > 0 ? weightedDensitySum / formulaWeight : 1.0;
                
                // v7.3.6: Ë®àÁÆóÁêÜË´ñÈ´îÁ©ç (L) ÂíåÂ°´ÂÖÖ‰øÇÊï∏ - ‰ΩøÁî®ÂØ¶ÈöõÁ∏ΩÈáç
                // ÈõôÊªæÁ≠íÊôÇ‰∏çË®àÁÆóÂ°´ÂÖÖ‰øÇÊï∏
                const theoreticalVolume = totalWeight / theoreticalDensityMix;  // L
                const fillFactor = isTwoRollMill ? 0 : (theoreticalVolume / mixerVolume);
                
                // v7.3.6: Êõ¥Êñ∞È°ØÁ§∫ÔºàÊ†πÊìöÊ®°ÂºèË™øÊï¥ÂñÆ‰ΩçÈ°ØÁ§∫Ôºâ
                if (isLabMode) {
                    // LabÊ®°ÂºèÈ°ØÁ§∫g
                    document.getElementById('displayFormulaWeight').innerHTML = (formulaWeight * 1000).toFixed(1) + ' <span id="unitFormulaWeight">g</span>';
                    document.getElementById('displayTotalWeight').innerHTML = (totalWeight * 1000).toFixed(1) + ' <span id="unitTotalWeight">g</span>';
                } else {
                    // ÁîüÁî¢Ê®°ÂºèÈ°ØÁ§∫kg
                    document.getElementById('displayFormulaWeight').innerHTML = formulaWeight.toFixed(2) + ' <span id="unitFormulaWeight">kg</span>';
                    document.getElementById('displayTotalWeight').innerHTML = totalWeight.toFixed(2) + ' <span id="unitTotalWeight">kg</span>';
                }
                document.getElementById('displayTailRatio').textContent = tailRatio.toFixed(1) + ' %';
                document.getElementById('displayTheoDensity').textContent = theoreticalDensityMix.toFixed(3) + ' g/cm¬≥';
                document.getElementById('displayTheoVolume').textContent = theoreticalVolume.toFixed(3) + ' L';
                
                if (isTwoRollMill) {
                    document.getElementById('displayFillFactor').innerHTML = '<span style="color: #888;">N/A</span>';
                } else {
                    const fillFactorColor = fillFactor >= 0.85 && fillFactor <= 1.15 ? '#8c8' : 
                                            fillFactor >= 0.75 && fillFactor <= 1.25 ? '#cc9' : '#c77';
                    document.getElementById('displayFillFactor').innerHTML = `<span style="color: ${fillFactorColor};">${fillFactor.toFixed(3)}</span>`;
                }
                
                // Êõ¥Êñ∞Èö±ËóèÁöÑfillFactorÊ¨Ñ‰Ωç
                document.getElementById('fillFactor').value = fillFactor;
                
                // ==================== ÊØçÁ≤íÊãÜËß£ ====================
                const acFromPE = acpe * 0.5;
                const ldpeFromAC = acpe * 0.5;
                const acFromEVA = aceva * 0.5;
                const evaFromACMB = aceva * 0.5;
                const redPhos = redp * 0.5;
                const evaFromRedP = redp * 0.5;
                const sb = brsb * 0.13;
                const br = brsb * 0.39;
                const evaFromBrSb = brsb * 0.48;
                const talc = filler * 0.375;
                const caco3 = filler * 0.375;
                const evaFromFiller = filler * 0.25;
                const pigment = color * 0.37;
                const evaFromColor = color * 0.63;
                
                // Á∏ΩÊ®πËÑÇË®àÁÆó
                const totalEVA16 = eva16 + evaFromRedP + evaFromBrSb + evaFromFiller + evaFromColor + evaFromACMB;
                const totalEVA25 = eva25;
                const totalEVA = totalEVA16 + totalEVA25;
                const totalLDPE = ldpe24 + ldpe40 + ldpeFromAC;
                const totalPOE = poe;
                const totalResin = totalEVA + totalLDPE + totalPOE;
                const totalAC = acFromPE + acFromEVA;
                
                if (totalResin === 0) {
                    alert('ÈåØË™§: Á∏ΩÊ®πËÑÇÈáèÁÇ∫0ÔºåË´ãÊ™¢Êü•Ëº∏ÂÖ•Êï∏ÊìöÔºÅ');
                    return;
                }
                
                // ==================== phrË®àÁÆó ====================
                const eva16_phr = (totalEVA16 / totalResin) * 100;
                const eva25_phr = (totalEVA25 / totalResin) * 100;
                const ldpe_phr = (totalLDPE / totalResin) * 100;
                const poe_phr = (totalPOE / totalResin) * 100;
                const ac_phr = (totalAC / totalResin) * 100;
                const dcp_phr = (dcp / totalResin) * 100;
                const bht_phr = (bht / totalResin) * 100; // BHT phr
                const urea_phr = (urea / totalResin) * 100;
                const zno_phr = (zno / totalResin) * 100;
                const powder_phr = (powder / totalResin) * 100;
                const pigment_phr = (pigment / totalResin) * 100;
                const talc_phr = (talc / totalResin) * 100;
                const caco3_phr = (caco3 / totalResin) * 100;
                const ath_phr = (ath / totalResin) * 100;
                const redPhos_phr = (redPhos / totalResin) * 100;
                const sb_phr = (sb / totalResin) * 100;
                const br_phr = (br / totalResin) * 100;
                const cp70_phr = (cp70 / totalResin) * 100;
                
                // ==================== Êñ∞Â¢û: ÂàÜÈõ¢Ë®àÁÆó - ÁÑ°Ê©üÂ°´Êñô vs ÈòªÁáÉÂäë vs Ëâ≤Á≤â ====================
                // ÁÑ°Ê©üÂ°´Êñô (Inorganic Fillers): Talc, CaCO3, Powder - ÂÖ∑ÊúâÊàêÊ†∏ÊïàÊûú
                // Ê≥®ÊÑè: Ëâ≤Á≤â(Pigment)Â∑≤ÁßªÈô§ÔºåÂõ†ÁÇ∫ÈÉ®ÂàÜËâ≤Á≤âÁÇ∫ÊúâÊ©üÊùêË≥™Ôºå‰∏çÂÖ∑ÊàêÊ†∏ÊïàÊûú
                const inorganicFiller_phr = talc_phr + caco3_phr + powder_phr;
                
                // Ëâ≤Á≤â (Pigment) - Áç®Á´ãË®àÁÆóÔºå‰∏çÂèÉËàáÊàêÊ†∏ÊïàÊáâ
                const pigment_phr_separate = pigment_phr;
                
                // ÈòªÁáÉÂäë (Flame Retardants): ATH, Red Phosphorus, Br, Sb, CP-70
                const flameRetardant_phr = ath_phr + redPhos_phr + br_phr + sb_phr + cp70_phr;
                
                // Á∏ΩÁ≤âÈ´î (ÂåÖÂê´Ëâ≤Á≤âÔºåÁî®ÊñºÈªèÂ∫¶Ë®àÁÆóÁ≠â)
                const totalPowder_phr = inorganicFiller_phr + flameRetardant_phr + pigment_phr_separate;
                
                // ==================== ÁÑ°Ê©üÂ°´ÊñôÊïàÊáâË®àÁÆó (ÊñáÁçª‰æùÊìö) ====================
                // ÂèÉËÄÉ: MDPI Polymers 2023, ScienceDirect 2022
                // ÁÑ°Ê©üÂ°´ÊñôÔºàCaCO3+TalcÔºâ5-20 phrÁÇ∫ÊúÄ‰Ω≥ÁØÑÂúç
                // MBÁµÑÊàê: 37.5% CaCO3 + 37.5% Talc + 25% EVAÔºåÊúâÊïàÁÑ°Ê©üÂ°´Êñô75%
                function calcInorganicFillerEffect(filler_phr) {
                    let foamSuppression = 1.0;
                    let cellNucleation = 1.0;
                    let mechanicalBoost = 1.0;
                    let status = 'optimal';
                    let warning = null;
                    let suggestion = null;
                    
                    if (filler_phr < 5) {
                        // ‰∏çË∂≥ÁØÑÂúç: ÊàêÊ†∏ÊïàÊûúÊúâÈôê
                        foamSuppression = 1 + filler_phr * 0.003;
                        cellNucleation = 1 + filler_phr * 0.015;
                        mechanicalBoost = 1 + filler_phr * 0.01;
                        status = 'low';
                        suggestion = `ÁÑ°Ê©üÂ°´ÊñôÂÅè‰Ωé(${filler_phr.toFixed(1)} phr)ÔºåÊàêÊ†∏ÊïàÊûúÊúâÈôêÔºåÂª∫Ë≠∞5-20 phr`;
                    } else if (filler_phr <= 20) {
                        // ÊúÄ‰Ω≥ÁØÑÂúç (5-20 phr)
                        foamSuppression = 1.015 + (filler_phr - 5) * 0.004;
                        cellNucleation = 1.075 + (filler_phr - 5) * 0.015;
                        mechanicalBoost = 1.05 + (filler_phr - 5) * 0.012;
                        status = 'optimal';
                    } else if (filler_phr <= 30) {
                        // Ë≠¶ÂëäÁØÑÂúç (20-30 phr)
                        foamSuppression = 1.075 + (filler_phr - 20) * 0.015;
                        cellNucleation = 1.3;
                        mechanicalBoost = 1.23;
                        status = 'warning';
                        warning = `[Ë≠¶Âëä] ÁÑ°Ê©üÂ°´ÊñôÂÅèÈ´ò(${filler_phr.toFixed(1)} phr > 20)ÔºåÁôºÊ≥°ÂÄçÁéáÂèØËÉΩ‰∏ãÈôç`;
                    } else {
                        // Âö¥ÈáçË≠¶Âëä (> 30 phr)
                        foamSuppression = 1.225 + (filler_phr - 30) * 0.02;
                        cellNucleation = 1.25;
                        mechanicalBoost = 1.18;
                        status = 'critical';
                        warning = `[Âö¥Èáç] ÁÑ°Ê©üÂ°´ÊñôÈÅéÈ´ò(${filler_phr.toFixed(1)} phr)ÔºåÂö¥ÈáçÊäëÂà∂ÁôºÊ≥°ÔºÅÂª∫Ë≠∞ 5-20 phr`;
                    }
                    
                    return {
                        foamSuppression,
                        cellNucleation,
                        mechanicalBoost,
                        status,
                        warning,
                        suggestion,
                        optimalRange: filler_phr >= 5 && filler_phr <= 20
                    };
                }
                
                // ==================== ÈòªÁáÉÂäëÊïàÊáâË®àÁÆó (ÊñáÁçª‰æùÊìö) ====================
                // ÂèÉËÄÉ: MDPI Molecules 2023, ScienceDirect 2021, Iranian Polymer Journal 2012
                function calcFlameRetardantEffect(ath_phr, redPhos_phr, br_phr, sb_phr, cp70_phr, dcp_phr) {
                    let totalFR = ath_phr + redPhos_phr + br_phr + sb_phr + cp70_phr;
                    let crosslinkInterference = 1.0;
                    let foamSuppression = 1.0;
                    let flameRetardancy = 0;
                    let warnings = [];
                    let suggestions = [];
                    
                    // ATH ÊïàÊáâ (ÈúÄË¶ÅÈ´òÊ∑ªÂä†Èáè 40-60 phr ÊâçÊúâÊïà)
                    // Â∞ç‰∫§ËÅØÂΩ±ÈüøÂ∞èÔºå‰ΩÜÊúÉÂ¢ûÂä†ÂØÜÂ∫¶
                    let athEffect = {
                        crosslinkFactor: 1.0,
                        foamFactor: 1 + ath_phr * 0.01,
                        efficiency: 0,
                        status: 'optimal',
                        warning: null
                    };
                    
                    if (ath_phr > 0) {
                        if (ath_phr < 20) {
                            athEffect.efficiency = ath_phr * 1.5; // ‰ΩéÊïàÁéá
                            athEffect.status = 'low';
                            suggestions.push(`ATH amount low (${ath_phr.toFixed(1)} phr), limited FR effect, suggest 40-60 phr or combine with other FR`);
                        } else if (ath_phr <= 60) {
                            athEffect.efficiency = 30 + (ath_phr - 20) * 1.75;
                            athEffect.status = 'optimal';
                        } else {
                            athEffect.efficiency = 100;
                            athEffect.foamFactor = 1.6 + (ath_phr - 60) * 0.015;
                            athEffect.status = 'high';
                            warnings.push(`[Ë≠¶Âëä] ATH excessive (${ath_phr.toFixed(1)} phr), will significantly increase density`);
                        }
                    }
                    
                    // Á¥ÖÁ£∑ÊïàÊáâ (2.5-10 phr ÊúÄ‰Ω≥)
                    // > 10 phr ÊúÉÂΩ±ÈüøÊ©üÊ¢∞ÊÄßËÉΩÂíå‰∫§ËÅØ
                    let rpEffect = {
                        crosslinkFactor: 1.0,
                        foamFactor: 1.0,
                        efficiency: 0,
                        status: 'optimal',
                        warning: null
                    };
                    
                    if (redPhos_phr > 0) {
                        if (redPhos_phr < 2.5) {
                            rpEffect.efficiency = redPhos_phr * 20;
                            rpEffect.status = 'low';
                            suggestions.push(`Red-P low (${redPhos_phr.toFixed(1)} phr), suggest 2.5-10 phr`);
                        } else if (redPhos_phr <= 10) {
                            rpEffect.efficiency = 50 + (redPhos_phr - 2.5) * 6.67;
                            rpEffect.crosslinkFactor = 1 - redPhos_phr * 0.005; // ËºïÂæÆÂΩ±Èüø
                            rpEffect.status = 'optimal';
                        } else if (redPhos_phr <= 15) {
                            rpEffect.efficiency = 100;
                            rpEffect.crosslinkFactor = 0.95 - (redPhos_phr - 10) * 0.015;
                            rpEffect.status = 'warning';
                            warnings.push(`[Ë≠¶Âëä] Red-P high (${redPhos_phr.toFixed(1)} phr), crosslink efficiency reduced to ${(rpEffect.crosslinkFactor * 100).toFixed(0)}%`);
                        } else {
                            rpEffect.efficiency = 100;
                            rpEffect.crosslinkFactor = 0.875 - (redPhos_phr - 15) * 0.02;
                            rpEffect.status = 'critical';
                            warnings.push(`[Âö¥Èáç] Red-P excessive (${redPhos_phr.toFixed(1)} phr > 15), severely affects crosslink and mechanical properties!`);
                        }
                    }
                    
                    // Ê∫¥ÈäªÁ≥ªÁµ±ÊïàÊáâ (Br:Sb = 3:1 Âõ∫ÂÆöÊØî‰æã)
                    // Br+SbÁ∏ΩÈáèÊúÄ‰Ω≥8-20 phr (Âü∫ÊñºBr 6-15 + Sb 2-5)
                    // Ê∫¥ÂåñÁâ©ÊúÉÊçïÊçâËá™Áî±Âü∫ÔºåÂΩ±Èüø DCP ‰∫§ËÅØ
                    let brSbEffect = {
                        crosslinkFactor: 1.0,
                        foamFactor: 1.0,
                        efficiency: 0,
                        synergy: 1.3, // Âõ∫ÂÆö3:1ÊØî‰æãÔºåÂçîÂêåÊïàÊáâ+30%
                        status: 'none',
                        warning: null
                    };
                    
                    if (br_phr > 0 || sb_phr > 0) {
                        const brSbTotal = br_phr + sb_phr;
                        
                        // Br+SbÁ∏ΩÈáèË≠¶Á§∫ (ÊúÄ‰Ω≥8-20 phr)
                        if (brSbTotal > 0 && brSbTotal < 8) {
                            suggestions.push(`Br+Sb amount low (${brSbTotal.toFixed(1)} phr), FR effect limited, suggest 8-20 phr`);
                        } else if (brSbTotal >= 8 && brSbTotal <= 20) {
                            suggestions.push(`Br+Sb amount good (${brSbTotal.toFixed(1)} phr), optimal range 8-20 phr, synergy +30%`);
                        } else if (brSbTotal > 20 && brSbTotal <= 25) {
                            warnings.push(`[Ë≠¶Âëä] Br+Sb amount high (${brSbTotal.toFixed(1)} phr > 20), may affect crosslinking`);
                        } else if (brSbTotal > 25) {
                            warnings.push(`[Âö¥Èáç] Br+Sb excessive (${brSbTotal.toFixed(1)} phr > 25), seriously affects crosslinking!`);
                        }
                        
                        // Ê∫¥ÂåñÁâ©Â∞ç‰∫§ËÅØÁöÑÂΩ±Èüø (ÊçïÊçâËá™Áî±Âü∫)
                        if (br_phr > 5) {
                            brSbEffect.crosslinkFactor = 1 - (br_phr - 5) * 0.01;
                            if (br_phr > 15) {
                                brSbEffect.crosslinkFactor = 0.9 - (br_phr - 15) * 0.015;
                            }
                        }
                        
                        brSbEffect.efficiency = Math.min(100, brSbTotal * 3 * brSbEffect.synergy);
                        brSbEffect.foamFactor = 1 + brSbTotal * 0.008;
                        brSbEffect.status = brSbTotal > 20 ? 'warning' : 'optimal';
                    }
                    
                    // CP-70 ÊïàÊáâ (ÊúÄ‰Ω≥3-7 phr)
                    // Ê∞ØÂåñÁü≥Ë†ü‰ΩúÁÇ∫ÈòªÁáÉÂäëÔºåÈ´òÁî®ÈáèÊúÉÂΩ±Èüø‰∫§ËÅØ
                    let cp70Effect = {
                        crosslinkFactor: 1.0,
                        foamFactor: 1.0,
                        efficiency: 0,
                        status: 'none'
                    };
                    
                    if (cp70_phr > 0) {
                        if (cp70_phr < 3) {
                            // ÂÅè‰Ωé
                            cp70Effect.crosslinkFactor = 1 - cp70_phr * 0.005;
                            cp70Effect.status = 'low';
                            suggestions.push(`CP-70 low (${cp70_phr.toFixed(1)} phr), FR effect limited, suggest 3-7 phr`);
                        } else if (cp70_phr <= 7) {
                            // ÊúÄ‰Ω≥ÁØÑÂúç (3-7 phr)
                            cp70Effect.crosslinkFactor = 0.985 - (cp70_phr - 3) * 0.01;
                            cp70Effect.status = 'optimal';
                        } else if (cp70_phr <= 10) {
                            // ÂÅèÈ´ò (7-10 phr)
                            cp70Effect.crosslinkFactor = 0.945 - (cp70_phr - 7) * 0.015;
                            cp70Effect.status = 'warning';
                            warnings.push(`[Ë≠¶Âëä] CP-70 high (${cp70_phr.toFixed(1)} phr > 7), crosslink efficiency ${(cp70Effect.crosslinkFactor * 100).toFixed(0)}%`);
                        } else {
                            // ÈÅéÈ´ò (> 10 phr)
                            cp70Effect.crosslinkFactor = Math.max(0.65, 0.90 - (cp70_phr - 10) * 0.02);
                            cp70Effect.status = 'critical';
                            warnings.push(`[Âö¥Èáç] CP-70 excessive (${cp70_phr.toFixed(1)} phr > 10), crosslink efficiency ${(cp70Effect.crosslinkFactor * 100).toFixed(0)}%`);
                        }
                        cp70Effect.efficiency = Math.min(100, cp70_phr * 10);
                    }
                    
                    // Á∂úÂêà‰∫§ËÅØÂπ≤Êìæ‰øÇÊï∏
                    crosslinkInterference = athEffect.crosslinkFactor * 
                                           rpEffect.crosslinkFactor * 
                                           brSbEffect.crosslinkFactor * 
                                           cp70Effect.crosslinkFactor;
                    
                    // Á∂úÂêàÁôºÊ≥°ÊäëÂà∂‰øÇÊï∏
                    foamSuppression = athEffect.foamFactor * 
                                     rpEffect.foamFactor * 
                                     brSbEffect.foamFactor * 
                                     cp70Effect.foamFactor;
                    
                    // Á∂úÂêàÈòªÁáÉÊïàÊûú
                    flameRetardancy = Math.min(100, 
                        athEffect.efficiency * 0.4 + 
                        rpEffect.efficiency * 0.3 + 
                        brSbEffect.efficiency * 0.2 + 
                        cp70Effect.efficiency * 0.1
                    );
                    
                    return {
                        crosslinkInterference,
                        foamSuppression,
                        flameRetardancy,
                        athEffect,
                        rpEffect,
                        brSbEffect,
                        cp70Effect,
                        warnings,
                        suggestions,
                        totalFR
                    };
                }
                
                // Ë®àÁÆóÂêÑÊïàÊáâ
                const fillerEffect = calcInorganicFillerEffect(inorganicFiller_phr);
                const frEffect = calcFlameRetardantEffect(ath_phr, redPhos_phr, br_phr, sb_phr, cp70_phr, dcp_phr);
                
                // ==================== ÈóúÈçµÊåáÊ®ô ====================
                // ÊØçÁ≤í‰∏≠EVAËºâÈ´îÂÅáË®≠ÁÇ∫VA16% (Â∏∏Ë¶ãÊØçÁ≤íËºâÈ´î)
                const mbEvaVA = 16;
                const evaFromMB = evaFromRedP + evaFromBrSb + evaFromFiller + evaFromColor + evaFromACMB;
                const weightedVA = (totalEVA > 0) ? 
                    ((eva16 * eva16va + eva25 * eva25va + evaFromMB * mbEvaVA) / totalEVA) : 16;
                const ureaAcRatio = (ac_phr > 0) ? (urea_phr / ac_phr) * 100 : 0;
                const znoAcRatio = (ac_phr > 0) ? (zno_phr / ac_phr) * 100 : 0;
                const acDcpRatio = (dcp_phr > 0) ? ac_phr / dcp_phr : 0;
                const evaLdpeRatio = (totalLDPE > 0) ? totalEVA / totalLDPE : 0;
                
                // ==================== ÊùêÊñôÊØîÈáç ====================
                const density_EVA = 0.937;
                const density_LDPE = 0.923;
                const density_POE = 0.870;
                const density_AC = 1.65;
                const density_ATH = 2.42;
                const density_Talc = 2.80;
                const density_CaCO3 = 2.70;
                const density_RedP = 2.20;
                const density_Sb = 5.20;
                const density_ZnO = 5.60;
                const density_DCP = 1.05;
                const density_Br = 2.50;
                const density_CP70 = 1.16;
                const density_Powder = 2.50;
                const density_Pigment = 2.50;
                
                // Ë®àÁÆóÁêÜË´ñÂØÜÂ∫¶
                const vol_EVA = totalEVA16 / density_EVA;
                const vol_EVA25 = eva25 / density_EVA;
                const vol_LDPE = totalLDPE / density_LDPE;
                const vol_POE = poe / density_POE;
                const vol_AC = totalAC / density_AC;
                const vol_ATH = ath / density_ATH;
                const vol_Talc = talc / density_Talc;
                const vol_CaCO3 = caco3 / density_CaCO3;
                const vol_RedP = redPhos / density_RedP;
                const vol_Sb = sb / density_Sb;
                const vol_Br = br / density_Br;
                const vol_Powder = powder / density_Powder;
                const vol_Pigment = pigment / density_Pigment;
                
                const totalVolume = vol_EVA + vol_EVA25 + vol_LDPE + vol_POE + vol_AC + 
                                   vol_ATH + vol_Talc + vol_CaCO3 + vol_RedP + 
                                   vol_Sb + vol_Br + vol_Powder + vol_Pigment;
                
                const totalMass = totalResin + totalAC + ath + filler*0.75 + 
                                 redPhos + brsb*0.52 + powder + color*0.37;
                
                const theoreticalDensity = totalMass / totalVolume;
                
                // ==================== ZnOÊïàÊáâË®àÁÆó (v7.5 Ê†°Ê≠£Áâà - Âü∫ÊñºÊñáÁçª) ====================
                // ÊñáÁçª: ZnOÂèØÂ∞áACÂàÜËß£Ê∫´Â∫¶Âæû220¬∞CÈôçËá≥170¬∞C (Èôç50¬∞C)ÔºåÁîöËá≥ÈôçËá≥125-150¬∞C
                // ACF06 Âü∫Ê∫ñÂàÜËß£Ê∫´Â∫¶ 203¬∞CÔºåÂØ¶ÈöõÁôºÊ≥°Ê∫´Â∫¶ 140-154¬∞CÔºåÈúÄÈôçÊ∫´ ~50-60¬∞C
                function calcZnOEffect(znoAcRatio_percent, dcp_phr) {
                    // v7.5: Â§ßÂπÖÊèêÂçáÈôçÊ∫´ÊïàÊûú (~2.3ÂÄç)
                    let tempReduction = 0;
                    if (znoAcRatio_percent <= 0.5) {
                        tempReduction = znoAcRatio_percent * 50;  // 0.5% ‚Üí 25¬∞C
                    } else if (znoAcRatio_percent <= 1.0) {
                        tempReduction = 25 + (znoAcRatio_percent - 0.5) * 40;  // 1.0% ‚Üí 45¬∞C
                    } else if (znoAcRatio_percent <= 1.6) {
                        tempReduction = 45 + (znoAcRatio_percent - 1.0) * 18;  // 1.6% ‚Üí 55.8¬∞C
                    } else if (znoAcRatio_percent <= 2.0) {
                        tempReduction = 55.8 + (znoAcRatio_percent - 1.6) * 12;  // 2.0% ‚Üí 60.6¬∞C
                    } else if (znoAcRatio_percent <= 3.0) {
                        tempReduction = 60.6 + (znoAcRatio_percent - 2.0) * 6;  // 3.0% ‚Üí 66.6¬∞C
                    } else {
                        tempReduction = Math.min(66.6 + (znoAcRatio_percent - 3.0) * 2, 75);  // ÊúÄÂ§ß 75¬∞C
                    }
                    
                    let rateMultiplier = 1.0;
                    if (znoAcRatio_percent <= 1) {
                        rateMultiplier = 1 + znoAcRatio_percent * 0.25;
                    } else if (znoAcRatio_percent <= 2) {
                        rateMultiplier = 1.25 + (znoAcRatio_percent - 1) * 0.20;
                    } else if (znoAcRatio_percent <= 4) {
                        rateMultiplier = 1.45 + (znoAcRatio_percent - 2) * 0.10;
                    } else {
                        rateMultiplier = Math.min(1.65, 1.65 + (znoAcRatio_percent - 4) * 0.02);
                    }
                    
                    // Êñ∞Â¢û: ÁãÄÊÖãË©ï‰º∞ÂíåË≠¶Âëä
                    let status = 'optimal';
                    let warning = null;
                    let suggestion = null;
                    
                    if (znoAcRatio_percent < 0.3) {
                        status = 'low';
                        warning = `ZnO/ACÊØîÈÅé‰Ωé(${znoAcRatio_percent.toFixed(2)}%)ÔºåACÂàÜËß£Ê∫´Â∫¶È´òÔºåÁôºÊ≥°ÊïàÁéá‰Ωé`;
                        suggestion = `Âª∫Ë≠∞ZnO/ACÊØîËá≥Â∞ë0.5-1.0%`;
                    } else if (znoAcRatio_percent < 0.8) {
                        status = 'below_optimal';
                        suggestion = `ZnO/ACÊØî${znoAcRatio_percent.toFixed(2)}%ÂÅè‰ΩéÔºåÂèØÈÅ©Â∫¶Â¢ûÂä†`;
                    } else if (znoAcRatio_percent > 2.5) {
                        status = 'critical';
                        warning = `[Ë≠¶Âëä] ZnO/ACÊØîÈÅéÈ´ò(${znoAcRatio_percent.toFixed(2)}%)ÔºåÁôºÊ≥°ÂèçÊáâÂäáÁÉàÔºåÈúÄÁ¢∫‰øùDCP‰∫§ËÅØË∂≥Â§†`;
                    } else if (znoAcRatio_percent > 2.0) {
                        status = 'high';
                        warning = `ZnO/ACÊØîÂÅèÈ´ò(${znoAcRatio_percent.toFixed(2)}%)ÔºåÁôºÊ≥°Âä†ÈÄüÊòéÈ°Ø`;
                        if (dcp_phr < 0.55) {
                            warning += `Ôºå‰ΩÜDCPÂÉÖ${dcp_phr.toFixed(2)} phrÂèØËÉΩ‰∏çË∂≥`;
                        }
                    } else if (znoAcRatio_percent > 1.8) {
                        status = 'above_optimal';
                        suggestion = `ZnO/ACÊØî${znoAcRatio_percent.toFixed(2)}%Áï•È´òÔºåÊ≥®ÊÑèËàáDCPÁöÑÂπ≥Ë°°`;
                    }
                    
                    return {
                        tempReduction: tempReduction,
                        rateMultiplier: rateMultiplier,
                        optimalRange: znoAcRatio_percent >= 0.8 && znoAcRatio_percent <= 1.8,
                        status,
                        warning,
                        suggestion
                    };
                }
                
                // ==================== Unicell P2ÊïàÊáâË®àÁÆó (v7.5 Ê†°Ê≠£Áâà - Âü∫Êñº TDS) ====================
                // Unipaste P-2 TDS: ËàáDNPT 1:1Ê∑∑ÂêàÊôÇÂàÜËß£Ê∫´Â∫¶ 132-138¬∞C
                // Urea ‰ΩúÁÇ∫Ê¥ªÂåñÂäëÂèØÂ§ßÂπÖÈôç‰ΩéACÂàÜËß£Ê∫´Â∫¶
                function calcUnicellP2Effect(unicellAcRatio_percent) {
                    // v7.5: ÊèêÂçáÈôçÊ∫´ÊïàÊûú (~4ÂÄç)
                    let tempReduction = 0;
                    if (unicellAcRatio_percent <= 0.4) {
                        tempReduction = unicellAcRatio_percent * 30;  // 0.4% ‚Üí 12¬∞C
                    } else if (unicellAcRatio_percent <= 0.8) {
                        tempReduction = 12 + (unicellAcRatio_percent - 0.4) * 25;  // 0.8% ‚Üí 22¬∞C
                    } else if (unicellAcRatio_percent <= 1.5) {
                        tempReduction = 22 + (unicellAcRatio_percent - 0.8) * 15;  // 1.5% ‚Üí 32.5¬∞C
                    } else {
                        tempReduction = Math.min(32.5 + (unicellAcRatio_percent - 1.5) * 8, 45);  // ÊúÄÂ§ß 45¬∞C
                    }
                    
                    let rateMultiplier = 1.0;
                    if (unicellAcRatio_percent <= 1) {
                        rateMultiplier = 1 + unicellAcRatio_percent * 0.35;
                    } else if (unicellAcRatio_percent <= 2) {
                        rateMultiplier = 1.35 + (unicellAcRatio_percent - 1) * 0.30;
                    } else if (unicellAcRatio_percent <= 3) {
                        rateMultiplier = 1.65 + (unicellAcRatio_percent - 2) * 0.20;
                    } else {
                        rateMultiplier = Math.min(1.85 + (unicellAcRatio_percent - 3) * 0.1, 2.1);
                    }
                    
                    const completenessBonus = 1 + Math.min(unicellAcRatio_percent * 0.06, 0.25);
                    
                    // Êñ∞Â¢û: ÁãÄÊÖãË©ï‰º∞ÂíåË≠¶Âëä
                    let status = 'optimal';
                    let warning = null;
                    let suggestion = null;
                    
                    if (unicellAcRatio_percent < 0.2) {
                        status = 'low';
                        suggestion = `Urea/ACÊØî${unicellAcRatio_percent.toFixed(2)}%ÂÅè‰ΩéÔºåÂèØÈÅ©Â∫¶Â¢ûÂä†‰øÉÈÄ≤ÁôºÊ≥°`;
                    } else if (unicellAcRatio_percent > 2.5) {
                        status = 'critical';
                        warning = `[Ë≠¶Âëä] Urea/ACÊØîÈÅéÈ´ò(${unicellAcRatio_percent.toFixed(2)}%)ÔºåÁôºÊ≥°ÂèçÊáâÈÅéÂ∫¶ÂäáÁÉà`;
                    } else if (unicellAcRatio_percent > 2.0) {
                        status = 'high';
                        warning = `Urea/ACÊØîÂÅèÈ´ò(${unicellAcRatio_percent.toFixed(2)}%)ÔºåÁôºÊ≥°Âä†ÈÄüÊòéÈ°ØÔºåÊ≥®ÊÑèÊ≥°Â≠îÁ©©ÂÆöÊÄß`;
                    } else if (unicellAcRatio_percent > 1.5) {
                        status = 'above_optimal';
                        suggestion = `Urea/ACÊØî${unicellAcRatio_percent.toFixed(2)}%Áï•È´ò`;
                    }
                    
                    return {
                        tempReduction: tempReduction,
                        rateMultiplier: rateMultiplier,
                        completenessBonus: completenessBonus,
                        optimalRange: unicellAcRatio_percent >= 0.3 && unicellAcRatio_percent <= 1.5,
                        status,
                        warning,
                        suggestion
                    };
                }
                
                // ==================== Ââ™ÂàáÁÜ±ÊïàÊáâË®àÁÆó ====================
                function calcShearHeating(weightedVA, evaRatio, ldpeRatio, poeRatio, totalPowder_phr, time, rotorSpeed, fillFactor, initTemp) {
                    let viscosityIndex = 0;
                    const evaViscosity = 1.2 - weightedVA * 0.015;
                    viscosityIndex += evaRatio * evaViscosity;
                    viscosityIndex += ldpeRatio * 1.0;
                    viscosityIndex += poeRatio * 0.85;
                    
                    const fillerEffect = 1 + Math.min(totalPowder_phr * 0.008, 0.25);
                    const speedFactor = Math.pow(rotorSpeed / 30, 0.7);
                    // v7.3.2: Ë™øÊï¥Â°´ÂÖÖ‰øÇÊï∏ÊïàÊáâË®àÁÆóÔºàÂü∫Ê∫ñÂæû0.7ÊîπÁÇ∫0.95Ôºâ
                    const fillEffect = 1 + (fillFactor - 0.95) * 0.6;
                    const timeEffect = 1 - Math.exp(-time / 15);
                    
                    // v7.3.2: Ë™øÊï¥Âü∫Á§éÂçáÊ∫´ÔºàÈÖçÂêàÊõ¥È´òÁöÑÂ°´ÂÖÖ‰øÇÊï∏ÂíåÂá∫ÊñôÊ∫´Â∫¶Ôºâ
                    const baseTempRise = 35;
                    const shearTempRise = baseTempRise * viscosityIndex * fillerEffect * speedFactor * fillEffect * timeEffect;
                    const dropTemp = initTemp + Math.min(shearTempRise, 80);
                    
                    return {
                        tempRise: Math.min(shearTempRise, 80),
                        viscosityIndex: viscosityIndex,
                        fillerEffect: fillerEffect,
                        speedFactor: speedFactor,
                        fillEffect: fillEffect,
                        timeEffect: timeEffect,
                        dropTemp: dropTemp
                    };
                }
                
                // ==================== v7.3.2: DCPÊ∑∑Á∑¥ÈöéÊÆµÊêçÂ§±Ë®àÁÆó ====================
                // Âü∫ÊñºDCPÂçäË°∞ÊúüËàáÊ∫´Â∫¶ÁöÑÈóú‰øÇË®àÁÆóÊ∑∑Á∑¥ÈöéÊÆµÁöÑDCPÊêçÂ§±
                function calcMixingDCPLoss(dosageTemp, dischargeTemp, mixTime, dosageTime) {
                    // DCPÂçäË°∞ÊúüÂÖ¨Âºè (ArrheniusÊñπÁ®ãÁ∞°Âåñ)
                    // t1/2 = A * exp(Ea/RT)
                    // ÂØ¶Ê∏¨Êï∏ÊìöÊì¨Âêà: 130¬∞C ‚âà 15min, 140¬∞C ‚âà 5min, 150¬∞C ‚âà 1.5min
                    function getDCPHalfLife(temp) {
                        // ‰ΩøÁî®ÊåáÊï∏Êì¨Âêà: t1/2 = 2.5e8 * exp(-0.115 * T)
                        return 2.5e8 * Math.exp(-0.115 * temp);
                    }
                    
                    // Ë®àÁÆóDCPÊö¥Èú≤ÊôÇÈñìÔºàÂæûÊäïËó•Âà∞Âá∫ÊñôÔºâ
                    const exposureTime = mixTime - dosageTime;
                    if (exposureTime <= 0) return { loss: 0, exposureTime: 0, avgTemp: dosageTemp };
                    
                    // Ë®àÁÆóÂπ≥ÂùáÊö¥Èú≤Ê∫´Â∫¶ÔºàÂÅáË®≠Á∑öÊÄßÂçáÊ∫´Ôºâ
                    const avgTemp = (dosageTemp + dischargeTemp) / 2;
                    
                    // Ë®àÁÆóË©≤Ê∫´Â∫¶‰∏ãÁöÑÂçäË°∞Êúü
                    const halfLife = getDCPHalfLife(avgTemp);
                    
                    // Ë®àÁÆóÂàÜËß£ÊØî‰æã: 1 - (0.5)^(t/t1/2)
                    const decomposition = 1 - Math.pow(0.5, exposureTime / halfLife);
                    
                    // ÈôêÂà∂ÊúÄÂ§ßÊêçÂ§±ÁÇ∫60%
                    const loss = Math.min(decomposition, 0.60);
                    
                    return {
                        loss: loss,
                        exposureTime: exposureTime,
                        avgTemp: avgTemp,
                        halfLife: halfLife,
                        decomposition: decomposition
                    };
                }
                
                // Ê†πÊìöÊäïËó•Ê∫´Â∫¶Êé®ÁÆóÊäïËó•ÊôÇÊ©ü
                function estimateDosageTime(initTemp, dischargeTemp, mixTime, dosageTemp) {
                    // ÂÅáË®≠Á∑öÊÄßÂçáÊ∫´
                    const tempRange = dischargeTemp - initTemp;
                    if (tempRange <= 0) return 0;
                    
                    const dosageProgress = (dosageTemp - initTemp) / tempRange;
                    return Math.max(0, Math.min(mixTime * dosageProgress, mixTime - 1));
                }
                
                // ==================== DCP‰∫§ËÅØÊïàÁéáË®àÁÆó ====================
                function calcCrosslinkEfficiency(eva16va, eva25va, eva16_phr, eva25_phr, ldpe_phr, poe_phr) {
                    // Ê†πÊìöVA%Ë®àÁÆó‰∫§ËÅØÊïàÁéá (Âü∫ÊñºÂéüVAÂçÄÈñìÂ∞çÊáâÈóú‰øÇÁöÑÁ∑öÊÄßÂåñ)
                    // VA 12% ‚Üí 1.00, VA 17% ‚Üí 1.08, VA 22.5% ‚Üí 1.18
                    // ÂÖ¨Âºè: ÊïàÁéá ‚âà 0.85 + 0.011 √ó VA%
                    function vaToEfficiency(va) {
                        if (va <= 0) return 1.00; // LDPEÂü∫Ê∫ñ
                        return Math.min(1.35, 0.85 + 0.011 * va);
                    }
                    
                    const resinEfficiency = { 'LDPE': 1.00, 'HDPE': 0.85, 'POE': 0.90, 'LLDPE': 0.95 };
                    
                    let totalWeight = eva16_phr + eva25_phr + ldpe_phr + poe_phr;
                    if (totalWeight === 0) return 1.0;
                    
                    let weightedEff = 0;
                    weightedEff += eva16_phr * vaToEfficiency(eva16va);
                    weightedEff += eva25_phr * vaToEfficiency(eva25va);
                    weightedEff += ldpe_phr * resinEfficiency['LDPE'];
                    weightedEff += poe_phr * resinEfficiency['POE'];
                    
                    return weightedEff / totalWeight;
                }
                
                // Ë®àÁÆóÂêÑÊïàÊáâ
                const znoEffect = calcZnOEffect(znoAcRatio, dcp_phr);
                const unicellEffect = calcUnicellP2Effect(ureaAcRatio);
                const crosslinkEff = calcCrosslinkEfficiency(eva16va, eva25va, eva16_phr, eva25_phr, ldpe_phr, poe_phr);
                
                const evaRatio = (totalEVA16 + totalEVA25) / totalResin;
                const ldpeRatio = totalLDPE / totalResin;
                const poeRatio = totalPOE / totalResin;
                
                const mixShearEffect = calcShearHeating(weightedVA, evaRatio, ldpeRatio, poeRatio, totalPowder_phr, mixTime, rotorSpeed, fillFactor, mixInitTemp);
                
                // v7.3.2: Âá∫ÊñôÊ∫´Â∫¶ÔºàÂÑ™ÂÖà‰ΩøÁî®ÊâãÂãïËº∏ÂÖ•ÔºåÂê¶Ââá‰ΩøÁî®Ë®àÁÆóÂÄºÔºâ
                const calculatedDischargeTemp = mixShearEffect.dropTemp;
                const dischargeTemp = dischargeTempInput ? parseFloat(dischargeTempInput) : calculatedDischargeTemp;
                const isManualDischargeTemp = !!dischargeTempInput;
                
                // v7.3.2: Ë®àÁÆóÊäïËó•ÊôÇÊ©üÂíåDCPÊ∑∑Á∑¥ÊêçÂ§±
                const dosageTime = estimateDosageTime(mixInitTemp, dischargeTemp, mixTime, dosageTemp);
                const mixingDCPLoss = calcMixingDCPLoss(dosageTemp, dischargeTemp, mixTime, dosageTime);
                
                // v7.5: ÁôºÊ≥°ÈöéÊÆµÁÑ°Ââ™ÂàáÁÜ± (Ê≤πÂ£ìÁôºÊ≥°Ê©üÊòØÈùúÊÖãÂä†ÁÜ±)
                const shearEffect1 = {
                    tempRise: 0,  // ÁôºÊ≥°Ê©üÁÑ°Ââ™ÂàáÁÜ±
                    viscosityIndex: mixShearEffect.viscosityIndex,
                    fillerEffect: mixShearEffect.fillerEffect,
                    speedFactor: 1.0,
                    fillEffect: 1.0,
                    timeEffect: mixShearEffect.timeEffect,
                    dropTemp: dischargeTemp
                };
                const shearEffect2 = shearEffect1;
                
                // ==================== v7.5: Ê∑∑Á∑¥ÈöéÊÆµACÂæÆÈáèÂàÜËß£Ë®àÁÆó ====================
                // Áï∂Âá∫ÊñôÊ∫´Â∫¶Êé•ËøëACÊúâÊïàÂàÜËß£Ê∫´Â∫¶ÊôÇÔºåÂèØËÉΩÊúâÂ∞ëÈáèACÊèêÂâçÂàÜËß£
                function calcMixingACLoss(dischargeTemp, znoEffect, unicellEffect) {
                    // ACF06 Âü∫Ê∫ñÂàÜËß£Ê∫´Â∫¶ 203¬∞C
                    const acBaseDecompTemp = 203;
                    const acEffectiveDecompTemp = acBaseDecompTemp - znoEffect.tempReduction - unicellEffect.tempReduction;
                    const tempDiff = acEffectiveDecompTemp - dischargeTemp;
                    
                    let mixingACLoss = 0;
                    let mixingACWarning = null;
                    
                    if (tempDiff > 20) {
                        mixingACLoss = 0;  // ÂÆâÂÖ®Ôºå‰∏çÂàÜËß£
                    } else if (tempDiff > 10) {
                        mixingACLoss = 0.01 + (20 - tempDiff) * 0.002;  // 1-3%
                    } else if (tempDiff > 0) {
                        mixingACLoss = 0.03 + (10 - tempDiff) * 0.005;  // 3-8%
                    } else {
                        mixingACLoss = 0.08 + Math.abs(tempDiff) * 0.01;  // >8%
                        mixingACWarning = `[Ë≠¶Âëä] Ê∑∑Á∑¥Âá∫ÊñôÊ∫´Â∫¶(${dischargeTemp.toFixed(0)}¬∞C)Â∑≤Ë∂ÖÈÅéACÊúâÊïàÂàÜËß£Ê∫´Â∫¶(${acEffectiveDecompTemp.toFixed(0)}¬∞C)`;
                    }
                    
                    // Á≤íÂæëÂàÜÂ∏ÉÊïàÊáâÔºöËºÉÂ∞èÈ°ÜÁ≤íÊúÉÂÖàÂàÜËß£
                    mixingACLoss *= 1.2;  // ËÄÉÊÖÆÁ≤íÂæëÂàÜÂ∏ÉÔºåÂ¢ûÂä†20%
                    
                    return {
                        loss: Math.min(mixingACLoss, 0.15),  // ÊúÄÂ§ß 15%
                        acEffectiveDecompTemp: acEffectiveDecompTemp,
                        tempDiff: tempDiff,
                        warning: mixingACWarning
                    };
                }
                
                const mixingACLoss = calcMixingACLoss(dischargeTemp, znoEffect, unicellEffect);
                
                // ==================== ACÂàÜËß£ÂãïÂäõÂ≠∏ (v7.5 Ê†°Ê≠£Áâà) ====================
                // ACF06: Âü∫Ê∫ñÂàÜËß£Ê∫´Â∫¶ 203¬∞CÔºå‰ΩøÁî®„ÄåÊúâÊïàÊ∫´Â∫¶„ÄçÊ¶ÇÂøµ
                // ÊúâÊïàÊ∫´Â∫¶ = ÁôºÊ≥°Ë®≠ÂÆöÊ∫´Â∫¶ (Âõ†ÁÇ∫ÁôºÊ≥°Ê©üÁÑ°Ââ™ÂàáÁÜ±)
                // ACÂàÜËß£Áî±„ÄåÊúâÊïàÊ∫´Â∫¶ vs ACÊúâÊïàÂàÜËß£Ê∫´Â∫¶„ÄçÊ±∫ÂÆö
                function calcACDecomposition(temp, time, znoEffect, unicellEffect, shearEffect, mixingACLoss) {
                    // ACF06 Âü∫Ê∫ñÂàÜËß£Ê∫´Â∫¶ 203¬∞C
                    const acBaseDecompTemp = 203;
                    const acEffectiveDecompTemp = acBaseDecompTemp - znoEffect.tempReduction - unicellEffect.tempReduction;
                    
                    // ÂØ¶ÈöõÁôºÊ≥°Ê∫´Â∫¶ (ÁÑ°Ââ™ÂàáÁÜ±Âä†Êàê)
                    const effectiveTemp = temp + shearEffect.tempRise;
                    
                    // Ë®àÁÆóÊ∫´Â∫¶Áõ∏Â∞çÊñºÊúâÊïàÂàÜËß£Ê∫´Â∫¶ÁöÑ‰ΩçÁΩÆ
                    const tempAboveDecomp = effectiveTemp - acEffectiveDecompTemp;
                    
                    let baseDecomp = 0;
                    if (tempAboveDecomp < -20) {
                        baseDecomp = Math.max(0, (tempAboveDecomp + 30) * 0.002);  // ÈÅ†‰ΩéÊñºÂàÜËß£Ê∫´Â∫¶
                    } else if (tempAboveDecomp < -10) {
                        baseDecomp = 0.02 + (tempAboveDecomp + 20) * 0.015;  // 2-17%
                    } else if (tempAboveDecomp < 0) {
                        baseDecomp = 0.17 + (tempAboveDecomp + 10) * 0.035;  // 17-52%
                    } else if (tempAboveDecomp < 10) {
                        baseDecomp = 0.52 + tempAboveDecomp * 0.040;  // 52-92%
                    } else if (tempAboveDecomp < 20) {
                        baseDecomp = 0.92 + (tempAboveDecomp - 10) * 0.007;  // 92-99%
                    } else {
                        baseDecomp = 0.99 + Math.min((tempAboveDecomp - 20) * 0.001, 0.009);
                    }
                    
                    const combinedRateMultiplier = znoEffect.rateMultiplier * unicellEffect.rateMultiplier;
                    const adjustedTime = time * combinedRateMultiplier;
                    const timeEffect = 1 - Math.exp(-adjustedTime / 18);  // Á®çÂæÆÂä†Âø´
                    
                    let rate = baseDecomp * timeEffect * unicellEffect.completenessBonus;
                    
                    // Êâ£Èô§Ê∑∑Á∑¥ÈöéÊÆµÂ∑≤ÂàÜËß£ÁöÑÈÉ®ÂàÜ
                    rate = Math.max(0, rate - mixingACLoss.loss);
                    
                    return {
                        rate: Math.min(rate, 0.995),
                        effectiveTemp: effectiveTemp,
                        acEffectiveDecompTemp: acEffectiveDecompTemp,
                        tempAboveDecomp: tempAboveDecomp,
                        equivalentTime: adjustedTime,
                        shearTempRise: shearEffect.tempRise
                    };
                }
                
                const acDecomp1 = calcACDecomposition(temp1, time1, znoEffect, unicellEffect, shearEffect1, mixingACLoss);
                const acDecomp2 = calcACDecomposition(temp2, time2, znoEffect, unicellEffect, shearEffect2, {loss: 0});
                const totalACDecomposition = acDecomp1.rate + (1 - acDecomp1.rate) * acDecomp2.rate;
                
                // ==================== DCP‰∫§ËÅØË®àÁÆó (Êï¥ÂêàÈòªÁáÉÂäëÂπ≤Êìæ) ====================
                const calcHalfLife = (temp) => {
                    const T = 273.15 + temp;
                    const kd = 9.24e15 * Math.exp(-152670 / (8.3142 * T));
                    return Math.log(2) / kd / 60;
                };
                const halfLife1 = calcHalfLife(temp1);
                const halfLife2 = calcHalfLife(temp2);
                
                let reaction1 = (1 - Math.pow(0.5, time1 / halfLife1)) * 100;
                let reaction2 = (1 - Math.pow(0.5, time2 / halfLife2)) * 100;
                
                // ÊáâÁî®Ê®πËÑÇ‰∫§ËÅØÊïàÁéá
                reaction1 = reaction1 * crosslinkEff;
                reaction2 = reaction2 * crosslinkEff;
                
                // ÊáâÁî®ÈòªÁáÉÂäë‰∫§ËÅØÂπ≤Êìæ‰øÇÊï∏ (Êñ∞Â¢û!)
                reaction1 = reaction1 * frEffect.crosslinkInterference;
                reaction2 = reaction2 * frEffect.crosslinkInterference;
                
                const totalReaction = Math.min(reaction1 + (100 - reaction1) * reaction2 / 100, 99.9);
                
                // ==================== v7.4: Recalibrated CI Range Model ====================
                // Based on verified good-quality formulations:
                // Low EVA (‚â§30%): CI range 1.026~1.398 ‚Üí Target 1.2, Range ¬±25%
                // Mid-High EVA + Low Exp: CI ‚âà 0.75~0.78 ‚Üí Target 0.77, Range ¬±15%
                // High EVA + High Exp: CI increases with interaction effect
                function calcDynamicCIRange(predictedExpansion, pigment_phr, frAmount_phr, evaRatio) {
                    // 1. Calculate Target CI based on EVA% and Expansion interaction
                    let targetCI;
                    let rangePercent;  // Range as percentage of target
                    
                    if (evaRatio <= 30) {
                        // Low EVA (‚â§30%): Wide tolerance, CI can be 1.0~1.4
                        // Data: #4 CI=1.026, A CI=1.351, B CI=1.398 all good
                        targetCI = 1.20;
                        rangePercent = 0.25;  // ¬±25%
                    } else if (predictedExpansion < 25) {
                        // Medium-High EVA + Low Expansion: CI ‚âà 0.77
                        // Data: EVA50% 23X CI=0.75, EVA90% 23X CI=0.78
                        targetCI = 0.77;
                        rangePercent = 0.15;  // ¬±15%
                    } else {
                        // High EVA (>30%) + High Expansion (‚â•25X): Interaction effect
                        // Data: EVA70% 28.4X ‚Üí CI=1.51
                        const evaFactor = (evaRatio - 30) / 40;  // 30%=0, 70%=1
                        const expFactor = (predictedExpansion - 25) / 5;  // 25X=0, 30X=1
                        targetCI = 0.77 + evaFactor * expFactor * 1.1;
                        rangePercent = 0.15;  // ¬±15%
                    }
                    
                    // 2. Pigment adjustment (reduces crosslink efficiency)
                    let pigmentFactor = 1.0;
                    if (pigment_phr > 0.5) {
                        pigmentFactor = 1 - Math.min((pigment_phr - 0.5) * 0.02, 0.15);
                    }
                    
                    // 3. Flame Retardant adjustment (interferes with crosslinking)
                    let frFactor = 1.0;
                    if (frAmount_phr > 0) {
                        frFactor = 1 - Math.min(frAmount_phr * 0.008, 0.20);
                    }
                    
                    // Apply adjustments to target
                    const adjustedTarget = targetCI * pigmentFactor * frFactor;
                    
                    // 4. CI Range based on rangePercent
                    const ciMin = adjustedTarget * (1 - rangePercent);
                    const ciMax = adjustedTarget * (1 + rangePercent);
                    
                    // Optimal range = middle 50% (30% ~ 70% of range)
                    const ciOptimalLow = ciMin + (ciMax - ciMin) * 0.30;
                    const ciOptimalHigh = ciMin + (ciMax - ciMin) * 0.70;
                    
                    return {
                        ciMin: Math.max(0.30, ciMin),
                        ciMax: ciMax,
                        ciOptimalLow,
                        ciOptimalHigh,
                        targetCI: adjustedTarget,
                        baseTarget: targetCI,
                        pigmentFactor,
                        frFactor,
                        rangePercent,
                        factors: {
                            expansion: predictedExpansion,
                            pigment: pigment_phr,
                            fr: frAmount_phr,
                            eva: evaRatio
                        }
                    };
                }
                
                // ==================== Á≤æÁ¢∫DCP‰∫§ËÅØË©ï‰º∞Á≥ªÁµ± (v7.3.2 ÂãïÊÖãCIÁâà + Ê∑∑Á∑¥ÊêçÂ§±) ====================
                // ËÄÉÊÖÆÂõ†Á¥†: DCPÁî®Èáè„ÄÅÊ®πËÑÇÁµÑÊàê„ÄÅÊ∫´Â∫¶ÊôÇÈñì„ÄÅÈòªÁáÉÂäëÂπ≤Êìæ„ÄÅBHTÊ∂àËÄó„ÄÅËâ≤ÊØç„ÄÅÁôºÊ≥°ÂÄçÁéá„ÄÅÊ∑∑Á∑¥ÊêçÂ§±
                function evaluateDCPCrosslinking(params) {
                    const {
                        dcp_phr,
                        bht_phr, // BHTÁî®Èáè
                        eva_phr, ldpe_phr, poe_phr,
                        effectiveVA, // ÊúâÊïàVAÂê´Èáè (%)
                        temp1, time1, temp2, time2,
                        crosslinkEff,
                        frInterference,
                        reaction1_raw, reaction2_raw,
                        znoAcRatio,
                        totalResin_kg,
                        pigment_phr, // Ëâ≤ÊØçÁî®Èáè (phr)
                        ac_phr, // ACÁî®Èáè (phr)
                        flameRetardant_phr, // ÈòªÁáÉÂäëÁ∏ΩÈáè (phr)
                        mixingDCPLoss, // v7.3.2: Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§±
                        predictedExpansion // v7.4.0: ÂØ¶ÈöõÈ†êÊ∏¨ÁôºÊ≥°ÂÄçÁéá
                    } = params;
                    
                    // === 1. Ë®àÁÆóÂü∫Á§éDCPÈúÄÊ±Ç (ÂØ¶ÈöõÈÖçÊñπÁ∂ìÈ©óÂÖ¨Âºè v3) ===
                    // Á∂ìÈ©óÊï∏Êìö‰æÜÊ∫ê (2024-01Êõ¥Êñ∞):
                    // - Á¥îLDPE (VA=0%): DCP = 0.92 phr
                    // - EVA VA16%: DCP = 1.11 phr
                    // - EVA VA25%: DCP = 1.29 phr
                    // - Á¥îPOE: DCP = 2.30 phr (Êñ∞Â¢û)
                    // ÊñáÁçª‰æùÊìö: Narkis & Miltz (1977) - EVAÁöÑscission-to-crosslinking ratioÈ´òÊñºLDPE
                    
                    let baseDCPNeed = 0.92 + 0.015 * effectiveVA;
                    
                    // POEÈ°çÂ§ñË™øÊï¥ (‰øÇÊï∏Âæû0.08‰øÆÊ≠£ÁÇ∫1.38ÔºåÂü∫ÊñºÂØ¶Ê∏¨Êï∏Êìö)
                    // ÂØ¶Ê∏¨: Á¥îPOEÈúÄË¶Å~2.30 phrÔºåÁ¥îLDPEÈúÄË¶Å0.92 phrÔºåÂ∑ÆÁï∞=1.38 phr
                    const totalResinPhr = eva_phr + ldpe_phr + poe_phr;
                    if (totalResinPhr > 0) {
                        const poeRatio = poe_phr / totalResinPhr;
                        baseDCPNeed += poeRatio * 1.38; // ‰øÆÊ≠£: 0.08 ‚Üí 1.38
                    }
                    
                    // === 1b. Ëâ≤ÊØçÂΩ±Èüø (Êñ∞Â¢û) ===
                    // ÂØ¶Ê∏¨Êï∏Êìö: Ëâ≤ÊØçÊúÉÂπ≤Êìæ‰∫§ËÅØÔºå‰øÇÊï∏Á¥Ñ0.13 phr DCP / phrËâ≤ÊØç
                    // ÂéüÂõ†: È°èÊñôÈ°ÜÁ≤íÂê∏ÈôÑËá™Áî±Âü∫„ÄÅÂàÜÊï£ÂäëÊ∂àËÄóDCP
                    const colorMBEffect = (pigment_phr || 0) * 0.13;
                    baseDCPNeed += colorMBEffect;
                    
                    // === 1c. ÁôºÊ≥°ÂÄçÁéáË™øÊï¥ (Êñ∞Â¢û) ===
                    // ÊñáÁçª‰æùÊìö: È´òÁôºÊ≥°ÂÄçÁéáÈúÄË¶ÅËºÉ‰Ωé‰∫§ËÅØÂ∫¶‰ª•ÂÖÅË®±Êõ¥Â§ßËÜ®ËÑπ
                    // ResearchGate 2012: "mountain-shape curve" ‰∫§ËÅØÂ∫¶ËàáÁôºÊ≥°ÂÄçÁéáÈóú‰øÇ
                    // ÂØ¶Ê∏¨Êï∏Êìö: 19.9ÂÄç‚âà1.0, 25ÂÄç‚âà0.95, 31ÂÄç‚âà0.85, 33ÂÄç‚âà0.88
                    
                    // v7.4.0: ‰ΩøÁî®ÂÇ≥ÂÖ•ÁöÑ predictedExpansionÔºàÂØ¶ÈöõÈ†êÊ∏¨ÂÄºÔºâËÄåÈùûÂÖßÈÉ®‰º∞ÁÆó
                    const estimatedExpansion = predictedExpansion || (3.41 + 1.347 * (ac_phr || 20) * 0.8);
                    
                    let expansionFactor = 1.0;
                    if (estimatedExpansion < 10) {
                        expansionFactor = 1.12;       // Ë∂Ö‰ΩéÁôºÊ≥° +12%
                    } else if (estimatedExpansion < 15) {
                        expansionFactor = 1.06;       // ‰ΩéÁôºÊ≥° +6%
                    } else if (estimatedExpansion <= 20) {
                        expansionFactor = 1.00;       // ‰∏≠ÁôºÊ≥° (Âü∫Ê∫ñ)
                    } else if (estimatedExpansion <= 25) {
                        expansionFactor = 0.95;       // ‰∏≠È´òÁôºÊ≥° -5%
                    } else if (estimatedExpansion <= 30) {
                        expansionFactor = 0.88;       // È´òÁôºÊ≥° -12%
                    } else {
                        expansionFactor = 0.85;       // Ë∂ÖÈ´òÁôºÊ≥° -15%
                    }
                    
                    baseDCPNeed *= expansionFactor;
                    
                    // === 2. BHTÊäóÊ∞ßÂåñÂäëÂΩ±Èüø (ÂãïÊÖãË®àÁÆó) ===
                    // ÂØ¶ÂãôÁ∂ìÈ©ó: ÊØèÂ¢ûÂä†10g BHTÈúÄÂ¢ûÂä†15g DCP (1:1.5ÊØî‰æã)
                    // BHTÊ∂àËÄóÁöÑDCPÁï∂Èáè = BHTÁî®Èáè √ó 1.5
                    const bhtDcpConsumption = bht_phr * 1.5; // BHTÊ∂àËÄóÁöÑDCPÁï∂Èáè (phr)
                    
                    // === 2b. v7.3.2: Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§± ===
                    const mixingLossRate = mixingDCPLoss ? mixingDCPLoss.loss : 0;
                    const dcpAfterMixing = dcp_phr * (1 - mixingLossRate); // Ê∑∑Á∑¥ÂæåÂâ©È§òDCP
                    const effectiveDcp = Math.max(0, dcpAfterMixing - bhtDcpConsumption); // ÊúâÊïàDCP
                    
                    // BHTÊïàÁéáÂπ≤Êìæ‰øÇÊï∏ (Áî®ÊñºÂèçÊáâÁ®ãÂ∫¶Ë®àÁÆó)
                    // Áï∂BHTÂ≠òÂú®ÊôÇÔºåÂç≥‰ΩøË£úË∂≥DCPÔºåÂèçÊáâÊïàÁéá‰ªçÁï•Êúâ‰∏ãÈôç
                    const bhtInterference = bht_phr > 0 ? Math.max(0.90, 1 - bht_phr * 0.15) : 1.0;
                    
                    // BHTÁî®ÈáèË≠¶Á§∫
                    let bhtWarning = null;
                    let bhtSuggestion = null;
                    if (bht_phr > 0) {
                        if (bht_phr < 0.05) {
                            bhtSuggestion = `BHT amount low (${bht_phr.toFixed(3)} phr), antioxidant protection may be insufficient, suggest 0.08-0.15 phr`;
                        } else if (bht_phr >= 0.08 && bht_phr <= 0.15) {
                            // ÊúÄ‰Ω≥ÁØÑÂúçÔºåÁÑ°ÈúÄÊèêÁ§∫
                        } else if (bht_phr > 0.15 && bht_phr <= 0.20) {
                            bhtSuggestion = `BHT slightly high (${bht_phr.toFixed(3)} phr), consuming ~${(bhtDcpConsumption).toFixed(3)} phr DCP equivalent`;
                        } else if (bht_phr > 0.20 && bht_phr <= 0.30) {
                            bhtWarning = `[Ë≠¶Âëä] BHT high (${bht_phr.toFixed(3)} phr > 0.20), consumes ${(bhtDcpConsumption).toFixed(3)} phr DCP equivalent`;
                        } else if (bht_phr > 0.30) {
                            bhtWarning = `[Âö¥Èáç] BHT excessive (${bht_phr.toFixed(3)} phr > 0.30), severely affects crosslinking!`;
                        }
                    }
                    
                    // === 2c. v7.3.2: Ê∑∑Á∑¥ÊêçÂ§±Ë≠¶Á§∫ ===
                    let mixingLossWarning = null;
                    if (mixingLossRate > 0.40) {
                        mixingLossWarning = `[Ë≠¶Âëä] Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§±ÈÅéÈ´ò(${(mixingLossRate*100).toFixed(1)}%)ÔºåÂª∫Ë≠∞Èôç‰ΩéÊäïËó•Ê∫´Â∫¶ÊàñÂá∫ÊñôÊ∫´Â∫¶`;
                    } else if (mixingLossRate > 0.25) {
                        mixingLossWarning = `Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§±${(mixingLossRate*100).toFixed(1)}%ÔºåÂú®ÂèØÊé•ÂèóÁØÑÂúç`;
                    }
                    
                    // === 3. ËÄÉÊÖÆÈòªÁáÉÂäëÂπ≤ÊìæÂæåÁöÑÂØ¶ÈöõÈúÄÊ±Ç ===
                    // ÈòªÁáÉÂäëÊçïÊçâËá™Áî±Âü∫ÔºåÈúÄË¶ÅÊõ¥Â§öDCPË£úÂÑü
                    const effectiveDCPNeed = baseDCPNeed / frInterference;
                    
                    // === 4. Ë®àÁÆóDCP‰æõÈúÄÊØî (‰ΩøÁî®ÊúâÊïàDCP) ===
                    const dcpSupplyRatio = effectiveDcp / effectiveDCPNeed;
                    
                    // === 5. Ë®àÁÆóÊúâÊïàÂèçÊáâÁ®ãÂ∫¶ ===
                    const rawReaction = Math.min(
                        reaction1_raw + (100 - reaction1_raw) * reaction2_raw / 100,
                        99.9
                    );
                    const effectiveReaction = rawReaction * crosslinkEff * frInterference * bhtInterference;
                    
                    // === 6. Ë®àÁÆó‰∫§ËÅØÊåáÊï∏ ===
                    // ‰∫§ËÅØÊåáÊï∏ = DCP‰æõÈúÄÊØî √ó ÊúâÊïàÂèçÊáâÁ®ãÂ∫¶
                    const crosslinkIndex = dcpSupplyRatio * (effectiveReaction / 100);
                    
                    // === 7. ZnO-DCP‰∫§‰∫í‰ΩúÁî®Ë©ï‰º∞ ===
                    // È´òZnOÊúÉÂä†ÈÄüACÂàÜËß£ÔºåËã•DCP‰∏çË∂≥ÊúÉÂ∞éËá¥Ê≥°Â≠î‰∏çÁ©©ÂÆö
                    let znoDcpBalance = "balanced";
                    let znoDcpWarning = null;
                    
                    if (znoAcRatio > 1.5 && dcpSupplyRatio < 0.9) {
                        znoDcpBalance = "unbalanced";
                        znoDcpWarning = `ZnO/ACÊØîÂÅèÈ´ò(${znoAcRatio.toFixed(2)}%)‰ΩÜDCP‰∏çË∂≥ÔºåÁôºÊ≥°ÈÅéÂø´ÂèØËÉΩÂ∞éËá¥Ê≥°Â≠îÂ°åÈô∑`;
                    } else if (znoAcRatio > 2.0 && dcpSupplyRatio < 1.1) {
                        znoDcpBalance = "critical";
                        znoDcpWarning = `[Âö¥Èáç] ZnO/ACÊØîÈÅéÈ´ò(${znoAcRatio.toFixed(2)}%)ÔºåDCP‰æõÈúÄÊØîÂÉÖ${(dcpSupplyRatio*100).toFixed(0)}%Ôºå‰∫§ËÅØ-ÁôºÊ≥°Âö¥ÈáçÂ§±Ë°°`;
                    } else if (znoAcRatio < 0.5 && dcpSupplyRatio > 1.3) {
                        znoDcpBalance = "slow";
                        znoDcpWarning = `ZnO‰∏çË∂≥(${znoAcRatio.toFixed(2)}%)‰ΩÜDCPÂÅèÈ´òÔºåÁôºÊ≥°Á∑©ÊÖ¢ÊïàÁéá‰Ωé`;
                    }
                    
                    // === 8. Ê∫´Â∫¶ÊúâÊïàÊÄßÊ™¢Êü• ===
                    let tempWarning = null;
                    if (temp1 < 140) {
                        tempWarning = `‰∏ÄÊ¨°ÁôºÊ≥°Ê∫´Â∫¶ÈÅé‰Ωé(${temp1}¬∞C)ÔºåDCPÂàÜËß£Á∑©ÊÖ¢`;
                    } else if (temp1 > 158) {
                        tempWarning = `‰∏ÄÊ¨°ÁôºÊ≥°Ê∫´Â∫¶ÂÅèÈ´ò(${temp1}¬∞C)ÔºåDCPÂèØËÉΩÂàÜËß£ÈÅéÂø´`;
                    }
                    
                    // === 9. Á∂úÂêàË©ï‰º∞ (v7.3 ÂãïÊÖãCIÁØÑÂúç) ===
                    let status, warning, suggestion, severity;
                    
                    // Ë®àÁÆóDCPÁî®ÈáèËÆäÂåñÊïèÊÑüÂ∫¶ (10gÁÇ∫Âü∫Ê∫ñ)
                    const dcpSensitivity = 0.01 / totalResin_kg; // 10gÂ∞çÊáâÁöÑphrËÆäÂåñ
                    
                    // v7.3.1: Ë®àÁÆóEVAÊØî‰æã
                    const evaRatio = (totalResinPhr > 0) ? (eva_phr / totalResinPhr * 100) : 0;
                    
                    // v7.4.0: Ë®àÁÆóÂãïÊÖãCIÂêàÊ†ºÁØÑÂúç
                    const dynamicCI = calcDynamicCIRange(
                        estimatedExpansion, 
                        pigment_phr || 0, 
                        flameRetardant_phr || 0, 
                        evaRatio
                    );
                    
                    // Ê•µÁ´Ø‰∏çË∂≥ÊÉÖÊ≥Å
                    if (dcp_phr < 0.30) {
                        status = "Âö¥Èáç‰∏çË∂≥";
                        severity = "critical";
                        warning = `[Âö¥Èáç] DCPÂö¥Èáç‰∏çË∂≥(${dcp_phr.toFixed(3)} phr)Ôºå‰∫§ËÅØÁ∂≤Áµ°ÁÑ°Ê≥ïÊúâÊïàÂΩ¢Êàê`;
                        const needAdd = (effectiveDCPNeed - dcp_phr) * totalResin_kg * 1000;
                        suggestion = `Âª∫Ë≠∞Â¢ûÂä†DCPÁ¥Ñ ${needAdd.toFixed(0)}g`;
                    }
                    // ‰∫§ËÅØÊåáÊï∏Âö¥Èáç‰∏çË∂≥ (‰ΩéÊñºÂãïÊÖã‰∏ãÈôêÁöÑ70%)
                    else if (crosslinkIndex < dynamicCI.ciMin * 0.70) {
                        status = "Âö¥Èáç‰∏çË∂≥";
                        severity = "critical";
                        warning = `[Âö¥Èáç] ‰∫§ËÅØÊåáÊï∏ÈÅé‰Ωé(${crosslinkIndex.toFixed(3)})ÔºåÈÅ†‰ΩéÊñºÂêàÊ†º‰∏ãÈôê(${dynamicCI.ciMin.toFixed(3)})ÔºåÊ≥°Â≠îÁµêÊßãÂö¥Èáç‰∏çÁ©©ÂÆö`;
                        const targetCI = dynamicCI.ciOptimalLow;
                        const targetDcpRatio = targetCI / (effectiveReaction / 100);
                        const targetEffectiveDCP = effectiveDCPNeed * targetDcpRatio;
                        const needAdd = (targetEffectiveDCP - effectiveDcp) * totalResin_kg * 1000;
                        suggestion = `Âª∫Ë≠∞Â¢ûÂä†DCPÁ¥Ñ ${Math.max(10, needAdd).toFixed(0)}g ‰ΩøCIÈÅîÂà∞${dynamicCI.ciOptimalLow.toFixed(3)}‰ª•‰∏ä`;
                    }
                    // ÂèçÊáâÁ®ãÂ∫¶‰∏çË∂≥
                    else if (effectiveReaction < 55 && dcpSupplyRatio >= 0.8) {
                        status = "ÂèçÊáâ‰∏çÂÆåÂÖ®";
                        severity = "warning";
                        warning = `[Ë≠¶Âëä] DCPÂèçÊáâ‰∏çÂÆåÂÖ®(${effectiveReaction.toFixed(1)}%)Ôºå‰∫§ËÅØÊïàÊûúÊúâÈôê`;
                        suggestion = `Âª∫Ë≠∞ÊèêÈ´òÁôºÊ≥°Ê∫´Â∫¶ÊàñÂª∂Èï∑ÊôÇÈñì`;
                    }
                    // ‰∫§ËÅØÈÅéÂ∫¶ - Ë∂ÖÂá∫ÂãïÊÖã‰∏äÈôê
                    else if (crosslinkIndex > dynamicCI.ciMax) {
                        status = "‰∫§ËÅØÈÅéÂ∫¶";
                        severity = "warning";
                        warning = `[Ë≠¶Âëä] ‰∫§ËÅØÊåáÊï∏ÈÅéÈ´ò(${crosslinkIndex.toFixed(3)} > ${dynamicCI.ciMax.toFixed(3)})ÔºåÂèØËÉΩÂ∞éËá¥Ê≥°Ê£âÁ°¨ËÑÜ`;
                        const targetCI = dynamicCI.ciOptimalHigh;
                        const targetDcpRatio = targetCI / (effectiveReaction / 100);
                        const targetEffectiveDCP = effectiveDCPNeed * targetDcpRatio;
                        const canReduce = (effectiveDcp - targetEffectiveDCP) * totalResin_kg * 1000;
                        suggestion = `Âª∫Ë≠∞Ê∏õÂ∞ëDCPÁ¥Ñ ${Math.max(10, canReduce).toFixed(0)}g`;
                    }
                    // ‰∫§ËÅØ‰∏çË∂≥ - ‰ΩéÊñºÂãïÊÖã‰∏ãÈôê
                    else if (crosslinkIndex < dynamicCI.ciMin) {
                        status = "‰∫§ËÅØ‰∏çË∂≥";
                        severity = "warning";
                        warning = `[Ë≠¶Âëä] ‰∫§ËÅØÊåáÊï∏ÂÅè‰Ωé(${crosslinkIndex.toFixed(3)} < ${dynamicCI.ciMin.toFixed(3)})ÔºåÊ≥°Â≠îÁµêÊßãÂèØËÉΩ‰∏çÁ©©ÂÆö`;
                        const targetCI = dynamicCI.ciOptimalLow;
                        const targetDcpRatio = targetCI / (effectiveReaction / 100);
                        const targetEffectiveDCP = effectiveDCPNeed * targetDcpRatio;
                        const needAdd = (targetEffectiveDCP - effectiveDcp) * totalResin_kg * 1000;
                        suggestion = `Âª∫Ë≠∞Â¢ûÂä†DCPÁ¥Ñ ${Math.max(10, needAdd).toFixed(0)}g`;
                    }
                    // ÂêàÊ†º‰ΩÜÂÅèÈ´ò (Êé•Ëøë‰∏äÈôê)
                    else if (crosslinkIndex > dynamicCI.ciOptimalHigh) {
                        status = "ÂêàÊ†º-ÂÅèÈ´ò";
                        severity = "info";
                        warning = null;
                        const targetCI = dynamicCI.ciOptimalHigh;
                        const targetDcpRatio = targetCI / (effectiveReaction / 100);
                        const targetEffectiveDCP = effectiveDCPNeed * targetDcpRatio;
                        const canReduce = (effectiveDcp - targetEffectiveDCP) * totalResin_kg * 1000;
                        suggestion = `‰∫§ËÅØÊåáÊï∏${crosslinkIndex.toFixed(3)}ÂêàÊ†º‰ΩÜÂÅèÈ´ò(ÁØÑÂúç${dynamicCI.ciMin.toFixed(3)}~${dynamicCI.ciMax.toFixed(3)})ÔºåÂèØËÄÉÊÖÆÊ∏õÂ∞ëDCPÁ¥Ñ${Math.max(5, canReduce).toFixed(0)}g`;
                    }
                    // ÂêàÊ†º‰ΩÜÂÅè‰Ωé (Êé•Ëøë‰∏ãÈôê)
                    else if (crosslinkIndex < dynamicCI.ciOptimalLow) {
                        status = "ÂêàÊ†º-ÂÅè‰Ωé";
                        severity = "info";
                        warning = null;
                        const targetCI = dynamicCI.ciOptimalLow;
                        const targetDcpRatio = targetCI / (effectiveReaction / 100);
                        const targetEffectiveDCP = effectiveDCPNeed * targetDcpRatio;
                        const needAdd = (targetEffectiveDCP - effectiveDcp) * totalResin_kg * 1000;
                        suggestion = `‰∫§ËÅØÊåáÊï∏${crosslinkIndex.toFixed(3)}ÂêàÊ†º‰ΩÜÂÅè‰Ωé(ÁØÑÂúç${dynamicCI.ciMin.toFixed(3)}~${dynamicCI.ciMax.toFixed(3)})ÔºåÂèØËÄÉÊÖÆÂ¢ûÂä†DCPÁ¥Ñ${Math.max(5, needAdd).toFixed(0)}g`;
                    }
                    // ÊúÄ‰Ω≥ÁØÑÂúç
                    else if (crosslinkIndex >= dynamicCI.ciOptimalLow && crosslinkIndex <= dynamicCI.ciOptimalHigh) {
                        status = "‰∫§ËÅØËâØÂ•Ω";
                        severity = "good";
                        warning = null;
                        suggestion = `‰∫§ËÅØÊåáÊï∏${crosslinkIndex.toFixed(3)}ÔºåËôïÊñºÊúÄ‰Ω≥ÁØÑÂúç(${dynamicCI.ciOptimalLow.toFixed(3)}~${dynamicCI.ciOptimalHigh.toFixed(3)})`;
                    }
                    // ÂÖ∂‰ªñÊÉÖÊ≥Å
                    else {
                        status = "ÈúÄÊ™¢Ë¶ñ";
                        severity = "info";
                        warning = `‰∫§ËÅØÁãÄÊÖãÈúÄË¶ÅÈóúÊ≥®(ÊåáÊï∏${crosslinkIndex.toFixed(3)}ÔºåÂêàÊ†ºÁØÑÂúç${dynamicCI.ciMin.toFixed(3)}~${dynamicCI.ciMax.toFixed(3)})`;
                        suggestion = `Âª∫Ë≠∞Ê™¢Êü•ÈÖçÊñπÂíåË£ΩÁ®ãÂèÉÊï∏`;
                    }
                    
                    return {
                        status,
                        severity,
                        warning,
                        suggestion,
                        tempWarning,
                        znoDcpWarning,
                        znoDcpBalance,
                        dcpSupplyRatio,
                        effectiveReaction,
                        effectiveDCPNeed,
                        crosslinkIndex,
                        baseDCPNeed,
                        effectiveVA, // ÊúâÊïàVAÂê´Èáè
                        bhtInterference,
                        bhtDcpConsumption,
                        effectiveDcp,
                        bhtWarning,
                        bhtSuggestion,
                        // v7.2
                        estimatedExpansion,  // ‰º∞ÁÆóÁôºÊ≥°ÂÄçÁéá
                        expansionFactor,     // ÁôºÊ≥°ÂÄçÁéáË™øÊï¥Âõ†Â≠ê
                        colorMBEffect,       // Ëâ≤ÊØçDCPÊ∂àËÄó
                        // v7.3 Êñ∞Â¢û: ÂãïÊÖãCIÁØÑÂúç
                        dynamicCI,           // ÂãïÊÖãCIÂêàÊ†ºÁØÑÂúçÁâ©‰ª∂
                        // v7.3.2 Êñ∞Â¢û: Ê∑∑Á∑¥ÊêçÂ§±
                        mixingLossRate,      // Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§±Áéá
                        mixingLossWarning,   // Ê∑∑Á∑¥ÊêçÂ§±Ë≠¶Âëä
                        dcpAfterMixing       // Ê∑∑Á∑¥ÂæåÂâ©È§òDCP (phr)
                    };
                }
                
                // Âü∑Ë°åDCPË©ï‰º∞
                // Ë®àÁÆóÊúâÊïàVAÂê´Èáè (Êï¥È´îÈÖçÊñπÁöÑVA%)
                // effectiveVA = (EVAÁî®Èáè √ó EVAÁöÑÂä†Ê¨äVA%) / Á∏ΩÊ®πËÑÇ
                const totalResinPhr = eva16_phr + eva25_phr + ldpe_phr + poe_phr;
                const effectiveVA = (totalResinPhr > 0) ? 
                    ((eva16_phr + eva25_phr) * weightedVA / totalResinPhr) : 0;
                
                // ==================== VAÂê´ÈáèÂíåPOEÊïàÊáâ ====================
                const vaFoamingFactor = weightedVA / 20;
                const vaEffect = 0.9 + vaFoamingFactor * 0.1;
                
                let poeEffect = 1.0;
                if (poe > 0) {
                    const poeRatioCalc = poe / totalResin;
                    poeEffect = 1 + poeRatioCalc * 0.15;
                }
                
                // ==================== ÂìÅË≥™È†êÊ∏¨ (Êï¥ÂêàÂàÜÈõ¢Ë®àÁÆó) ====================
                // ‰ΩøÁî®ÂàÜÈõ¢ÁöÑÊäëÂà∂‰øÇÊï∏
                const fillerSuppression = fillerEffect.foamSuppression;
                const frSuppression = frEffect.foamSuppression;
                const totalSuppression = fillerSuppression * frSuppression;
                
                const ureaEnhancement = 1 + (ureaAcRatio * 0.02);
                
                // v7.4.0: ÊèêÂâçË®àÁÆó effectiveAC Âíå predictedExpansionÔºåÁî®Êñº CI ÁØÑÂúçË®àÁÆó
                // ÊúâÊïàAC = ÂØ¶ÈöõAC √ó ACÂàÜËß£Áéá √ó Urea‰øÉÈÄ≤ / Á∏ΩÊäëÂà∂ √ó VAÊïàÊáâ √ó POEÊïàÊáâ
                const effectiveAC = ac_phr * totalACDecomposition * ureaEnhancement / totalSuppression * vaEffect * poeEffect;
                const predictedExpansion = 3.41 + 1.347 * effectiveAC;
                
                const dcpEval = evaluateDCPCrosslinking({
                    dcp_phr,
                    bht_phr, // ÂÇ≥ÂÖ•BHTÁî®Èáè
                    eva_phr: eva16_phr + eva25_phr,
                    ldpe_phr,
                    poe_phr,
                    effectiveVA, // ÂÇ≥ÂÖ•ÊúâÊïàVAÂê´Èáè
                    temp1, time1, temp2, time2,
                    crosslinkEff,
                    frInterference: frEffect.crosslinkInterference,
                    reaction1_raw: (1 - Math.pow(0.5, time1 / halfLife1)) * 100,
                    reaction2_raw: (1 - Math.pow(0.5, time2 / halfLife2)) * 100,
                    znoAcRatio,
                    totalResin_kg: totalResin / 1000,
                    pigment_phr: pigment_phr_separate, // Ëâ≤ÊØçÁî®Èáè
                    ac_phr, // ACÁî®Èáè (Áî®Êñº‰º∞ÁÆóÁôºÊ≥°ÂÄçÁéá)
                    flameRetardant_phr: frEffect.totalFR, // ÈòªÁáÉÂäëÁ∏ΩÈáè
                    mixingDCPLoss: mixingDCPLoss, // v7.3.2: Ê∑∑Á∑¥ÈöéÊÆµDCPÊêçÂ§±
                    predictedExpansion: predictedExpansion  // v7.4.0: ÂÇ≥ÂÖ•ÂØ¶ÈöõÈ†êÊ∏¨ÁôºÊ≥°ÂÄçÁéá
                });
                
                // ==================== ‰∫§ËÅØ-ÁôºÊ≥°Âπ≥Ë°°Ê™¢Êü• ====================
                let crosslinkFoamBalance = dcpEval.status;
                let balanceWarning = "";
                
                // ‰ΩøÁî®Êñ∞ÁöÑDCPË©ï‰º∞ÁµêÊûúË®≠ÂÆö‰∫§ËÅØ-ÁôºÊ≥°Âπ≥Ë°°
                if (dcpEval.severity === "critical") {
                    balanceWarning = dcpEval.warning;
                } else if (dcpEval.severity === "warning") {
                    balanceWarning = dcpEval.warning || "";
                } else if (dcpEval.severity === "good") {
                    balanceWarning = "Crosslink-foam timing good";
                } else if (dcpEval.tempWarning) {
                    balanceWarning = dcpEval.tempWarning;
                } else {
                    balanceWarning = "";
                }
                
                // ==================== ÂìÅË≥™È†êÊ∏¨ (‰ΩøÁî®Â∑≤Ë®àÁÆóÁöÑ effectiveAC Âíå predictedExpansion) ====================
                const predictedDensity = theoreticalDensity / predictedExpansion;
                
                // ==================== ÂìÅË≥™Ë≠¶Á§∫Á≥ªÁµ± (Êï¥ÂêàÂàÜÈõ¢Ë®àÁÆó) ====================
                const warnings = [];
                const suggestions = [];
                
                // v7.5: ÂØ¶È©óÊ®°ÂºèÊîæÂØ¨Ë£ΩÁ®ãÂèÉÊï∏Ë≠¶ÂëäÔºàÂè™Ë≠¶ÂëäÂö¥ÈáçÂïèÈ°åÔºâ
                // isLabMode Â∑≤Âú®‰∏äÊñπÂÆ£Âëä
                
                // Ë£ΩÁ®ãÂèÉÊï∏Ê™¢Êü•
                if (temp1 > temp2) {
                    warnings.push("[Âö¥Èáç] ‰∏ÄÊ¨°ÁôºÊ≥°Ê∫´Â∫¶È´òÊñº‰∫åÊ¨°ÁôºÊ≥°Ôºå‰∏çÁ¨¶ÂêàÊ®ôÊ∫ñË£ΩÁ®ã");
                }
                
                // v7.5: ÂØ¶È©óÊ®°Âºè‰∏çÈ°ØÁ§∫Ê∫´Â∫¶/ÊôÇÈñìÁØÑÂúçË≠¶ÂëäÔºåÈô§ÈùûÊúâÂö¥ÈáçÂïèÈ°å
                if (!isLabMode) {
                    // ÁîüÁî¢Ê®°ÂºèÔºöÈ°ØÁ§∫ÁØÑÂúçË≠¶Âëä
                    if (temp1 < 140 || temp1 > 154) {
                        warnings.push(`[Ë≠¶Âëä] ‰∏ÄÊ¨°ÁôºÊ≥°Ê∫´Â∫¶ ${temp1}¬∞C Ë∂ÖÂá∫Âª∫Ë≠∞ÁØÑÂúç(140-154¬∞C)`);
                    }
                    if (temp2 < 160 || temp2 > 167) {
                        warnings.push(`[Ë≠¶Âëä] ‰∫åÊ¨°ÁôºÊ≥°Ê∫´Â∫¶ ${temp2}¬∞C Ë∂ÖÂá∫Âª∫Ë≠∞ÁØÑÂúç(160-167¬∞C)`);
                    }
                    if (time1 < 20 || time1 > 35) {
                        warnings.push(`[Ë≠¶Âëä] ‰∏ÄÊ¨°ÁôºÊ≥°ÊôÇÈñì ${time1}ÂàÜ Ë∂ÖÂá∫Âª∫Ë≠∞ÁØÑÂúç(26-30ÂàÜ)`);
                    }
                } else {
                    // ÂØ¶È©óÊ®°ÂºèÔºöÂè™È°ØÁ§∫Âö¥ÈáçÂïèÈ°å
                    // Ê™¢Êü•ÊòØÂê¶‰∫§ËÅØÈÅéÂ∫¶ (DCPÂèçÊáâÁéá > 99% ‰∏î CI > 1.5)
                    if (totalReaction > 99 && dcpEval.crosslinkIndex > 1.5) {
                        warnings.push(`[Ë≠¶Âëä] ‰∫§ËÅØÂèØËÉΩÈÅéÂ∫¶ (DCPÂèçÊáâ${totalReaction.toFixed(1)}%, CI=${dcpEval.crosslinkIndex.toFixed(2)})`);
                    }
                    // Ê™¢Êü•ÁôºÊ≥°ÊòØÂê¶ÈÅéÊøÄ (ACÂàÜËß£Áéá > 98% ‰∏îÊ∫´Â∫¶ÈÅ†Ë∂ÖÊúâÊïàÂàÜËß£Ê∫´Â∫¶)
                    if (totalACDecomposition > 0.98 && acDecomp1.tempAboveDecomp > 25) {
                        warnings.push(`[Ë≠¶Âëä] ÁôºÊ≥°ÂèçÊáâÂèØËÉΩÈÅéÊøÄ (ACÂàÜËß£${(totalACDecomposition*100).toFixed(1)}%, Ê∫´Â∫¶Ë∂ÖÈÅéÊúâÊïàÂàÜËß£+${acDecomp1.tempAboveDecomp.toFixed(0)}¬∞C)`);
                    }
                }
                
                // AC/DCPÂπ≥Ë°°
                if (acDcpRatio < 10) {
                    warnings.push("[Âö¥Èáç] AC/DCPÊØîÈÅé‰Ωé(<10)ÔºåÁôºÊ≥°Âö¥Èáç‰∏çË∂≥");
                    suggestions.push(`Âª∫Ë≠∞Â¢ûÂä†ACËá≥ ${(dcp_phr * 15).toFixed(1)} phr ‰ª•‰∏ä`);
                } else if (acDcpRatio > 30) {
                    warnings.push("[Ë≠¶Âëä] AC/DCPÊØîÈÅéÈ´ò(>30)Ôºå‰∫§ËÅØÂèØËÉΩ‰∏çË∂≥");
                } else if (acDcpRatio >= 15 && acDcpRatio <= 25) {
                    suggestions.push(`AC/DCPÊØîÂÄº${acDcpRatio.toFixed(1)}Âú®ÊúÄ‰Ω≥ÁØÑÂúç(15-25)`);
                }
                
                // ÁÑ°Ê©üÂ°´ÊñôË≠¶Á§∫ (ÂàÜÈõ¢Ë®àÁÆó)
                if (fillerEffect.warning) {
                    warnings.push(fillerEffect.warning);
                }
                if (fillerEffect.suggestion) {
                    suggestions.push(fillerEffect.suggestion);
                }
                if (fillerEffect.optimalRange) {
                    suggestions.push(`ÁÑ°Ê©üÂ°´Êñô${inorganicFiller_phr.toFixed(1)} phr Âú®ÊúÄ‰Ω≥ÁØÑÂúç(5-20 phr)`);
                }
                
                // ÈòªÁáÉÂäëË≠¶Á§∫ (ÂàÜÈõ¢Ë®àÁÆó) - ÁßªÈô§emoji
                frEffect.warnings.forEach(w => warnings.push(w));
                frEffect.suggestions.forEach(s => suggestions.push(s));
                
                // v7.5: Ê∑∑Á∑¥ACÊêçÂ§±Ë≠¶Âëä
                if (mixingACLoss.warning) {
                    warnings.push(mixingACLoss.warning);
                }
                if (mixingACLoss.loss > 0.05) {
                    suggestions.push(`Ê∑∑Á∑¥ÈöéÊÆµACÊêçÂ§±${(mixingACLoss.loss*100).toFixed(1)}%ÔºåËÄÉÊÖÆÈôç‰ΩéÂá∫ÊñôÊ∫´Â∫¶ÊàñÊ∏õÂ∞ëZnO/Urea`);
                }
                
                // BHTË≠¶ÂëäÂíåÂª∫Ë≠∞ (Êñ∞Â¢û)
                if (dcpEval.bhtWarning) {
                    warnings.push(dcpEval.bhtWarning);
                }
                if (dcpEval.bhtSuggestion) {
                    suggestions.push(dcpEval.bhtSuggestion);
                }
                
                // DCP‰∫§ËÅØË©ï‰º∞Ë≠¶Âëä
                if (dcpEval.severity === "critical" && dcpEval.warning) {
                    warnings.push(dcpEval.warning);
                } else if (dcpEval.severity === "warning" && dcpEval.warning) {
                    warnings.push(dcpEval.warning);
                }
                
                // ZnO-DCP‰∫§‰∫í‰ΩúÁî®Ë≠¶Âëä
                if (dcpEval.znoDcpWarning) {
                    warnings.push(dcpEval.znoDcpWarning);
                }
                
                // DCPË©ï‰º∞Âª∫Ë≠∞
                if (dcpEval.suggestion) {
                    suggestions.push(dcpEval.suggestion);
                }
                
                // Ê∫´Â∫¶Ë≠¶Âëä
                if (dcpEval.tempWarning) {
                    warnings.push(`[Ë≠¶Âëä] ${dcpEval.tempWarning}`);
                }
                
                // ZnOË≠¶ÂëäÂíåÂª∫Ë≠∞ (Êñ∞Â¢û)
                if (znoEffect.warning) {
                    warnings.push(znoEffect.warning);
                }
                if (znoEffect.suggestion) {
                    suggestions.push(znoEffect.suggestion);
                }
                if (znoEffect.optimalRange) {
                    suggestions.push(`ZnO/ACÊØî${znoAcRatio.toFixed(2)}%Âú®ÊúÄ‰Ω≥ÁØÑÂúç(0.8-1.5%)`);
                }
                
                // UreaË≠¶ÂëäÂíåÂª∫Ë≠∞ (Êñ∞Â¢û)
                if (unicellEffect.warning) {
                    warnings.push(unicellEffect.warning);
                }
                if (unicellEffect.suggestion) {
                    suggestions.push(unicellEffect.suggestion);
                }
                if (unicellEffect.optimalRange) {
                    suggestions.push(`Urea/ACÊØî${ureaAcRatio.toFixed(2)}%Âú®ÊúÄ‰Ω≥ÁØÑÂúç(0.3-1.5%)`);
                }
                
                // ÂéüÊúâÁöÑ‰∫§ËÅØÂÆåÊàêÂ∫¶Ê™¢Êü• (‰øùÁïô‰ΩúÁÇ∫Ë£úÂÖÖ)
                if (totalReaction < 70 && dcpEval.severity !== "critical" && dcpEval.severity !== "warning") {
                    warnings.push(`[Âö¥Èáç] Á∏Ω‰∫§ËÅØÂÆåÊàêÂ∫¶‰∏çË∂≥(${totalReaction.toFixed(1)}%)`);
                    suggestions.push("Âª∫Ë≠∞ÊèêÈ´òÊ∫´Â∫¶ÊàñÂª∂Èï∑ÊôÇÈñì");
                } else if (totalReaction >= 95 && dcpEval.severity === "good") {
                    suggestions.push(`DCPÂèçÊáâÂÆåÂÖ®(${totalReaction.toFixed(1)}%)`);
                }
                
                // ÈòªÁáÉÂäë‰∫§ËÅØÂπ≤ÊìæÊèêÈÜí
                if (frEffect.crosslinkInterference < 0.95) {
                    warnings.push(`[Ë≠¶Âëä] ÈòªÁáÉÂäëÈôç‰Ωé‰∫§ËÅØÊïàÁéáËá≥ ${(frEffect.crosslinkInterference * 100).toFixed(0)}%`);
                    const dcpCompensation = dcp * (1 / frEffect.crosslinkInterference - 1);
                    suggestions.push(`Âª∫Ë≠∞Â¢ûÂä† DCP ${(dcpCompensation * 1000).toFixed(0)}g Ë£úÂÑü‰∫§ËÅØÊêçÂ§±`);
                }
                
                // ‰∫§ËÅØ-ÁôºÊ≥°Âπ≥Ë°°
                if (balanceWarning && !balanceWarning.includes("ËâØÂ•Ω") && !balanceWarning.includes("good")) {
                    warnings.push(balanceWarning);
                } else if (balanceWarning && (balanceWarning.includes("ËâØÂ•Ω") || balanceWarning.includes("good"))) {
                    suggestions.push(balanceWarning);
                }
                
                // ==================== v7.4: Êô∫ËÉΩË≠¶Á§∫ÈÅéÊøæ ====================
                // ÂÅµÊ∏¨‰∫íÁõ∏ÊäµÊ∂àÁöÑÂõ†Â≠êÔºåÂêà‰ΩµÈ°ØÁ§∫ÁÇ∫„ÄåÂπ≥Ë°°ÊèêÁ§∫„Äç
                const balanceNotes = [];
                const filteredWarnings = [];
                
                // Ê™¢Ê∏¨ÁôºÊ≥°Âπ≥Ë°°ÔºöAC/DCP‰Ωé vs ZnO/ACÈ´ò
                const hasAcDcpLow = warnings.some(w => w.includes('AC/DCP') && (w.includes('ÈÅé‰Ωé') || w.includes('‰∏çË∂≥')));
                const hasZnoHigh = warnings.some(w => w.includes('ZnO/AC') && w.includes('ÈÅéÈ´ò'));
                
                // Ê™¢Ê∏¨‰∫§ËÅØÂπ≥Ë°°ÔºöCIÈÅéÈ´ò vs FR/CP-70ÊäëÂà∂
                const hasCiHigh = warnings.some(w => w.includes('‰∫§ËÅØÊåáÊï∏ÈÅéÈ´ò') || w.includes('ÈÅéÂ∫¶‰∫§ËÅØ'));
                const hasFrInterference = warnings.some(w => w.includes('ÈòªÁáÉÂäëÈôç‰Ωé‰∫§ËÅØÊïàÁéá') || w.includes('crosslink efficiency'));
                const hasCp70High = warnings.some(w => w.includes('CP-70') && w.includes('high'));
                
                // ÁîüÊàêÂπ≥Ë°°ÊèêÁ§∫
                if (hasAcDcpLow && hasZnoHigh) {
                    balanceNotes.push({
                        type: 'foaming',
                        title: 'Foaming Balance',
                        factors: ['AC/DCP ratio low ‚¨áÔ∏è', 'ZnO/AC ratio high ‚¨ÜÔ∏è'],
                        note: 'Factors may offset each other'
                    });
                }
                
                if (hasCiHigh && (hasFrInterference || hasCp70High)) {
                    const downFactors = [];
                    if (hasFrInterference) downFactors.push('FR interference ‚¨áÔ∏è');
                    if (hasCp70High) downFactors.push('CP-70 interference ‚¨áÔ∏è');
                    
                    balanceNotes.push({
                        type: 'crosslink',
                        title: 'Crosslink Balance',
                        factors: ['CI high ‚¨ÜÔ∏è', ...downFactors],
                        note: 'Factors may offset each other'
                    });
                }
                
                // ÈÅéÊøæË≠¶Á§∫ÔºöÁßªÈô§Â∑≤Ë¢´Âπ≥Ë°°ÁöÑË≠¶Á§∫
                warnings.forEach(w => {
                    let shouldFilter = false;
                    
                    // Â¶ÇÊûúÁôºÊ≥°Âπ≥Ë°°Â≠òÂú®ÔºåÈÅéÊøæÁõ∏ÈóúË≠¶Á§∫
                    if (balanceNotes.some(b => b.type === 'foaming')) {
                        if ((w.includes('AC/DCP') && (w.includes('ÈÅé‰Ωé') || w.includes('‰∏çË∂≥'))) ||
                            (w.includes('ZnO/AC') && w.includes('ÈÅéÈ´ò'))) {
                            shouldFilter = true;
                        }
                    }
                    
                    // Â¶ÇÊûú‰∫§ËÅØÂπ≥Ë°°Â≠òÂú®ÔºåÈÅéÊøæÁõ∏ÈóúË≠¶Á§∫
                    if (balanceNotes.some(b => b.type === 'crosslink')) {
                        if (w.includes('‰∫§ËÅØÊåáÊï∏ÈÅéÈ´ò') || w.includes('ÈÅéÂ∫¶‰∫§ËÅØ') ||
                            w.includes('ÈòªÁáÉÂäëÈôç‰Ωé‰∫§ËÅØÊïàÁéá') ||
                            (w.includes('CP-70') && w.includes('high') && w.includes('crosslink'))) {
                            shouldFilter = true;
                        }
                    }
                    
                    if (!shouldFilter) {
                        filteredWarnings.push(w);
                    }
                });
                
                // ‰ΩøÁî®ÈÅéÊøæÂæåÁöÑË≠¶Á§∫
                const finalWarnings = filteredWarnings;
                const finalBalanceNotes = balanceNotes;
                
                // ÂÑ≤Â≠òÁµêÊûú (v7.3.6: Âä†ÂÖ•Ê®°ÂºèË≥áË®ä)
                currentCalc = {
                    // v7.3.6: Ê®°ÂºèË≥áË®ä
                    mode: currentMode,
                    isTwoRollMill: isTwoRollMill,
                    
                    // Âü∫Êú¨Ë≥áË®ä
                    productModel: document.getElementById('productModel').value || 'N/A',
                    batchId: document.getElementById('batchId').value || 'N/A',
                    productionDate: document.getElementById('productionDate').value,
                    
                    // ÂéüÂßãËº∏ÂÖ• (ÈáçÈáè kg - ÂÖßÈÉ®Áµ±‰∏ÄÁî®kg)
                    raw_eva16_kg: eva16,
                    raw_eva25_kg: eva25,
                    raw_ldpe24_kg: ldpe24,
                    raw_ldpe40_kg: ldpe40,
                    raw_poe_kg: poe,
                    raw_ac_kg: totalAC,  // ACÁ∏ΩÈáè (ÂæûÊØçÁ≤íË®àÁÆó)
                    raw_acpe_kg: acpe,   // AC-PEÊØçÁ≤í
                    raw_aceva_kg: aceva, // AC-EVAÊØçÁ≤í
                    raw_dcp_kg: dcp,
                    raw_zno_kg: zno,
                    raw_urea_kg: urea,
                    raw_bht_kg: bht,
                    raw_filler_kg: filler,
                    raw_color_kg: color,
                    raw_ath_kg: ath,
                    raw_brsb_kg: brsb,
                    raw_redp_kg: redp,     // v7.4: Á¥ÖÁ£∑ÊØçÁ≤í
                    raw_cp70_kg: cp70,
                    raw_powder_kg: powder,
                    
                    // VA%Ëº∏ÂÖ•
                    eva16va, eva25va,
                    
                    // Ë£ΩÁ®ãÂèÉÊï∏
                    temp1, time1, temp2, time2,
                    
                    // v7.3.5: Ê∑∑Á∑¥ÂèÉÊï∏ÔºàÂê´ÊñôÂ∞æÔºâ
                    mixerVolume,         // ÂØÜÁÖâÊ©üË¶èÊ†º (L)
                    tailMaterial,        // ÊñôÂ∞æÈáçÈáè (kg)
                    formulaWeight,       // ÈÖçÊñπÁ∏ΩÈáç (kg)
                    tailRatio,           // ÊñôÂ∞æÊØî‰æã (%)
                    totalWeight,         // ÂØ¶ÈöõÁ∏ΩÈáç (kg)
                    theoreticalDensityMix, // ÁêÜË´ñÂØÜÂ∫¶ (g/cm¬≥)
                    theoreticalVolume,   // ÁêÜË´ñÈ´îÁ©ç (L)
                    fillFactor,          // Â°´ÂÖÖ‰øÇÊï∏ (Ëá™ÂãïË®àÁÆó)
                    mixTime, rotorSpeed, mixInitTemp,
                    dosageTemp,          // ÊäïËó•Ê∫´Â∫¶
                    dischargeTemp,       // Âá∫ÊñôÊ∫´Â∫¶
                    isManualDischargeTemp,  // ÊòØÂê¶ÊâãÂãïËº∏ÂÖ•Âá∫ÊñôÊ∫´Â∫¶
                    
                    // phrË®àÁÆóÂÄº
                    ac_phr, dcp_phr, bht_phr, totalPowder_phr, urea_phr, zno_phr,
                    eva16_phr, eva25_phr, ldpe_phr, poe_phr,
                    talc_phr, caco3_phr, powder_phr,
                    ath_phr, redPhos_phr, br_phr, sb_phr, cp70_phr,
                    inorganicFiller_phr, flameRetardant_phr, pigment_phr: pigment_phr_separate,
                    
                    // ÊØî‰æãË®àÁÆó
                    acDcpRatio, ureaAcRatio, znoAcRatio, weightedVA,
                    totalResin_kg: totalResin / 1000,
                    
                    // v7.3.2: Ê∑∑Á∑¥DCPÊêçÂ§±
                    mixingDCPLoss,
                    
                    // È†êÊ∏¨ÁµêÊûú
                    theoreticalDensity, predictedDensity, predictedExpansion,
                    effectiveAC, totalSuppression,
                    fillerSuppression, frSuppression,
                    totalReaction, reaction1, reaction2,
                    acDecomp1, acDecomp2, totalACDecomposition,
                    crosslinkFoamBalance, vaEffect, poeEffect,
                    znoEffect, unicellEffect, fillerEffect, frEffect, crosslinkEff,
                    
                    // v7.5.1: Áî®Êñº Lab Mode ÂàóÂç∞
                    totalFormulaWeightG: null,  // ÊúÉÂú®È°ØÁ§∫ÈöéÊÆµÊõ¥Êñ∞
                    estimatedVolume: null,      // ÊúÉÂú®È°ØÁ§∫ÈöéÊÆµÊõ¥Êñ∞
                    
                    // DCPË©ï‰º∞ÁµêÊûú
                    dcpEval,
                    
                    // v7.4: Âπ≥Ë°°ÊèêÁ§∫
                    balanceNotes: finalBalanceNotes,
                    
                    // Ë≠¶Á§∫ËàáÂª∫Ë≠∞ (‰ΩøÁî®ÈÅéÊøæÂæå)
                    warnings: finalWarnings, 
                    suggestions
                };
                
                // ==================== È°ØÁ§∫ÁµêÊûú ====================
                // v7.5: ÂêåÊôÇÈ°ØÁ§∫ phr Âíå wt%
                const showWeightInPhr = (currentMode === 'lab' && labInputMode === 'phr');
                
                // v7.5.2: Production Mode È°ØÁ§∫ kgÔºåLab Mode È°ØÁ§∫ g
                // isLabMode Â∑≤Âú®‰∏äÊñπÂÆ£Âëä (line 1910)
                const weightUnit = isLabMode ? 'g' : 'kg';
                const weightMultiplier = isLabMode ? 1 : 0.001;  // Lab: g, Prod: kg
                
                // v7.5: Ë®àÁÆóÂØ¶ÈöõÊ®πËÑÇÈáçÈáè (kg ‚Üí g)
                // ÁÑ°Ë´ñÂì™Á®ÆËº∏ÂÖ•Ê®°ÂºèÔºåÈÉΩÁî®ÂØ¶ÈöõÁöÑ totalResin (kg) ‰æÜË®àÁÆó
                const actualTotalResinG = totalResin * 1000;  // kg ‚Üí g
                const displayTotalResinG = showWeightInPhr ? 
                    (parseFloat(document.getElementById('totalResinWeight').value) || 200) : 
                    actualTotalResinG;
                
                // v7.5.2: phr ‚Üí weight ËΩâÊèõ (Lab: g, Production: kg)
                const phrToWeight = (phr) => ((phr / 100 * actualTotalResinG) * weightMultiplier).toFixed(isLabMode ? 1 : 3);
                const phrToG = phrToWeight;  // ‰øùÁïôÂêëÂæåÂÖºÂÆπ
                
                // Ë®àÁÆóÁ∏ΩÈÖçÊñπ phr (Áî®Êñº wt% Ë®àÁÆó)
                const totalFormulaPhr = 100 + ac_phr + dcp_phr + zno_phr + urea_phr + inorganicFiller_phr + pigment_phr_separate + flameRetardant_phr + bht_phr;
                
                // v7.5.2: Ë®àÁÆóÁ∏ΩÈÖçÊñπÈáçÈáè (Ê†πÊìöÊ®°Âºè‰ΩøÁî®‰∏çÂêåÂñÆ‰Ωç)
                const totalFormulaWeightG = totalFormulaPhr / 100 * actualTotalResinG * weightMultiplier;
                
                // phr ‚Üí wt% ËΩâÊèõ
                const phrToWtPct = (phr) => (phr / totalFormulaPhr * 100).toFixed(2);
                
                // v7.5.2: Ë°®Ê†ºÊ¨Ñ‰Ωç - Ê†πÊìöÊ®°ÂºèÈ°ØÁ§∫‰∏çÂêåÂñÆ‰Ωç
                const weightCol = `<th>Weight(${weightUnit})</th>`;
                const wtPctCol = '<th>wt%</th>';
                const weightCell = (phr) => `<td style="color:#8cf;">${phrToWeight(phr)}</td>`;
                const wtPctCell = (phr) => `<td style="color:#ad8;">${phrToWtPct(phr)}</td>`;
                
                // ==================== v7.5: Input Summary Ë°®Ê†º ====================
                // Ë®àÁÆóËº∏ÂÖ•Èáè (kg ‚Üí g for Lab mode)
                const inputUnit = isLabMode ? 'g' : 'kg';
                const inputMultiplier = isLabMode ? 1000 : 1;
                
                // ÂèñÂæóÂéüÂßãËº∏ÂÖ•ÂÄº (Â∑≤Á∂ìÊòØ kg)
                const inputEva16G = eva16 * inputMultiplier;
                const inputEva25G = eva25 * inputMultiplier;
                const inputLdpe24G = ldpe24 * inputMultiplier;
                const inputLdpe40G = ldpe40 * inputMultiplier;
                const inputPoeG = poe * inputMultiplier;
                const inputAcpeG = acpe * inputMultiplier;
                const inputAcevaG = aceva * inputMultiplier;
                const inputRedpG = redp * inputMultiplier;
                const inputBrsbG = brsb * inputMultiplier;
                const inputFillerG = filler * inputMultiplier;
                const inputColorG = color * inputMultiplier;
                const inputAthG = ath * inputMultiplier;
                const inputCp70G = cp70 * inputMultiplier;
                const inputDcpG = dcp * inputMultiplier;
                const inputBhtG = bht * inputMultiplier;
                const inputZnoG = zno * inputMultiplier;
                const inputUreaG = urea * inputMultiplier;
                const inputPowderG = powder * inputMultiplier;
                
                // v7.5.1: Ê∏¨Ë©¶Áâ©
                const testName = document.getElementById('testName').value || '';
                const testAmountRaw = parseFloat(document.getElementById('testAmount').value) || 0;
                const testNote = document.getElementById('testNote').value || '';
                const inputTestG = isLabMode ? testAmountRaw : 0;  // Âè™Âú® Lab Mode ÊúâÊïà
                
                // Ë®àÁÆóËº∏ÂÖ•ÈáèÁöÑ phr (Áõ∏Â∞çÊñºÁ∏ΩÊ®πËÑÇ)
                const inputToPhr = (inputG) => (inputG / actualTotalResinG * 100).toFixed(2);
                
                // Ë®àÁÆóÈÖçÊñπÁ∏ΩËº∏ÂÖ•ÈáçÈáè (Âê´Ê∏¨Ë©¶Áâ©)
                const totalInputG = inputEva16G + inputEva25G + inputLdpe24G + inputLdpe40G + inputPoeG +
                    inputAcpeG + inputAcevaG + inputRedpG + inputBrsbG + inputFillerG + inputColorG +
                    inputAthG + inputCp70G + inputDcpG + inputBhtG + inputZnoG + inputUreaG + inputPowderG + inputTestG;
                
                // v7.5.1: Ë®àÁÆóËº∏ÂÖ•ÈáèÁöÑ wt% (Áõ∏Â∞çÊñºÁ∏ΩËº∏ÂÖ•ÈáçÈáè)
                const inputToWtPct = (inputG) => (inputG / totalInputG * 100).toFixed(2);
                
                // ÁîüÊàê Input Summary Ë°®Ê†º
                let inputSummaryRows = '';
                
                // Ê®πËÑÇ
                if (inputEva16G > 0) inputSummaryRows += `<tr><td>EVA (VA${eva16va}%)</td><td style="color:#8cf;">${inputEva16G.toFixed(1)}</td><td>${inputToPhr(inputEva16G)}</td><td style="color:#ad8;">${inputToWtPct(inputEva16G)}</td></tr>`;
                if (inputEva25G > 0) inputSummaryRows += `<tr><td>EVA (VA${eva25va}%)</td><td style="color:#8cf;">${inputEva25G.toFixed(1)}</td><td>${inputToPhr(inputEva25G)}</td><td style="color:#ad8;">${inputToWtPct(inputEva25G)}</td></tr>`;
                if (inputLdpe24G > 0) inputSummaryRows += `<tr><td>LDPE MI2.4</td><td style="color:#8cf;">${inputLdpe24G.toFixed(1)}</td><td>${inputToPhr(inputLdpe24G)}</td><td style="color:#ad8;">${inputToWtPct(inputLdpe24G)}</td></tr>`;
                if (inputLdpe40G > 0) inputSummaryRows += `<tr><td>LDPE MI4.0</td><td style="color:#8cf;">${inputLdpe40G.toFixed(1)}</td><td>${inputToPhr(inputLdpe40G)}</td><td style="color:#ad8;">${inputToWtPct(inputLdpe40G)}</td></tr>`;
                if (inputPoeG > 0) inputSummaryRows += `<tr><td>POE</td><td style="color:#8cf;">${inputPoeG.toFixed(1)}</td><td>${inputToPhr(inputPoeG)}</td><td style="color:#ad8;">${inputToWtPct(inputPoeG)}</td></tr>`;
                
                // ÊØçÁ≤í
                if (inputAcpeG > 0) inputSummaryRows += `<tr style="background:rgba(100,80,60,0.1);"><td>AC-PE MB (50%)</td><td style="color:#8cf;">${inputAcpeG.toFixed(1)}</td><td>${inputToPhr(inputAcpeG)}</td><td style="color:#ad8;">${inputToWtPct(inputAcpeG)}</td></tr>`;
                if (inputAcevaG > 0) inputSummaryRows += `<tr style="background:rgba(100,80,60,0.1);"><td>AC-EVA MB (50%)</td><td style="color:#8cf;">${inputAcevaG.toFixed(1)}</td><td>${inputToPhr(inputAcevaG)}</td><td style="color:#ad8;">${inputToWtPct(inputAcevaG)}</td></tr>`;
                if (inputFillerG > 0) inputSummaryRows += `<tr style="background:rgba(100,80,60,0.1);"><td>Filler MB (Talc+CaCO‚ÇÉ)</td><td style="color:#8cf;">${inputFillerG.toFixed(1)}</td><td>${inputToPhr(inputFillerG)}</td><td style="color:#ad8;">${inputToWtPct(inputFillerG)}</td></tr>`;
                if (inputColorG > 0) inputSummaryRows += `<tr style="background:rgba(100,80,60,0.1);"><td>Color MB</td><td style="color:#8cf;">${inputColorG.toFixed(1)}</td><td>${inputToPhr(inputColorG)}</td><td style="color:#ad8;">${inputToWtPct(inputColorG)}</td></tr>`;
                if (inputRedpG > 0) inputSummaryRows += `<tr style="background:rgba(120,80,80,0.1);"><td>Á¥ÖÁ£∑ MB (50%)</td><td style="color:#8cf;">${inputRedpG.toFixed(1)}</td><td>${inputToPhr(inputRedpG)}</td><td style="color:#ad8;">${inputToWtPct(inputRedpG)}</td></tr>`;
                if (inputBrsbG > 0) inputSummaryRows += `<tr style="background:rgba(120,80,80,0.1);"><td>Br/Sb MB</td><td style="color:#8cf;">${inputBrsbG.toFixed(1)}</td><td>${inputToPhr(inputBrsbG)}</td><td style="color:#ad8;">${inputToWtPct(inputBrsbG)}</td></tr>`;
                
                // Â∞èÊñô
                if (inputAthG > 0) inputSummaryRows += `<tr style="background:rgba(80,80,100,0.1);"><td>ATH</td><td style="color:#8cf;">${inputAthG.toFixed(2)}</td><td>${inputToPhr(inputAthG)}</td><td style="color:#ad8;">${inputToWtPct(inputAthG)}</td></tr>`;
                if (inputCp70G > 0) inputSummaryRows += `<tr style="background:rgba(80,80,100,0.1);"><td>CP-70 Chlorinated Paraffin</td><td style="color:#8cf;">${inputCp70G.toFixed(2)}</td><td>${inputToPhr(inputCp70G)}</td><td style="color:#ad8;">${inputToWtPct(inputCp70G)}</td></tr>`;
                if (inputDcpG > 0) inputSummaryRows += `<tr style="background:rgba(80,100,80,0.1);"><td>DCP</td><td style="color:#8cf;">${inputDcpG.toFixed(2)}</td><td>${inputToPhr(inputDcpG)}</td><td style="color:#ad8;">${inputToWtPct(inputDcpG)}</td></tr>`;
                if (inputBhtG > 0) inputSummaryRows += `<tr style="background:rgba(80,100,80,0.1);"><td>BHT</td><td style="color:#8cf;">${inputBhtG.toFixed(2)}</td><td>${inputToPhr(inputBhtG)}</td><td style="color:#ad8;">${inputToWtPct(inputBhtG)}</td></tr>`;
                if (inputZnoG > 0) inputSummaryRows += `<tr style="background:rgba(80,100,80,0.1);"><td>ZnO</td><td style="color:#8cf;">${inputZnoG.toFixed(2)}</td><td>${inputToPhr(inputZnoG)}</td><td style="color:#ad8;">${inputToWtPct(inputZnoG)}</td></tr>`;
                if (inputUreaG > 0) inputSummaryRows += `<tr style="background:rgba(80,100,80,0.1);"><td>Modified Urea</td><td style="color:#8cf;">${inputUreaG.toFixed(2)}</td><td>${inputToPhr(inputUreaG)}</td><td style="color:#ad8;">${inputToWtPct(inputUreaG)}</td></tr>`;
                if (inputPowderG > 0) inputSummaryRows += `<tr style="background:rgba(80,100,80,0.1);"><td>Powder (ÂÖ∂‰ªñÁ≤âÈ´î)</td><td style="color:#8cf;">${inputPowderG.toFixed(2)}</td><td>${inputToPhr(inputPowderG)}</td><td style="color:#ad8;">${inputToWtPct(inputPowderG)}</td></tr>`;
                
                // v7.5.1: Ê∏¨Ë©¶Áâ© - Á¥ÖËâ≤Âä†Á≤ó
                if (inputTestG > 0) inputSummaryRows += `<tr class="test-row" style="background:rgba(200,80,80,0.15); border: 1px dashed #c55;"><td style="color:#c33; font-weight:bold;">TEST: ${testName || 'Unknown'}${testNote ? ' ('+testNote+')' : ''}</td><td style="color:#c33; font-weight:bold;">${inputTestG.toFixed(2)}</td><td style="color:#c33; font-weight:bold;">${inputToPhr(inputTestG)}</td><td style="color:#c33; font-weight:bold;">${inputToWtPct(inputTestG)}</td></tr>`;
                
                // v7.5.1: Ë®àÁÆóÈ†ê‰º∞È´îÁ©ç (cm¬≥) = ÈáçÈáè(g) / ÂØÜÂ∫¶(g/cm¬≥)
                const estimatedVolume = totalInputG / theoreticalDensity;
                
                // v7.5.1: Êõ¥Êñ∞ currentCalc ‰æõÂàóÂç∞‰ΩøÁî®
                currentCalc.totalFormulaWeightG = totalInputG;
                currentCalc.estimatedVolume = estimatedVolume;
                
                document.getElementById('inputSummaryTable').innerHTML = `
                    <tr><th>Material</th><th>Weight (${inputUnit})</th><th>phr</th><th>wt%</th></tr>
                    ${inputSummaryRows}
                    <tr style="background:rgba(60,80,60,0.2); font-weight:bold;">
                        <td><strong>Total Formula</strong></td>
                        <td style="color:#8cf;"><strong>${totalInputG.toFixed(1)}</strong></td>
                        <td><strong>${(totalInputG / actualTotalResinG * 100).toFixed(2)}</strong></td>
                        <td style="color:#ad8;"><strong>100.00</strong></td>
                    </tr>
                    <tr style="background:rgba(80,100,120,0.15);">
                        <td><strong>Density</strong></td>
                        <td colspan="3" style="color:#8cf;"><strong>${theoreticalDensity.toFixed(3)} g/cm¬≥</strong></td>
                    </tr>
                    <tr style="background:rgba(100,80,120,0.15);">
                        <td><strong>Est. Volume</strong></td>
                        <td colspan="3" style="color:#c9f;"><strong>${estimatedVolume.toFixed(1)} cm¬≥</strong> (${(estimatedVolume/1000).toFixed(3)} L)</td>
                    </tr>
                `;
                
                // v7.5: Input Summary Âè™Âú® Lab Mode È°ØÁ§∫
                document.getElementById('inputSummarySection').style.display = isLabMode ? 'block' : 'none';
                
                // v7.4.2: Ë®àÁÆóÂêÑÈòªÁáÉÂäëÁöÑ phr (ÂØ¶ÈöõÊàêÂàÜÔºåÂ∑≤ÂæûÊØçÁ≤íÊãÜËß£)
                const brPlusSb_phr = br_phr + sb_phr;
                
                // Ë®àÁÆóÊ®πËÑÇ wt%
                const evaWtPct = phrToWtPct((totalEVA16 + eva25)/totalResin*100);
                const ldpeWtPct = phrToWtPct(totalLDPE/totalResin*100);
                const resinWtPct = phrToWtPct(100);
                
                document.getElementById('decompTable').innerHTML = `
                    <tr><th>Component</th><th>phr</th>${wtPctCol}${weightCol}<th>Note</th></tr>
                    <tr><td>Total EVA</td><td>${((totalEVA16 + eva25)/totalResin*100).toFixed(2)}</td>${wtPctCell((totalEVA16 + eva25)/totalResin*100)}${weightCell((totalEVA16 + eva25)/totalResin*100)}<td>VA${weightedVA.toFixed(1)}% (Crosslink Eff. ${(crosslinkEff*100).toFixed(0)}%)</td></tr>
                    <tr><td>Total LDPE</td><td>${(totalLDPE/totalResin*100).toFixed(2)}</td>${wtPctCell(totalLDPE/totalResin*100)}${weightCell(totalLDPE/totalResin*100)}<td>-</td></tr>
                    ${poe > 0 ? `<tr><td>POE</td><td>${(poe/totalResin*100).toFixed(2)}</td>${wtPctCell(poe/totalResin*100)}${weightCell(poe/totalResin*100)}<td>Foam +${((poeEffect-1)*100).toFixed(1)}%</td></tr>` : ''}
                    <tr style="background:rgba(100,90,80,0.15);"><td><strong>Total Resin</strong></td><td><strong>100.00</strong></td><td style="color:#ad8;"><strong>${resinWtPct}</strong></td><td style="color:#8cf;"><strong>${(actualTotalResinG * weightMultiplier).toFixed(isLabMode ? 1 : 3)}</strong></td><td>Density ${theoreticalDensity.toFixed(3)} g/cm¬≥</td></tr>
                    <tr><td>AC</td><td>${ac_phr.toFixed(2)}</td>${wtPctCell(ac_phr)}${weightCell(ac_phr)}<td>from MB (50%), Decomp. ${(totalACDecomposition*100).toFixed(1)}%</td></tr>
                    <tr><td>DCP</td><td>${dcp_phr.toFixed(3)}</td>${wtPctCell(dcp_phr)}${weightCell(dcp_phr)}<td>Reaction ${totalReaction.toFixed(1)}%, Index ${dcpEval.crosslinkIndex.toFixed(3)}</td></tr>
                    <tr><td>ZnO</td><td>${zno_phr.toFixed(3)}</td>${wtPctCell(zno_phr)}${weightCell(zno_phr)}<td>AC ratio ${znoAcRatio.toFixed(2)}%, Temp -${znoEffect.tempReduction.toFixed(0)}¬∞C ${znoEffect.optimalRange ? '[OK]' : ''}</td></tr>
                    <tr><td>Urea</td><td>${urea_phr.toFixed(3)}</td>${wtPctCell(urea_phr)}${weightCell(urea_phr)}<td>AC ratio ${ureaAcRatio.toFixed(2)}%, Rate +${((unicellEffect.rateMultiplier-1)*100).toFixed(0)}% ${unicellEffect.optimalRange ? '[OK]' : ''}</td></tr>
                    <tr style="background:rgba(80,100,120,0.12);"><td><strong>Inorganic Filler</strong></td><td><strong>${inorganicFiller_phr.toFixed(2)}</strong></td><td style="color:#ad8;"><strong>${phrToWtPct(inorganicFiller_phr)}</strong></td>${showWeightInPhr ? `<td style="color:#8cf;"><strong>${phrToG(inorganicFiller_phr)}</strong></td>` : ''}<td>Talc ${talc_phr.toFixed(1)} + CaCO‚ÇÉ ${caco3_phr.toFixed(1)} + Powder ${powder_phr.toFixed(1)}</td></tr>
                    <tr style="background:rgba(100,80,100,0.12);"><td>Pigment</td><td>${pigment_phr_separate.toFixed(2)}</td>${wtPctCell(pigment_phr_separate)}${weightCell(pigment_phr_separate)}<td>from Color MB (37%)</td></tr>
                    
                    <tr style="background:rgba(120,80,80,0.08);"><td colspan="5" style="color:#c99; font-weight:bold; padding-top:8px;">Flame Retardant System</td></tr>
                    ${ath_phr > 0 ? `<tr style="background:rgba(120,80,80,0.05);"><td style="padding-left:20px;">ATH</td><td>${ath_phr.toFixed(2)}</td>${wtPctCell(ath_phr)}${weightCell(ath_phr)}<td>Direct input, 40-60 phr optimal</td></tr>` : ''}
                    ${redPhos_phr > 0 ? `<tr style="background:rgba(120,80,80,0.05);"><td style="padding-left:20px;">Red-P</td><td>${redPhos_phr.toFixed(2)}</td>${wtPctCell(redPhos_phr)}${weightCell(redPhos_phr)}<td>from MB (50%), 2.5-10 phr optimal</td></tr>` : ''}
                    ${br_phr > 0 ? `<tr style="background:rgba(120,80,80,0.05);"><td style="padding-left:20px;">Br</td><td>${br_phr.toFixed(2)}</td>${wtPctCell(br_phr)}${weightCell(br_phr)}<td>from Br/Sb MB, 6-15 phr optimal</td></tr>` : ''}
                    ${sb_phr > 0 ? `<tr style="background:rgba(120,80,80,0.05);"><td style="padding-left:20px;">Sb‚ÇÇO‚ÇÉ</td><td>${sb_phr.toFixed(2)}</td>${wtPctCell(sb_phr)}${weightCell(sb_phr)}<td>from Br/Sb MB, 2-5 phr (Br:Sb‚âà3:1)</td></tr>` : ''}
                    ${cp70_phr > 0 ? `<tr style="background:rgba(120,80,80,0.05);"><td style="padding-left:20px;">CP-70</td><td>${cp70_phr.toFixed(2)}</td>${wtPctCell(cp70_phr)}${weightCell(cp70_phr)}<td>Direct input, 3-7 phr optimal</td></tr>` : ''}
                    <tr style="background:rgba(120,80,80,0.12);"><td><strong>Total FR</strong></td><td><strong>${flameRetardant_phr.toFixed(2)}</strong></td><td style="color:#ad8;"><strong>${phrToWtPct(flameRetardant_phr)}</strong></td><td style="color:#f99;"><strong>${phrToG(flameRetardant_phr)}</strong></td><td>Suppress ${((frSuppression-1)*100).toFixed(1)}%, Crosslink Eff. ${(frEffect.crosslinkInterference*100).toFixed(0)}%</td></tr>
                    
                    <tr style="background:rgba(60,80,60,0.15);"><td colspan="5" style="color:#8ca; font-weight:bold; padding-top:8px;">Formula Summary</td></tr>
                    <tr style="background:rgba(60,80,60,0.1);"><td><strong>Total Formula</strong></td><td><strong>${totalFormulaPhr.toFixed(2)}</strong></td><td style="color:#ad8;"><strong>100.00</strong></td><td style="color:#8cf;"><strong>${totalFormulaWeightG.toFixed(isLabMode ? 1 : 3)}</strong></td><td>Resin ${resinWtPct}% + Additives ${(100-parseFloat(resinWtPct)).toFixed(2)}%</td></tr>
                    
                    <tr style="background:rgba(100,90,70,0.12);"><td><strong>Mixing</strong></td><td>-</td><td>-</td><td>-</td><td>${rotorSpeed}rpm/${mixTime}min, Dosage ${dosageTemp}¬∞C ‚Üí Discharge ${dischargeTemp.toFixed(0)}¬∞C ${isManualDischargeTemp ? '[Manual]' : '[Calc]'}</td></tr>
                    <tr style="background:rgba(140,100,70,0.12);"><td><strong>DCP Loss (Mixing)</strong></td><td>${(mixingDCPLoss.loss * 100).toFixed(1)}%</td><td>-</td><td>-</td><td>Exposure ${mixingDCPLoss.exposureTime.toFixed(1)}min, Avg ${mixingDCPLoss.avgTemp.toFixed(0)}¬∞C, Remaining ${dcpEval.dcpAfterMixing.toFixed(3)}phr</td></tr>
                    <tr style="background:rgba(140,120,70,0.12);"><td><strong>AC Loss (Mixing)</strong></td><td>${(mixingACLoss.loss * 100).toFixed(1)}%</td><td>-</td><td>-</td><td>AC Eff. Decomp. Temp ${mixingACLoss.acEffectiveDecompTemp.toFixed(0)}¬∞C (ACF06 203¬∞C - ZnO ${znoEffect.tempReduction.toFixed(0)}¬∞C - Urea ${unicellEffect.tempReduction.toFixed(0)}¬∞C)</td></tr>
                    <tr style="background:rgba(80,100,80,0.15);"><td><strong>Effective AC</strong></td><td><strong>${effectiveAC.toFixed(2)}</strong></td><td style="color:#ad8;"><strong>${phrToWtPct(effectiveAC)}</strong></td><td style="color:#8cf;"><strong>${phrToG(effectiveAC)}</strong></td><td>After all effects, Foaming Temp vs AC Decomp Temp: ${temp1}¬∞C vs ${acDecomp1.acEffectiveDecompTemp.toFixed(0)}¬∞C (${acDecomp1.tempAboveDecomp >= 0 ? '+' : ''}${acDecomp1.tempAboveDecomp.toFixed(0)}¬∞C)</td></tr>
                `;
                
                // ==================== ÂàÜÈõ¢ÂàÜÊûêÈ°ØÁ§∫ ====================
                // v7.3.3: Â¢ûÂä† decimals ÂèÉÊï∏ÊéßÂà∂È°ØÁ§∫Á≤æÂ∫¶
                function createOptimalCurveHTML(value, min, optMin, optMax, max, label, unit, color, decimals = 2) {
                    const range = max - min;
                    const position = Math.min(100, Math.max(0, ((value - min) / range) * 100));
                    const optStart = ((optMin - min) / range) * 100;
                    const optEnd = ((optMax - min) / range) * 100;
                    
                    return `
                        <div class="optimal-curve">
                            <div style="font-size: 11px; color: #999; margin-bottom: 5px;">${label}: <strong style="color: ${color};">${value.toFixed(decimals)} ${unit}</strong></div>
                            <div class="curve-bar" style="background: linear-gradient(to right, 
                                rgba(140,80,80,0.5) 0%, 
                                rgba(140,80,80,0.5) ${optStart}%, 
                                rgba(80,120,80,0.6) ${optStart}%, 
                                rgba(80,120,80,0.6) ${optEnd}%, 
                                rgba(140,80,80,0.5) ${optEnd}%, 
                                rgba(140,80,80,0.5) 100%);">
                                <div class="curve-indicator" style="left: ${position}%;"></div>
                            </div>
                            <div class="curve-labels">
                                <span>${min.toFixed(decimals)}</span>
                                <span style="color: #43e97b;">Optimal: ${optMin.toFixed(decimals)}-${optMax.toFixed(decimals)}</span>
                                <span>${max.toFixed(decimals)}</span>
                            </div>
                        </div>
                    `;
                }
                
                document.getElementById('separatedAnalysis').innerHTML = `
                    <div class="category-section filler">
                        <div class="category-title">
                            <span style="font-weight: bold;">[Â°´Êñô]</span> ÁÑ°Ê©üÂ°´Êñô (Inorganic Fillers) - ÂÖ∑ÊàêÊ†∏ÊïàÊûú
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <div style="background: rgba(79,172,254,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #4facfe;">Talc</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${talc_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #8cf;">${phrToG(talc_phr)} g</div>` : ''}
                            </div>
                            <div style="background: rgba(79,172,254,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #4facfe;">CaCO3</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${caco3_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #8cf;">${phrToG(caco3_phr)} g</div>` : ''}
                            </div>
                            <div style="background: rgba(79,172,254,0.1); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #4facfe;">Powder</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${powder_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #8cf;">${phrToG(powder_phr)} g</div>` : ''}
                            </div>
                            <div style="background: rgba(79,172,254,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #4facfe;">Total</div>
                                <div style="font-size: 18px; font-weight: 700; color: #4facfe;">${inorganicFiller_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #8cf;">${phrToG(inorganicFiller_phr)} g</div>` : ''}
                            </div>
                        </div>
                        ${createOptimalCurveHTML(inorganicFiller_phr, 0, 5, 20, 35, 'ÁÑ°Ê©üÂ°´ÊñôÊ∑ªÂä†Èáè', 'phr', '#4facfe')}
                        <div style="font-size: 11px; color: #888; margin-top: 8px;">
                            Ref: MDPI Polymers 2023 - Optimal 5-20 phr, >20 phr suppresses foaming, >30 phr critical
                        </div>
                    </div>
                    
                    <div class="category-section flame-retardant" style="margin-top: 15px;">
                        <div class="category-title">
                            <span style="font-weight: bold;">[ÈòªÁáÉ]</span> ÈòªÁáÉÂäë (Flame Retardants)
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <div style="background: rgba(180,80,80,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c77;">ATH</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${ath_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #f99;">${phrToG(ath_phr)} g</div>` : ''}
                                <div style="font-size: 9px; color: ${frEffect.athEffect.status === 'optimal' ? '#8c8' : '#cc9'};">${frEffect.athEffect.status === 'low' ? 'ÊïàÊûúÊúâÈôê' : frEffect.athEffect.status === 'optimal' ? 'ÈÅ©‰∏≠' : 'ÂÅèÈ´ò'}</div>
                            </div>
                            <div style="background: rgba(180,80,80,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c77;">Red-P</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${redPhos_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #f99;">${phrToG(redPhos_phr)} g</div>` : ''}
                                <div style="font-size: 9px; color: ${frEffect.rpEffect.status === 'optimal' ? '#8c8' : frEffect.rpEffect.status === 'warning' ? '#cc9' : '#c77'};">${frEffect.rpEffect.status === 'low' ? 'ÂÅè‰Ωé' : frEffect.rpEffect.status === 'optimal' ? 'ÊúÄ‰Ω≥' : 'ÈÅéÈ´ò'}</div>
                            </div>
                            <div style="background: rgba(180,80,80,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c77;">Br+Sb</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${(br_phr + sb_phr).toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #f99;">${phrToG(br_phr + sb_phr)} g</div>` : ''}
                                <div style="font-size: 9px; color: #999;">Ratio ${sb_phr > 0 ? (br_phr/sb_phr).toFixed(1) : 'N/A'}:1</div>
                            </div>
                            <div style="background: rgba(180,80,80,0.15); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c77;">CP-70</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${cp70_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 11px; color: #f99;">${phrToG(cp70_phr)} g</div>` : ''}
                                <div style="font-size: 9px; color: ${cp70_phr >= 3 && cp70_phr <= 7 ? '#8c8' : cp70_phr > 0 ? '#cc9' : '#999'};">${cp70_phr === 0 ? '-' : cp70_phr < 3 ? 'ÂÅè‰Ωé' : cp70_phr <= 7 ? 'ÊúÄ‰Ω≥' : 'ÈÅéÈ´ò'}</div>
                            </div>
                            <div style="background: rgba(180,80,80,0.25); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #c77;">Total FR</div>
                                <div style="font-size: 18px; font-weight: 700; color: #c99;">${flameRetardant_phr.toFixed(1)}<span style="font-size: 10px;"> phr</span></div>
                                ${showWeightInPhr ? `<div style="font-size: 12px; color: #faa; font-weight:bold;">${phrToG(flameRetardant_phr)} g</div>` : ''}
                            </div>
                        </div>
                        
                        <!-- ATH Ë≠¶Á§∫Êõ≤Á∑ö (40-60 phr optimal) -->
                        ${ath_phr > 0 ? `
                        <div style="margin-bottom: 8px;">
                            ${createOptimalCurveHTML(ath_phr, 0, 40, 60, 80, 'ATHÊ∑ªÂä†Èáè', 'phr', '#b85')}
                            <div style="font-size: 10px; color: #777; margin-top: 2px;">ATH: 40-60 phr optimal for FR effect</div>
                        </div>
                        ` : ''}
                        
                        <!-- Á¥ÖÁ£∑Ë≠¶Á§∫Êõ≤Á∑ö (2.5-10 phr optimal) -->
                        ${redPhos_phr > 0 ? `
                        <div style="margin-bottom: 8px;">
                            ${createOptimalCurveHTML(redPhos_phr, 0, 2.5, 10, 20, 'Á¥ÖÁ£∑Ê∑ªÂä†Èáè', 'phr', '#c77')}
                            <div style="font-size: 10px; color: #777; margin-top: 2px;">Red-P: 2.5-10 phr optimal, >10 affects crosslink</div>
                        </div>
                        ` : ''}
                        
                        <!-- Br/Sb System curve (Br+Sb 8-20 phr optimal, Br:Sb=3:1) -->
                        ${(br_phr + sb_phr) > 0 ? `
                        <div style="margin-bottom: 8px;">
                            ${createOptimalCurveHTML((br_phr + sb_phr), 0, 8, 20, 30, 'Br/Sb System (Br+Sb)', 'phr', '#c97')}
                            <div style="font-size: 10px; color: #777; margin-top: 2px;">Br+Sb: 8-20 phr optimal (Br:Sb=3:1), Br=${br_phr.toFixed(1)} + Sb=${sb_phr.toFixed(1)} phr</div>
                        </div>
                        ` : ''}
                        
                        <!-- CP-70 Ë≠¶Á§∫Êõ≤Á∑ö (3-7 phr optimal) -->
                        ${cp70_phr > 0 ? `
                        <div style="margin-bottom: 8px;">
                            ${createOptimalCurveHTML(cp70_phr, 0, 3, 7, 12, 'CP-70 Content', 'phr', '#7c9')}
                            <div style="font-size: 10px; color: #777; margin-top: 2px;">CP-70: 3-7 phr optimal, >10 severely affects crosslink</div>
                        </div>
                        ` : ''}
                        
                        <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <div style="font-size: 11px; color: #e0e0e0;">
                                <strong>Crosslink Interference:</strong> 
                                <span style="color: ${frEffect.crosslinkInterference >= 0.95 ? '#8c8' : frEffect.crosslinkInterference >= 0.85 ? '#cc9' : '#c77'};">
                                    ${(frEffect.crosslinkInterference * 100).toFixed(1)}%
                                </span>
                                ${frEffect.crosslinkInterference < 1 ? ` (DCP efficiency loss ${((1 - frEffect.crosslinkInterference) * 100).toFixed(1)}%)` : ''}
                            </div>
                            <div style="font-size: 11px; color: #e0e0e0; margin-top: 5px;">
                                <strong>Flame Retardancy Index:</strong> 
                                <span style="color: ${frEffect.flameRetardancy >= 70 ? '#8c8' : frEffect.flameRetardancy >= 40 ? '#cc9' : '#c77'};">
                                    ${frEffect.flameRetardancy.toFixed(0)}%
                                </span>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 8px;">
                            Ref: MDPI Molecules 2023, ScienceDirect 2021 - Br:Sb=3:1 for optimal synergy
                        </div>
                    </div>
                    
                    <div class="category-section" style="margin-top: 15px; background: linear-gradient(135deg, rgba(100,120,140,0.2), rgba(80,100,120,0.2)); border: 1px solid rgba(100,120,140,0.4); padding: 15px; border-radius: 10px;">
                        <div class="category-title">
                            <span style="font-weight: bold;">[‰∫§ËÅØ]</span> DCP Crosslink Analysis
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 10px;">
                            <div style="background: rgba(100,120,140,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">DCP Actual</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${dcp_phr.toFixed(3)}<span style="font-size: 10px;"> phr</span></div>
                            </div>
                            <div style="background: rgba(100,120,140,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">BHT Consumes</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${dcpEval.bhtDcpConsumption > 0.05 ? '#cc9' : 'white'};">-${dcpEval.bhtDcpConsumption.toFixed(3)}<span style="font-size: 10px;"> phr</span></div>
                                <div style="font-size: 9px; color: #999;">BHT ${bht_phr.toFixed(3)} phr √ó 1.5</div>
                            </div>
                            <div style="background: rgba(100,120,140,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">Effective DCP</div>
                                <div style="font-size: 16px; font-weight: 700; color: ${dcpEval.effectiveDcp < dcpEval.effectiveDCPNeed ? '#c77' : '#8c8'};">${dcpEval.effectiveDcp.toFixed(3)}<span style="font-size: 10px;"> phr</span></div>
                            </div>
                            <div style="background: rgba(100,120,140,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">Effective Need</div>
                                <div style="font-size: 16px; font-weight: 700; color: white;">${dcpEval.effectiveDCPNeed.toFixed(3)}<span style="font-size: 10px;"> phr</span></div>
                                <div style="font-size: 9px; color: #999;">Base ${dcpEval.baseDCPNeed.toFixed(2)} + FR</div>
                            </div>
                            <div style="background: rgba(100,120,140,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">Effective VA%</div>
                                <div style="font-size: 16px; font-weight: 700; color: #9bf;">${dcpEval.effectiveVA.toFixed(1)}<span style="font-size: 10px;"> %</span></div>
                                <div style="font-size: 9px; color: #999;">Formula basis</div>
                            </div>
                            <div style="background: rgba(100,120,140,0.3); padding: 10px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #8aa;">Crosslink Index</div>
                                <div style="font-size: 18px; font-weight: 700; color: ${dcpEval.crosslinkIndex >= dcpEval.dynamicCI.ciOptimalLow && dcpEval.crosslinkIndex <= dcpEval.dynamicCI.ciOptimalHigh ? '#8c8' : dcpEval.crosslinkIndex >= dcpEval.dynamicCI.ciMin && dcpEval.crosslinkIndex <= dcpEval.dynamicCI.ciMax ? '#cc9' : '#c77'};">${dcpEval.crosslinkIndex.toFixed(3)}</div>
                                <div style="font-size: 9px; color: #999;">Range: ${dcpEval.dynamicCI.ciMin.toFixed(3)}~${dcpEval.dynamicCI.ciMax.toFixed(3)}</div>
                            </div>
                        </div>
                        
                        <!-- Êñ∞Â¢û: ÁôºÊ≥°ÂÄçÁéáË™øÊï¥ÂíåËâ≤ÊØçÂΩ±Èüø v7.2 -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 8px; margin-top: 10px;">
                            <div style="background: rgba(140,120,80,0.2); padding: 8px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #ca8;">Est. Expansion</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${dcpEval.estimatedExpansion > 25 ? '#8ca' : dcpEval.estimatedExpansion < 15 ? '#ca8' : 'white'};">${dcpEval.estimatedExpansion.toFixed(1)}<span style="font-size: 10px;">X</span></div>
                            </div>
                            <div style="background: rgba(140,120,80,0.2); padding: 8px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #ca8;">Expansion Factor</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${dcpEval.expansionFactor < 1 ? '#8ca' : dcpEval.expansionFactor > 1 ? '#ca8' : 'white'};">${dcpEval.expansionFactor.toFixed(2)}</div>
                                <div style="font-size: 9px; color: #999;">${dcpEval.expansionFactor < 1 ? '‚ÜìDCP' : dcpEval.expansionFactor > 1 ? '‚ÜëDCP' : 'Baseline'}</div>
                            </div>
                            <div style="background: rgba(140,100,140,0.2); padding: 8px; border-radius: 8px; text-align: center;">
                                <div style="font-size: 10px; color: #a8c;">Color MB Effect</div>
                                <div style="font-size: 14px; font-weight: 700; color: ${dcpEval.colorMBEffect > 0.1 ? '#ca8' : 'white'};">+${dcpEval.colorMBEffect.toFixed(3)}<span style="font-size: 10px;"> phr</span></div>
                                <div style="font-size: 9px; color: #999;">Pigment interference</div>
                            </div>
                        </div>
                        
                        ${createOptimalCurveHTML(dcpEval.crosslinkIndex, dcpEval.dynamicCI.ciMin * 0.7, dcpEval.dynamicCI.ciOptimalLow, dcpEval.dynamicCI.ciOptimalHigh, dcpEval.dynamicCI.ciMax * 1.1, 'Crosslink Index', '', '#8aa', 3)}
                        
                        <div style="margin-top: 10px; padding: 12px; background: rgba(0,0,0,0.25); border-radius: 8px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <div style="font-size: 13px; font-weight: 700; color: ${dcpEval.severity === 'good' ? '#8c8' : dcpEval.severity === 'warning' ? '#cc9' : dcpEval.severity === 'critical' ? '#c77' : '#8aa'};">
                                    [${dcpEval.severity.toUpperCase()}] Status: ${dcpEval.status}
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #ccc;">
                                <div><strong>Effective Reaction:</strong> ${dcpEval.effectiveReaction.toFixed(1)}%</div>
                                <div style="margin-top: 3px;"><strong>Supply Ratio:</strong> ${(dcpEval.dcpSupplyRatio * 100).toFixed(0)}% (Effective DCP / Need)</div>
                                <div style="margin-top: 3px;"><strong>Resin Efficiency:</strong> ${(crosslinkEff * 100).toFixed(0)}%</div>
                                <div style="margin-top: 3px;"><strong>BHT:</strong> ${bht_phr.toFixed(3)} phr, consumes ${dcpEval.bhtDcpConsumption.toFixed(3)} phr DCP equiv., interference ${((1-dcpEval.bhtInterference) * 100).toFixed(1)}%</div>
                                ${dcpEval.znoDcpBalance !== 'balanced' ? `<div style="margin-top: 5px; color: #cc9;"><strong>ZnO-DCP Balance:</strong> ${dcpEval.znoDcpBalance}</div>` : ''}
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-top: 8px; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 5px;">
                            <strong style="color: #aaa;">v7.4 CI Range (EVA√óExpansion Calibrated):</strong><br>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 5px;">
                                <div style="text-align: center; background: rgba(100,100,150,0.2); padding: 4px; border-radius: 4px;">
                                    <div style="font-size: 9px; color: #9aa;">Target CI</div>
                                    <div style="color: #bcf;">${dcpEval.dynamicCI.targetCI.toFixed(3)}</div>
                                    <div style="font-size: 8px; color: #777;">Base: ${dcpEval.dynamicCI.baseTarget.toFixed(2)}</div>
                                </div>
                                <div style="text-align: center; background: rgba(100,150,100,0.2); padding: 4px; border-radius: 4px;">
                                    <div style="font-size: 9px; color: #9a9;">EVA%</div>
                                    <div style="color: #cfc;">${((eva16_phr+eva25_phr)/(eva16_phr+eva25_phr+ldpe_phr+poe_phr)*100).toFixed(0)}%</div>
                                    <div style="font-size: 8px; color: #777;">${dcpEval.estimatedExpansion.toFixed(1)}X</div>
                                </div>
                                <div style="text-align: center; background: rgba(150,100,150,0.2); padding: 4px; border-radius: 4px;">
                                    <div style="font-size: 9px; color: #a9a;">Pigment</div>
                                    <div style="color: #cfc;">√ó${dcpEval.dynamicCI.pigmentFactor.toFixed(3)}</div>
                                    <div style="font-size: 8px; color: #777;">${pigment_phr_separate.toFixed(1)}phr</div>
                                </div>
                                <div style="text-align: center; background: rgba(150,100,100,0.2); padding: 4px; border-radius: 4px;">
                                    <div style="font-size: 9px; color: #a99;">FR</div>
                                    <div style="color: #fcc;">√ó${dcpEval.dynamicCI.frFactor.toFixed(3)}</div>
                                    <div style="font-size: 8px; color: #777;">${flameRetardant_phr.toFixed(1)}phr</div>
                                </div>
                            </div>
                            <div style="margin-top: 5px; text-align: center; color: #aaa;">
                                CI Range: <strong style="color: #8cf;">${dcpEval.dynamicCI.ciMin.toFixed(3)}</strong> ~ <strong style="color: #fc8;">${dcpEval.dynamicCI.ciMax.toFixed(3)}</strong>
                                (Optimal: ${dcpEval.dynamicCI.ciOptimalLow.toFixed(3)} ~ ${dcpEval.dynamicCI.ciOptimalHigh.toFixed(3)})
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('keyIndicators').innerHTML = `
                    <div class="result-card">
                        <div class="result-label">AC/DCP Ratio</div>
                        <div class="result-value">${acDcpRatio.toFixed(1)}</div>
                    </div>
                    <div class="result-card">
                        <div class="result-label">Weighted VA</div>
                        <div class="result-value">${weightedVA.toFixed(1)}<span class="result-unit">%</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, #4facfe, #00f2fe); color: #1a1a2e;">
                        <div class="result-label">ÁÑ°Ê©üÂ°´Êñô</div>
                        <div class="result-value">${inorganicFiller_phr.toFixed(1)}<span class="result-unit">phr</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, #8a6050, #6a4a3a); color: white;">
                        <div class="result-label">Flame Retardant</div>
                        <div class="result-value">${flameRetardant_phr.toFixed(1)}<span class="result-unit">phr</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, #7a6a50, #5a5040); color: white;">
                        <div class="result-label">Âá∫ÊñôÊ∫´Â∫¶ ${isManualDischargeTemp ? 'üìù' : 'üîÑ'}</div>
                        <div class="result-value">${dischargeTemp.toFixed(0)}<span class="result-unit">¬∞C</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, ${mixingDCPLoss.loss > 0.35 ? '#8a5050, #6a3030' : mixingDCPLoss.loss > 0.20 ? '#8a7a50, #6a5a30' : '#606a7a, #404a5a'}); color: white;">
                        <div class="result-label">DCPÊêçÂ§±(Ê∑∑Á∑¥)</div>
                        <div class="result-value">${(mixingDCPLoss.loss * 100).toFixed(0)}<span class="result-unit">%</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, #5a7a6a, #3a5a4a); color: white;">
                        <div class="result-label">Effective AC</div>
                        <div class="result-value">${effectiveAC.toFixed(2)}<span class="result-unit">phr</span></div>
                    </div>
                    <div class="result-card" style="background: linear-gradient(135deg, ${dcpEval.severity === 'good' ? '#5a7a6a, #3a5a4a' : dcpEval.severity === 'warning' ? '#8a7a50, #6a5a30' : dcpEval.severity === 'critical' ? '#8a5050, #6a3030' : '#5a6a7a, #3a4a5a'}); color: white;">
                        <div class="result-label">Index ${dcpEval.crosslinkIndex.toFixed(3)}</div>
                        <div class="result-value">${crosslinkFoamBalance}</div>
                    </div>
                `;
                
                document.getElementById('predictions').innerHTML = `
                    <div class="result-card highlight" style="background: linear-gradient(135deg, #8a7a50, #6a5a30);">
                        <div class="result-label">Expected Density</div>
                        <div class="result-value">${predictedDensity.toFixed(3)}<span class="result-unit">g/cm¬≥</span></div>
                    </div>
                    <div class="result-card highlight" style="background: linear-gradient(135deg, #5a7a6a, #3a5a4a);">
                        <div class="result-label">Expected Expansion</div>
                        <div class="result-value">${predictedExpansion.toFixed(1)}<span class="result-unit">X</span></div>
                    </div>
                    <div class="result-card" style="background: rgba(255, 255, 255, 0.08); color: #ccc;">
                        <div class="result-label">Theoretical Density</div>
                        <div class="result-value">${theoreticalDensity.toFixed(3)}<span class="result-unit">g/cm¬≥</span></div>
                    </div>
                `;
                
                // Ë≠¶Á§∫ËàáÂª∫Ë≠∞È°ØÁ§∫
                
                // v7.4: Âπ≥Ë°°ÊèêÁ§∫È°ØÁ§∫
                let balanceHTML = '';
                if (finalBalanceNotes.length > 0) {
                    balanceHTML = `
                        <div class="input-section" style="background: rgba(80, 100, 140, 0.2); border-color: #5a6a8a;">
                            <div class="section-title" style="color: #9ac;">üìä BALANCE ANALYSIS</div>
                            ${finalBalanceNotes.map(b => `
                                <div style="padding: 10px; margin: 5px 0; background: rgba(80, 100, 140, 0.15); border-left: 3px solid #5a6a8a; border-radius: 5px;">
                                    <div style="font-size: 13px; color: #abd; font-weight: bold; margin-bottom: 5px;">${b.title}</div>
                                    <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 5px;">
                                        ${b.factors.map(f => `<span style="background: rgba(100, 120, 160, 0.3); padding: 3px 8px; border-radius: 3px; font-size: 12px; color: #cde;">${f}</span>`).join('')}
                                    </div>
                                    <div style="font-size: 11px; color: #9ab;">üí° ${b.note}</div>
                                </div>
                            `).join('')}
                            <div style="padding: 8px; margin-top: 8px; background: rgba(100, 140, 100, 0.15); border-radius: 5px; font-size: 12px; color: #adc;">
                                <strong>Recommendation:</strong> Opposing factors detected. Suggest small batch trial to verify actual performance.
                            </div>
                        </div>
                    `;
                }
                
                let warningsHTML = '';
                if (finalWarnings.length > 0) {
                    warningsHTML = `
                        <div class="input-section" style="background: rgba(140, 80, 80, 0.2); border-color: #8a5050;">
                            <div class="section-title" style="color: #c99;">‚ö†Ô∏è WARNINGS</div>
                            ${finalWarnings.map(w => `<div style="padding: 8px; margin: 5px 0; background: rgba(140, 80, 80, 0.15); border-left: 3px solid #8a5050; border-radius: 5px; font-size: 13px; color: #dcc;">${w}</div>`).join('')}
                        </div>
                    `;
                }
                
                let suggestionsHTML = '';
                if (suggestions.length > 0) {
                    suggestionsHTML = `
                        <div class="input-section" style="background: rgba(80, 120, 100, 0.2); border-color: #5a7a6a;">
                            <div class="section-title" style="color: #9cb;">SUGGESTIONS</div>
                            ${suggestions.map(s => `<div style="padding: 8px; margin: 5px 0; background: rgba(80, 120, 100, 0.15); border-left: 3px solid #5a7a6a; border-radius: 5px; font-size: 13px; color: #cdc;">${s}</div>`).join('')}
                        </div>
                    `;
                }
                
                const resultsDiv = document.getElementById('results');
                const predictionsSection = resultsDiv.querySelector('.input-section:nth-child(4)');
                if (predictionsSection) {
                    const oldWarnings = resultsDiv.querySelectorAll('.input-section[style*="rgba(255, 107, 107"]');
                    oldWarnings.forEach(el => el.remove());
                    const oldSuggestions = resultsDiv.querySelectorAll('.input-section[style*="rgba(67, 233, 123"]');
                    oldSuggestions.forEach(el => el.remove());
                    
                    predictionsSection.insertAdjacentHTML('afterend', balanceHTML + warningsHTML + suggestionsHTML);
                }
                
                document.getElementById('results').style.display = 'block';
                document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert('Ë®àÁÆóÈåØË™§: ' + error.message);
            }
        }
        
        // ==================== Ê≠∑Âè≤Ë®òÈåÑÂäüËÉΩ ====================
        // ==================== v7.5.1: ÂàóÂç∞ Input Summary (Âê´Âä†Â∑•ÂèÉÊï∏) ====================
        function printInputSummary() {
            const productModel = document.getElementById('productModel').value || 'N/A';
            const batchId = document.getElementById('batchId').value || 'N/A';
            const productionDate = document.getElementById('productionDate').value || new Date().toISOString().split('T')[0];
            
            // ÂèñÂæóË®≠ÂÇôÈ°ûÂûã
            const mixerValue = document.getElementById('mixerVolume')?.value || '1';
            const isTwoRoll = mixerValue === '0';
            const equipmentName = isTwoRoll ? 'Two-Roll Mill' : `${mixerValue}L Internal Mixer`;
            
            // ÂèñÂæóÂä†Â∑•ÂèÉÊï∏
            const mixTime = document.getElementById('mixTime')?.value || '-';
            const mixInitTemp = document.getElementById('mixInitTemp')?.value || '-';
            const rotorSpeed = document.getElementById('rotorSpeed')?.value || '-';
            const dosageTemp = document.getElementById('dosageTemp')?.value || '-';
            const dischargeTemp = document.getElementById('dischargeTemp')?.value || '-';
            const temp1 = document.getElementById('temp1')?.value || '-';
            const time1 = document.getElementById('time1')?.value || '-';
            const temp2 = document.getElementById('temp2')?.value || '-';
            const time2 = document.getElementById('time2')?.value || '-';
            
            // v7.5.1: Ê†πÊìöË®≠ÂÇôÈ°ûÂûãÊ±∫ÂÆöÈ°ØÁ§∫ÂÖßÂÆπ
            const secondParam = isTwoRoll 
                ? { label: 'Initial Temp. (Steam)', value: `${mixInitTemp} ¬∞C` }
                : { label: 'Rotor Speed', value: `${rotorSpeed} rpm` };
            
            // ÂæûË®àÁÆóÁµêÊûúÂèñÂæóÈ†êÊ∏¨ÂÄº
            const targetExpansion = currentCalc?.predictedExpansion?.toFixed(1) || '-';
            const theoreticalDensity = currentCalc?.theoreticalDensity?.toFixed(3) || '-';
            const estimatedVolume = currentCalc?.estimatedVolume?.toFixed(1) || '-';
            const estimatedVolumeL = currentCalc?.estimatedVolume ? (currentCalc.estimatedVolume / 1000).toFixed(3) : '-';
            
            // ÂèñÂæó Input Summary Ë°®Ê†ºÂÖßÂÆπÔºàÁßªÈô§ÂØÜÂ∫¶ÂíåÈ´îÁ©çË°åÔºåÂõ†ÁÇ∫ÊúÉÂú®‰∏ãÊñπÈ°ØÁ§∫Ôºâ
            let inputTable = document.getElementById('inputSummaryTable').innerHTML;
            // ÁßªÈô§ÊúÄÂæåÂÖ©Ë°åÔºàDensity Âíå Est. VolumeÔºâ
            inputTable = inputTable.replace(/<tr style="background:rgba\(80,100,120.*?<\/tr>/g, '');
            inputTable = inputTable.replace(/<tr style="background:rgba\(100,80,120.*?<\/tr>/g, '');
            
            // v7.5.1: ÁßªÈô§ inline style È°èËâ≤ÔºåËÆì CSS class ÁîüÊïà
            inputTable = inputTable.replace(/style="color:#8cf;"/g, '');
            inputTable = inputTable.replace(/style="color:#ad8;"/g, '');
            // ÁßªÈô§ËÉåÊôØËâ≤ inline styleÔºà‰øùÁïôÂàóÂç∞ÊôÇ‰πæÊ∑®Ôºâ
            inputTable = inputTable.replace(/style="background:rgba\([^"]+\);"/g, '');
            inputTable = inputTable.replace(/style="background:rgba\([^"]+\); border[^"]+"/g, '');
            // Test Ê¨Ñ‰ΩçÔºöÂ∞áËû¢ÂπïÁ¥ÖËâ≤ #c33 ÊîπÁÇ∫ÂàóÂç∞Áî®Ê∑±Á¥ÖËâ≤
            inputTable = inputTable.replace(/style="color:#c33; font-weight:bold;"/g, 'class="test-cell"');
            
            // Âª∫Á´ãÂàóÂç∞Ë¶ñÁ™ó
            const printWindow = window.open('', '_blank', 'width=700,height=900');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Formula Sheet</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        
                        @page {
                            size: A4 portrait;
                            margin: 6mm 8mm;
                        }
                        
                        body { 
                            font-family: 'Arial', 'Microsoft JhengHei', sans-serif; 
                            padding: 0;
                            color: #333;
                            font-size: 14px;
                            line-height: 1.2;
                        }
                        
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 5px;
                            margin-bottom: 6px;
                        }
                        .header h1 {
                            font-size: 22px;
                            margin-bottom: 2px;
                        }
                        .header .subtitle {
                            font-size: 11px;
                            color: #555;
                        }
                        
                        .info-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 0;
                            margin-bottom: 6px;
                            border: 1px solid #999;
                        }
                        .info-item { 
                            text-align: center; 
                            padding: 5px 6px;
                            border-right: 1px solid #999;
                        }
                        .info-item:last-child { border-right: none; }
                        .info-label { font-size: 11px; color: #666; margin-bottom: 1px; }
                        .info-value { font-size: 15px; font-weight: bold; }
                        
                        h3 {
                            margin: 6px 0 3px 0;
                            padding: 3px 6px;
                            background: #e0e0e0;
                            font-size: 13px;
                            color: #333;
                            border-left: 3px solid #4a5a6a;
                        }
                        
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 6px;
                            font-size: 15px;
                        }
                        th, td {
                            border: 1px solid #888;
                            padding: 4px 6px;
                            text-align: left;
                        }
                        th {
                            background: #4a5a6a;
                            color: white;
                            font-weight: bold;
                            font-size: 13px;
                            padding: 3px 6px;
                        }
                        tr:nth-child(even) { background: #f0f0f0; }
                        
                        /* v7.5.1: ÈÖçÊñπË°®Ê†ºÊï∏ÂÄºÊ¨Ñ‰ΩçÈ°èËâ≤ */
                        .formula-table td:nth-child(2) { color: #000; font-weight: bold; }  /* Weight - ÈªëËâ≤Âä†Á≤ó */
                        .formula-table td:nth-child(3) { color: #1565c0; }  /* phr - Ê∑±Ëóç‰∏çÂä†Á≤ó */
                        .formula-table td:nth-child(4) { color: #2e7d32; }  /* wt% - Ê∑±Á∂†‰∏çÂä†Á≤ó */
                        .formula-table tr:last-child { background: #c8e6c9; font-weight: bold; }
                        .formula-table tr:last-child td { color: #333 !important; }
                        
                        /* v7.5.1: Test Ê¨Ñ‰Ωç - Á¥ÖËâ≤Âä†Á≤ó */
                        .formula-table .test-cell { color: #c00 !important; font-weight: bold !important; }
                        .formula-table .test-row { background: #ffe0e0 !important; }
                        .formula-table tr.test-row td { color: #c00 !important; font-weight: bold !important; }
                        
                        .footer {
                            margin-top: 10px;
                            padding-top: 6px;
                            border-top: 1px dashed #888;
                            display: grid;
                            grid-template-columns: 1fr 1fr 1fr;
                            gap: 8px;
                        }
                        .sign-box {
                            text-align: center;
                            padding-top: 18px;
                            border-top: 1px solid #333;
                        }
                        .sign-label { margin-top: 2px; font-size: 11px; color: #555; }
                        
                        .print-info {
                            display: flex;
                            justify-content: space-between;
                            margin-top: 8px;
                            font-size: 9px;
                            color: #888;
                            padding-top: 4px;
                            border-top: 1px solid #ddd;
                        }
                        
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none !important; }
                        }
                        
                        @media screen {
                            body { padding: 15px; max-width: 210mm; margin: 0 auto; background: #f0f0f0; }
                            .page-container { background: white; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Laboratory Formulation Sheet</h1>
                        <div class="subtitle">Polymer Foaming Process Predictor v7.5.1</div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Product Model</div>
                            <div class="info-value">${productModel}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Batch ID</div>
                            <div class="info-value">${batchId}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Date</div>
                            <div class="info-value">${productionDate}</div>
                        </div>
                    </div>
                    
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Density</div>
                            <div class="info-value">${theoreticalDensity} g/cm¬≥</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Est. Volume</div>
                            <div class="info-value">${estimatedVolume} cm¬≥ (${estimatedVolumeL} L)</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Target Expansion</div>
                            <div class="info-value">${targetExpansion} X</div>
                        </div>
                    </div>
                    
                    <h3>FORMULATION DETAILS</h3>
                    <table class="formula-table">
                        ${inputTable}
                    </table>
                    
                    <h3>PROCESSING PARAMETERS</h3>
                    <table>
                        <tr>
                            <th colspan="4">${equipmentName}</th>
                        </tr>
                        <tr>
                            <td style="width:25%;">Mix Time</td>
                            <td style="width:25%; font-weight:bold;">${mixTime} min</td>
                            <td style="width:25%;">${secondParam.label}</td>
                            <td style="width:25%; font-weight:bold;">${secondParam.value}</td>
                        </tr>
                        <tr>
                            <td>Dosage Temp.</td>
                            <td style="font-weight:bold;">${dosageTemp} ¬∞C</td>
                            <td>Discharge Temp.</td>
                            <td style="font-weight:bold;">${dischargeTemp} ¬∞C</td>
                        </tr>
                        <tr>
                            <th colspan="4">Foaming Conditions</th>
                        </tr>
                        <tr>
                            <td>1st Stage</td>
                            <td style="font-weight:bold;">${temp1} ¬∞C / ${time1} min</td>
                            <td>2nd Stage</td>
                            <td style="font-weight:bold;">${temp2} ¬∞C / ${time2} min</td>
                        </tr>
                    </table>
                    
                    <div class="footer">
                        <div class="sign-box">
                            <div class="sign-label">Prepared by</div>
                        </div>
                        <div class="sign-box">
                            <div class="sign-label">Verified by</div>
                        </div>
                        <div class="sign-box">
                            <div class="sign-label">Approved by</div>
                        </div>
                    </div>
                    
                    <div class="print-info">
                        <span>Polymer Foaming Process Predictor</span>
                        <span>${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                    
                    <div class="no-print" style="text-align:center; margin-top:20px;">
                        <button onclick="window.print()" style="padding:10px 30px; font-size:14px; cursor:pointer;">
                            Print
                        </button>
                        <button onclick="window.close()" style="padding:10px 30px; font-size:14px; cursor:pointer; margin-left:10px;">
                            Close
                        </button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        }
        
        function saveToHistory() {
            if (!isAuthenticated) {
                alert('Ë´ãÂÖàÁôªÂÖ•ÔºÅ');
                return;
            }
            if (!currentCalc) {
                alert('Ë´ãÂÖàÂü∑Ë°åË®àÁÆóÔºÅ');
                return;
            }
            
            let qualityScore = 100;
            if (currentCalc.warnings) {
                qualityScore -= currentCalc.warnings.length * 10;
            }
            qualityScore = Math.max(0, Math.min(100, qualityScore));
            
            currentCalc.timestamp = new Date().toISOString();
            currentCalc.qualityScore = qualityScore;
            
            // v7.3.6: Ê†πÊìöÊ®°ÂºèÂÑ≤Â≠òÂà∞‰∏çÂêåÁöÑHistory
            if (currentMode === 'lab') {
                historyDataLab.unshift(currentCalc);
                if (historyDataLab.length > 100) {
                    historyDataLab = historyDataLab.slice(0, 100);
                }
                localStorage.setItem('foamHistoryLab', JSON.stringify(historyDataLab));
            } else {
                historyData.unshift(currentCalc);
                if (historyData.length > 100) {
                    historyData = historyData.slice(0, 100);
                }
                localStorage.setItem('foamHistory', JSON.stringify(historyData));
            }
            
            updateHistoryTable();
            showToast(`Saved! Score: ${qualityScore}${currentMode === 'lab' ? ' [Lab]' : ''}`);
        }
        
        // v7.5.3: Toast notification (non-blocking)
        function showToast(msg, duration = 2500) {
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.textContent = msg;
            toast.style.cssText = 'position:fixed; bottom:80px; left:50%; transform:translateX(-50%); background:rgba(40,40,45,0.95); color:#F5F5F7; padding:10px 24px; border-radius:20px; font-size:13px; font-weight:500; z-index:99999; backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); box-shadow:0 4px 20px rgba(0,0,0,0.4); transition:opacity 0.4s; pointer-events:none;';
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 400); }, duration);
        }
        
        // v7.3.6: ËºâÂÖ•HistoryÔºàÊ†πÊìöÊ®°ÂºèÔºâ
        function loadHistory() {
            const storageKey = currentMode === 'lab' ? 'foamHistoryLab' : 'foamHistory';
            const saved = localStorage.getItem(storageKey);
            
            if (currentMode === 'lab') {
                historyDataLab = saved ? JSON.parse(saved) : [];
            } else {
                historyData = saved ? JSON.parse(saved) : [];
            }
            
            updateHistoryTable();
        }
        
        // v7.3.6: ÂèñÂæóÁï∂ÂâçÊ®°ÂºèÁöÑHistory
        function getCurrentHistory() {
            return currentMode === 'lab' ? historyDataLab : historyData;
        }
        
        function clearHistory() {
            if (!isAuthenticated) {
                alert('Please login first!');
                return;
            }
            const currentHistory = getCurrentHistory();
            if (currentHistory.length === 0) {
                alert('No records to clear!');
                return;
            }
            const modeLabel = currentMode === 'lab' ? 'Lab Mode' : 'Production Mode';
            if (confirm(`Are you sure you want to clear all ${modeLabel} history records? This action cannot be undone.`)) {
                if (currentMode === 'lab') {
                    historyDataLab = [];
                    localStorage.removeItem('foamHistoryLab');
                } else {
                    historyData = [];
                    localStorage.removeItem('foamHistory');
                }
                updateHistoryTable();
                showToast(`${modeLabel} history cleared`);
            }
        }
        
        function updateHistoryTable() {
            const tbody = document.getElementById('historyBody');
            const currentHistory = getCurrentHistory();
            
            // Calculate pagination
            const totalPages = Math.max(1, Math.ceil(currentHistory.length / historyPageSize));
            currentHistoryPage = Math.min(currentHistoryPage, totalPages - 1);
            currentHistoryPage = Math.max(0, currentHistoryPage);
            
            const startIdx = currentHistoryPage * historyPageSize;
            const endIdx = Math.min(startIdx + historyPageSize, currentHistory.length);
            const pageData = currentHistory.slice(startIdx, endIdx);
            
            // Update pagination info
            document.getElementById('pageInfo').textContent = `Page ${currentHistoryPage + 1} / ${totalPages} (${currentHistory.length} records)`;
            document.getElementById('prevPageBtn').disabled = currentHistoryPage === 0;
            document.getElementById('nextPageBtn').disabled = currentHistoryPage >= totalPages - 1;
            document.getElementById('prevPageBtn').style.opacity = currentHistoryPage === 0 ? '0.5' : '1';
            document.getElementById('nextPageBtn').style.opacity = currentHistoryPage >= totalPages - 1 ? '0.5' : '1';
            
            if (currentHistory.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#999;">No records</td></tr>';
                return;
            }
            
            tbody.innerHTML = pageData.map((r, localIdx) => {
                const globalIdx = startIdx + localIdx;  // Global index for functions
                const scoreColor = r.qualityScore >= 80 ? '#6a8a6a' : 
                                  r.qualityScore >= 60 ? '#8a8a5a' : '#8a5a5a';
                const warningCount = (r.warnings && r.warnings.length) || 0;
                const ciValue = r.dcpEval?.crosslinkIndex || 0;
                const ciMin = r.dcpEval?.dynamicCI?.ciMin || 0;
                const ciMax = r.dcpEval?.dynamicCI?.ciMax || 0;
                const ciStatus = ciValue >= ciMin && ciValue <= ciMax ? '#8c8' : '#c77';
                const modeTag = r.mode === 'lab' ? '<span style="color:#a8a;font-size:9px;">[LAB]</span>' : '';
                
                return `
                <tr style="cursor: pointer; transition: background 0.2s;" 
                    onmouseover="this.style.background='rgba(100,100,100,0.2)'" 
                    onmouseout="this.style.background='transparent'"
                    ondblclick="showBatchDetail(${globalIdx})">
                    <td onclick="loadHistoryToForm(${globalIdx})">${r.productionDate || 'N/A'}</td>
                    <td onclick="loadHistoryToForm(${globalIdx})">
                        <strong>${r.productModel || 'N/A'}</strong> ${modeTag}<br>
                        <small style="color: #999;">${r.batchId || ''}</small>
                    </td>
                    <td onclick="loadHistoryToForm(${globalIdx})">
                        <strong>${(r.predictedDensity || 0).toFixed(3)}</strong><br>
                        <small style="color: #8aa;">${(r.predictedExpansion || 0).toFixed(1)}X</small><br>
                        <small style="color: ${ciStatus};">CI:${ciValue.toFixed(3)}</small>
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <div onclick="showBatchDetail(${globalIdx})" style="width: 36px; height: 36px; border-radius: 50%; background: ${scoreColor}; display: flex; align-items: center; justify-content: center; color: #eee; font-weight: 700; font-size: 11px; cursor: pointer;" title="View detail">
                                ${r.qualityScore || 'N/A'}
                            </div>
                            <button onclick="event.stopPropagation(); loadHistoryToForm(${globalIdx});" 
                                    style="background: #4a6a5a; color: #cfc; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; white-space: nowrap;"
                                    title="Load to form">
                                Load
                            </button>
                            <button onclick="event.stopPropagation(); deleteHistoryRecord(${globalIdx});" 
                                    style="background: #6a4a4a; color: #fcc; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; white-space: nowrap;"
                                    title="Delete record">
                                Del
                            </button>
                        </div>
                    </td>
                </tr>
            `}).join('');
        }
        
        // v7.4: Change history page
        function changeHistoryPage(delta) {
            const currentHistory = getCurrentHistory();
            const totalPages = Math.max(1, Math.ceil(currentHistory.length / historyPageSize));
            const newPage = currentHistoryPage + delta;
            
            if (newPage >= 0 && newPage < totalPages) {
                currentHistoryPage = newPage;
                updateHistoryTable();
            }
        }
        
        // v7.3.1: Âà™Èô§ÂñÆÁ≠ÜÊ≠∑Âè≤Á¥ÄÈåÑ
        function deleteHistoryRecord(index) {
            if (!isAuthenticated) {
                alert('Please login first!');
                return;
            }
            
            const currentHistory = getCurrentHistory();
            const r = currentHistory[index];
            const confirmMsg = `Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§Á¥ÄÈåÑÂóéÔºü\n\n${r.productModel || 'N/A'} - ${r.batchId || 'N/A'}\nÊó•Êúü: ${r.productionDate || 'N/A'}\n\nÊ≠§Êìç‰ΩúÁÑ°Ê≥ïÂæ©Âéü„ÄÇ`;
            
            if (confirm(confirmMsg)) {
                currentHistory.splice(index, 1);
                const storageKey = currentMode === 'lab' ? 'foamHistoryLab' : 'foamHistory';
                localStorage.setItem(storageKey, JSON.stringify(currentHistory));
                updateHistoryTable();
                showToast('Record deleted');
            }
        }
        
        function showBatchDetail(index) {
            const currentHistory = getCurrentHistory();
            const r = currentHistory[index];
            let detailHTML = `
                <div style="max-width: 600px; max-height: 70vh; overflow-y: auto; color: #ccc;">
                    <h3 style="color: #a98; margin-bottom: 15px;">${r.productModel} - ${r.batchId}</h3>
                    
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 150px; background: rgba(100,90,80,0.2); padding: 12px; border-radius: 8px;">
                            <strong>Quality Score:</strong> <span style="color: ${r.qualityScore >= 80 ? '#8a8' : r.qualityScore >= 60 ? '#aa8' : '#a88'}; font-size: 24px; font-weight: 700;">${r.qualityScore || 'N/A'}</span>/100
                        </div>
                        <button onclick="loadHistoryToForm(${index}); this.closest('div[style*=fixed]').remove();" 
                                style="background: linear-gradient(135deg, #5a8a6a, #3a6a4a); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px;">
                            Load
                        </button>
                        <button onclick="if(confirm('Á¢∫ÂÆöÂà™Èô§Ê≠§Á¥ÄÈåÑÔºü')) { deleteHistoryRecord(${index}); this.closest('div[style*=fixed]').remove(); }" 
                                style="background: linear-gradient(135deg, #8a5a5a, #6a3a3a); color: white; border: none; padding: 12px 16px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px;">
                            Delete
                        </button>
                    </div>
                    
                    <table style="width: 100%; font-size: 13px; background: rgba(255,255,255,0.03);">
                        <tr><td><strong>Density:</strong></td><td>${(r.predictedDensity || 0).toFixed(3)} g/cm¬≥</td></tr>
                        <tr><td><strong>Expansion:</strong></td><td>${(r.predictedExpansion || 0).toFixed(1)} X</td></tr>
                        <tr><td><strong>AC:</strong></td><td>${(r.ac_phr || 0).toFixed(2)} phr</td></tr>
                        <tr><td><strong>DCP:</strong></td><td>${(r.dcp_phr || 0).toFixed(3)} phr</td></tr>
                        <tr><td><strong>AC/DCP:</strong></td><td>${(r.acDcpRatio || 0).toFixed(1)}</td></tr>
                        <tr style="background:rgba(80,100,120,0.15);"><td><strong>Inorganic Filler:</strong></td><td>${(r.inorganicFiller_phr || 0).toFixed(2)} phr</td></tr>
                        <tr style="background:rgba(120,80,80,0.15);"><td><strong>Flame Retardant:</strong></td><td>${(r.flameRetardant_phr || 0).toFixed(2)} phr</td></tr>
                        <tr><td><strong>Crosslink Index:</strong></td><td>${(r.dcpEval?.crosslinkIndex || 0).toFixed(3)} (${(r.dcpEval?.dynamicCI?.ciMin || 0).toFixed(3)}~${(r.dcpEval?.dynamicCI?.ciMax || 0).toFixed(3)})</td></tr>
                        <tr><td><strong>Crosslink:</strong></td><td>${(r.totalReaction || 0).toFixed(1)}%</td></tr>
                        <tr><td><strong>AC Decomp:</strong></td><td>${((r.totalACDecomposition || 0)*100).toFixed(1)}%</td></tr>
                        <tr><td><strong>Balance:</strong></td><td>${r.crosslinkFoamBalance || 'N/A'}</td></tr>
                    </table>
            `;
            
            if (r.warnings && r.warnings.length > 0) {
                detailHTML += `
                    <div style="margin-top: 15px; padding: 10px; background: rgba(120,80,80,0.15); border-left: 3px solid #8a5050; border-radius: 5px;">
                        <strong style="color: #c99;">Warnings (${r.warnings.length}):</strong><br>
                        ${r.warnings.map(w => `<div style="margin-top: 5px; font-size: 12px; color: #dcc;">- ${w}</div>`).join('')}
                    </div>
                `;
            }
            
            if (r.suggestions && r.suggestions.length > 0) {
                detailHTML += `
                    <div style="margin-top: 10px; padding: 10px; background: rgba(80,100,80,0.15); border-left: 3px solid #5a7a5a; border-radius: 5px;">
                        <strong style="color: #9b9;">Suggestions (${r.suggestions.length}):</strong><br>
                        ${r.suggestions.map(s => `<div style="margin-top: 5px; font-size: 12px; color: #cdc;">- ${s}</div>`).join('')}
                    </div>
                `;
            }
            
            detailHTML += `</div>`;
            
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: linear-gradient(135deg, #1a1a1e, #252530, #1e1e24); padding: 25px; border-radius: 10px; border: 1px solid rgba(100,100,100,0.3); max-width: 650px; width: 100%; position: relative;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 10px; right: 10px; background: #5a4a4a; color: #ccc; border: none; width: 30px; height: 30px; border-radius: 5px; cursor: pointer; font-size: 16px;">X</button>
                    ${detailHTML}
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // v7.3.6: Â∞áÊ≠∑Âè≤Ë®òÈåÑËºâÂÖ•Ë°®ÂñÆ (ËôïÁêÜLabÊ®°ÂºèÂñÆ‰Ωç)
        function loadHistoryToForm(index) {
            const currentHistory = getCurrentHistory();
            const r = currentHistory[index];
            if (!r) {
                alert('Record not found!');
                return;
            }
            
            // v7.4: ÂÖàÊ∏ÖÁ©∫ÊâÄÊúâËº∏ÂÖ•Ê¨Ñ‰Ωç
            clearAllInputs();
            
            // v7.3.6: Ê†πÊìöÁï∂ÂâçÊ®°ÂºèÂíåÁ¥ÄÈåÑÊ®°ÂºèÊ±∫ÂÆöÂñÆ‰ΩçËΩâÊèõ
            const isLabMode = (currentMode === 'lab');
            const resinMultiplier = isLabMode ? 1000 : 1;  // Lab: kg->g, Prod: kg->kg
            const mbMultiplier = isLabMode ? 1000 : 1;
            const tailMultiplier = isLabMode ? 1000 : 1;
            
            // ËºâÂÖ•Âü∫Êú¨Ë≥áË®ä
            document.getElementById('productModel').value = r.productModel || '';
            document.getElementById('batchId').value = r.batchId || '';
            document.getElementById('productionDate').valueAsDate = new Date();
            
            // ËºâÂÖ•ÂéüÂßãÈÖçÊñπ - Ê®πËÑÇÈ°û
            document.getElementById('eva16').value = r.raw_eva16_kg ? (r.raw_eva16_kg * resinMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('eva25').value = r.raw_eva25_kg ? (r.raw_eva25_kg * resinMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('ldpe24').value = r.raw_ldpe24_kg ? (r.raw_ldpe24_kg * resinMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('ldpe40').value = r.raw_ldpe40_kg ? (r.raw_ldpe40_kg * resinMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('poe').value = r.raw_poe_kg ? (r.raw_poe_kg * resinMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            
            // ËºâÂÖ•ÂéüÂßãÈÖçÊñπ - ÊØçÁ≤íÈ°û
            document.getElementById('acpe').value = r.raw_acpe_kg ? (r.raw_acpe_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('aceva').value = r.raw_aceva_kg ? (r.raw_aceva_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('filler').value = r.raw_filler_kg ? (r.raw_filler_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('color').value = r.raw_color_kg ? (r.raw_color_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('ath').value = r.raw_ath_kg ? (r.raw_ath_kg * (isLabMode ? 1000 : 1)).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('brsb').value = r.raw_brsb_kg ? (r.raw_brsb_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('redp').value = r.raw_redp_kg ? (r.raw_redp_kg * mbMultiplier).toFixed(isLabMode ? 1 : 2) : '';
            document.getElementById('cp70').value = r.raw_cp70_kg ? (r.raw_cp70_kg * (isLabMode ? 1000 : 1)).toFixed(isLabMode ? 1 : 2) : '';
            
            // ËºâÂÖ•ÂéüÂßãÈÖçÊñπ - Â∞èÊñôÈ°û (ÂÖßÈÉ®ÈÉΩÊòØkgÔºåÂÖ©Á®ÆÊ®°ÂºèÈÉΩÈ°ØÁ§∫g)
            // v7.4: ‰ΩøÁî® toFixed(1) ‰øùÁïôÂ∞èÊï∏ÈªûÈÅøÂÖçÁ≤æÂ∫¶ÊêçÂ§±
            document.getElementById('dcp').value = r.raw_dcp_kg ? (r.raw_dcp_kg * 1000).toFixed(1) : '';
            document.getElementById('zno').value = r.raw_zno_kg ? (r.raw_zno_kg * 1000).toFixed(1) : '';
            document.getElementById('urea').value = r.raw_urea_kg ? (r.raw_urea_kg * 1000).toFixed(1) : '';
            document.getElementById('bht').value = r.raw_bht_kg ? (r.raw_bht_kg * 1000).toFixed(1) : '';
            document.getElementById('powder').value = r.raw_powder_kg ? (r.raw_powder_kg * 1000).toFixed(1) : '';
            
            // ËºâÂÖ•VA%
            document.getElementById('eva16va').value = r.eva16va || 16;
            document.getElementById('eva25va').value = r.eva25va || 25;
            
            // ËºâÂÖ•ÁôºÊ≥°Ë£ΩÁ®ãÂèÉÊï∏
            document.getElementById('temp1').value = r.temp1 !== undefined ? r.temp1 : '';
            document.getElementById('time1').value = r.time1 !== undefined ? r.time1 : '';
            document.getElementById('temp2').value = r.temp2 !== undefined ? r.temp2 : '';
            document.getElementById('time2').value = r.time2 !== undefined ? r.time2 : '';
            
            // v7.5.3: ËºâÂÖ•Ê∑∑Á∑¥ÂèÉÊï∏ (‰øÆÊ≠£ 0 ÂÄºÂà§Êñ∑)
            if (r.isTwoRollMill) {
                document.getElementById('mixerVolume').value = '0';
            } else {
                document.getElementById('mixerVolume').value = r.mixerVolume || (isLabMode ? '1' : '75');
            }
            onMixerChange();
            
            document.getElementById('tailMaterial').value = r.tailMaterial ? (r.tailMaterial * tailMultiplier).toFixed(isLabMode ? 1 : 2) : 0;
            document.getElementById('mixTime').value = r.mixTime !== undefined ? r.mixTime : '';
            if (!r.isTwoRollMill) {
                document.getElementById('rotorSpeed').value = r.rotorSpeed !== undefined ? r.rotorSpeed : '';
            } else {
                document.getElementById('rotorSpeed').value = '';
            }
            document.getElementById('mixInitTemp').value = r.mixInitTemp !== undefined ? r.mixInitTemp : '';
            document.getElementById('dosageTemp').value = r.dosageTemp !== undefined ? r.dosageTemp : '';
            document.getElementById('dischargeTemp').value = r.dischargeTemp !== undefined && r.dischargeTemp !== 0 ? r.dischargeTemp : '';
            
            // ÊªæÂãïÂà∞È†ÅÈù¢È†ÇÈÉ®
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            // Ëá™ÂãïÂü∑Ë°åË®àÁÆó
            setTimeout(() => {
                calculate();
            }, 200);
        }
        
        function exportHistory() {
            if (!isAuthenticated) {
                alert('Please login first!');
                return;
            }
            const currentHistory = getCurrentHistory();
            if (currentHistory.length === 0) {
                alert('No records to export!');
                return;
            }
            
            // CSVÊ®ôÈ†≠ (ÂÆåÊï¥ÈÖçÊñπË≥áË®ä)
            let csv = [
                // Âü∫Êú¨Ë≥áË®ä
                'Date', 'Model', 'Batch', 'Mode',
                // ÂéüÂßãÈÖçÊñπ (kg)
                'EVA16(kg)', 'EVA25(kg)', 'LDPE24(kg)', 'LDPE40(kg)', 'POE(kg)',
                'AC_Total(kg)', 'AC_PE_MB(kg)', 'AC_EVA_MB(kg)',
                'DCP(kg)', 'ZnO(kg)', 'Urea(kg)', 'BHT(kg)',
                'Filler_MB(kg)', 'Color_MB(kg)', 'ATH(kg)', 'BrSb_MB(kg)', 'CP70(kg)', 'Powder(kg)',
                // VA%
                'EVA16_VA%', 'EVA25_VA%', 'Weighted_VA%', 'Effective_VA%',
                // Ë£ΩÁ®ãÂèÉÊï∏
                'Temp1(¬∞C)', 'Time1(min)', 'Temp2(¬∞C)', 'Time2(min)', 'MixTime(min)', 'RotorSpeed(rpm)',
                // phrË®àÁÆóÂÄº
                'AC(phr)', 'DCP(phr)', 'BHT(phr)', 'ZnO(phr)', 'Urea(phr)',
                'EVA16(phr)', 'EVA25(phr)', 'LDPE(phr)', 'POE(phr)',
                'Talc(phr)', 'CaCO3(phr)', 'Powder(phr)',
                'ATH(phr)', 'RedP(phr)', 'Br(phr)', 'Sb(phr)', 'CP70(phr)',
                'InorganicFiller(phr)', 'FlameRetardant(phr)', 'Pigment(phr)',
                // ÊØî‰æã
                'AC/DCP', 'ZnO/AC%', 'Urea/AC%', 'TotalResin(kg)',
                // DCPË©ï‰º∞
                'BaseDCPNeed(phr)', 'EffectiveDCP(phr)', 'DCP_SupplyRatio%', 'CrosslinkIndex',
                'EstExpansion', 'ExpansionFactor', 'ColorMB_Effect',
                // v7.3: ÂãïÊÖãCIÁØÑÂúç
                'CI_Min', 'CI_Max', 'CI_OptimalLow', 'CI_OptimalHigh',
                // È†êÊ∏¨ÁµêÊûú
                'TheoDensity', 'PredDensity', 'PredExpansion',
                'EffectiveAC', 'AC_Decomp%', 'Crosslink%',
                'CrosslinkEff', 'FillerSuppress', 'FR_Suppress',
                // ÂìÅË≥™
                'Quality_Score', 'Warning_Count', 'Warnings'
            ].join(',') + '\n';
            
            currentHistory.forEach(r => {
                const warningCount = (r.warnings && r.warnings.length) || 0;
                const warningText = (r.warnings && r.warnings.length > 0) ? 
                    '"' + r.warnings.join('; ').replace(/"/g, "'") + '"' : '';
                const dcpEval = r.dcpEval || {};
                
                csv += [
                    // Âü∫Êú¨Ë≥áË®ä
                    r.productionDate || '',
                    r.productModel || 'N/A',
                    r.batchId || 'N/A',
                    r.mode || 'production',
                    // ÂéüÂßãÈÖçÊñπ (kg)
                    (r.raw_eva16_kg || 0).toFixed(2),
                    (r.raw_eva25_kg || 0).toFixed(2),
                    (r.raw_ldpe24_kg || 0).toFixed(2),
                    (r.raw_ldpe40_kg || 0).toFixed(2),
                    (r.raw_poe_kg || 0).toFixed(2),
                    (r.raw_ac_kg || 0).toFixed(3),
                    (r.raw_acpe_kg || 0).toFixed(3),
                    (r.raw_aceva_kg || 0).toFixed(3),
                    (r.raw_dcp_kg || 0).toFixed(4),
                    (r.raw_zno_kg || 0).toFixed(4),
                    (r.raw_urea_kg || 0).toFixed(4),
                    (r.raw_bht_kg || 0).toFixed(4),
                    (r.raw_filler_kg || 0).toFixed(2),
                    (r.raw_color_kg || 0).toFixed(2),
                    (r.raw_ath_kg || 0).toFixed(2),
                    (r.raw_brsb_kg || 0).toFixed(2),
                    (r.raw_cp70_kg || 0).toFixed(2),
                    (r.raw_powder_kg || 0).toFixed(3),
                    // VA%
                    (r.eva16va || 16).toFixed(1),
                    (r.eva25va || 25).toFixed(1),
                    (r.weightedVA || 0).toFixed(2),
                    (dcpEval.effectiveVA || 0).toFixed(2),
                    // Ë£ΩÁ®ãÂèÉÊï∏
                    (r.temp1 || 0).toFixed(1),
                    (r.time1 || 0).toFixed(0),
                    (r.temp2 || 0).toFixed(1),
                    (r.time2 || 0).toFixed(0),
                    (r.mixTime || 0).toFixed(0),
                    (r.rotorSpeed || 0).toFixed(0),
                    // phrË®àÁÆóÂÄº
                    (r.ac_phr || 0).toFixed(2),
                    (r.dcp_phr || 0).toFixed(3),
                    (r.bht_phr || 0).toFixed(3),
                    (r.zno_phr || 0).toFixed(3),
                    (r.urea_phr || 0).toFixed(3),
                    (r.eva16_phr || 0).toFixed(2),
                    (r.eva25_phr || 0).toFixed(2),
                    (r.ldpe_phr || 0).toFixed(2),
                    (r.poe_phr || 0).toFixed(2),
                    (r.talc_phr || 0).toFixed(2),
                    (r.caco3_phr || 0).toFixed(2),
                    (r.powder_phr || 0).toFixed(2),
                    (r.ath_phr || 0).toFixed(2),
                    (r.redPhos_phr || 0).toFixed(2),
                    (r.br_phr || 0).toFixed(2),
                    (r.sb_phr || 0).toFixed(2),
                    (r.cp70_phr || 0).toFixed(2),
                    (r.inorganicFiller_phr || 0).toFixed(2),
                    (r.flameRetardant_phr || 0).toFixed(2),
                    (r.pigment_phr || 0).toFixed(2),
                    // ÊØî‰æã
                    (r.acDcpRatio || 0).toFixed(1),
                    (r.znoAcRatio || 0).toFixed(2),
                    (r.ureaAcRatio || 0).toFixed(2),
                    (r.totalResin_kg || 0).toFixed(3),
                    // DCPË©ï‰º∞
                    (dcpEval.baseDCPNeed || 0).toFixed(3),
                    (dcpEval.effectiveDcp || 0).toFixed(3),
                    ((dcpEval.dcpSupplyRatio || 0) * 100).toFixed(1),
                    (dcpEval.crosslinkIndex || 0).toFixed(3),
                    (dcpEval.estimatedExpansion || 0).toFixed(1),
                    (dcpEval.expansionFactor || 1).toFixed(3),
                    (dcpEval.colorMBEffect || 0).toFixed(3),
                    // v7.3: ÂãïÊÖãCIÁØÑÂúç
                    (dcpEval.dynamicCI?.ciMin || 0).toFixed(3),
                    (dcpEval.dynamicCI?.ciMax || 0).toFixed(3),
                    (dcpEval.dynamicCI?.ciOptimalLow || 0).toFixed(3),
                    (dcpEval.dynamicCI?.ciOptimalHigh || 0).toFixed(3),
                    // È†êÊ∏¨ÁµêÊûú
                    (r.theoreticalDensity || 0).toFixed(4),
                    (r.predictedDensity || 0).toFixed(4),
                    (r.predictedExpansion || 0).toFixed(2),
                    (r.effectiveAC || 0).toFixed(2),
                    ((r.totalACDecomposition || 0) * 100).toFixed(1),
                    (r.totalReaction || 0).toFixed(1),
                    (r.crosslinkEff || 0).toFixed(3),
                    (r.fillerSuppression || 1).toFixed(3),
                    (r.frSuppression || 1).toFixed(3),
                    // ÂìÅË≥™
                    r.qualityScore || 'N/A',
                    warningCount,
                    warningText
                ].join(',') + '\n';
            });
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Foam_History_v7.3_Full_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            const modeLabel = currentMode === 'lab' ? '[Lab Mode]' : '[Production Mode]';
            showToast(`Exported ${currentHistory.length} records`);
        }
    </script>
</body>
</html>
